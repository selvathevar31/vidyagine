
<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>VidyaGenie</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* --- DYNAMIC POLL INPUTS --- */
        .poll-input-row {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
        }

        .poll-input-row input {
            flex: 1;
            /* Input takes available space */
            margin-bottom: 0 !important;
            /* Reset default margin */
        }

        .btn-remove-opt {
            background: rgba(255, 69, 58, 0.2);
            color: #ff453a;
            border: 1px solid #ff453a;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            flex-shrink: 0;
        }

        .btn-remove-opt:hover {
            background: #ff453a;
            color: white;
        }

        /* Ensure SVGs inside circles/buttons are centered and match theme */
        .requests-icon-style svg,
        .sort-btn-style svg {
            display: block;
            transition: transform 0.3s ease;
        }

        .sort-btn-style:hover svg {
            transform: rotate(90deg) scale(1.1);
            /* Subtle professional interaction */
        }

        .requests-icon-style:hover svg {
            stroke: var(--text-main);
        }

        /* --- CHAT LAYOUT SYSTEM --- */
        #chatMainWrapper {
            display: flex;
            gap: 20px;
            height: 75vh;
            /* Desktop Height */
        }

        #activeChatsList {
            flex: 0 0 300px;
            /* Fixed width on desktop */
            overflow-y: auto;
            border-right: 1px solid var(--border-color);
        }

        #messageView {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .chat-back-btn {
            display: none;
            /* Hidden on Desktop */
            margin-right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: var(--primary-color);
        }

        /* --- MOBILE CHAT (Immersive Full Screen) --- */
        @media (max-width: 600px) {

            /* 1. Master List (Active Conversations) */
            #chatMainWrapper {
                display: block !important;
                height: calc(100vh - 140px);
                /* Normal height for the list */
            }

            #activeChatsList {
                width: 100% !important;
                height: 100% !important;
                display: block !important;
                border: none;
            }

            /* 2. Detail View (The Chat Room) - HIDDEN BY DEFAULT */
            #messageView {
                display: none !important;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100dvh;
                /* Dynamic Height for mobile browsers */
                background: #000;
                /* Pure black background like IG */
                z-index: 2000;
                /* Sit ON TOP of bottom tabs */
                border: none;
                border-radius: 0;
                flex-direction: column;
            }

            /* 3. WHEN CHAT IS OPEN (The "Instagram" State) */
            #chats.mobile-chat-open #messageView {
                display: flex !important;
            }

            /* Fix Header for Full Screen */
            #chats.mobile-chat-open #chatHeader {
                padding-top: 45px;
                /* Space for Status Bar/Notch */
                background: rgba(20, 20, 20, 0.98);
                /* Slightly darker header */
            }

            /* Fix Message Container Size */
            #chats.mobile-chat-open #messagesContainer {
                flex: 1;
                /* Grow to fill space */
                background: #000;
            }

            /* Fix Input Area at Bottom */
            #chats.mobile-chat-open #sendMessageForm {
                padding-bottom: 20px;
                /* Space for Home Indicator */
                background: #111;
            }

            /* Show Back Button */
            .chat-back-btn {
                display: block !important;
                padding: 10px;
                margin-left: -10px;
                /* Align to edge */
            }
        }

        /* --- OTP INPUT STYLE --- */
        #fpOtpInput {
            font-family: monospace;
            font-size: 24px !important;
            letter-spacing: 8px;
            color: var(--primary-color);
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--primary-color);
        }

        .profile-pic-wrapper-new {
            width: 150px;
            height: 150px;
            margin: 0 auto 25px;
            border-radius: 50%;
            border: 4px solid var(--primary-color);
            background: var(--bg-input);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .profile-pic-large-new {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-initial-large-new {
            font-size: 60px;
            font-weight: bold;
            color: var(--primary-color);
        }


        /* The Preview Box on the Main Feed */
        .top-comment-preview {
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid var(--primary-color);
            padding: 10px 15px;
            margin-top: 10px;
            border-radius: 0 8px 8px 0;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .top-comment-preview:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        /* Thread Container */
        .comment-thread-container {
            position: relative;
            margin-bottom: 15px;
        }

        /* The Visual Thread Line (Reddit Style) */
        .comment-thread-line {
            position: absolute;
            left: 20px;
            /* Aligned with avatar center */
            top: 45px;
            bottom: 0;
            width: 2px;
            background: #333;
            z-index: 0;
        }

        .comment-thread-line:hover {
            background: var(--primary-color);
            /* Highlight path on hover */
        }

        /* Indentation for Child Comments */
        .comment-children {
            margin-left: 35px;
            /* Push children to the right */
            /* border-left: 2px solid #333; Optional extra guide */
            padding-left: 10px;
            display: none;
            /* Hidden by default (Dropdown style) */
        }

        .comment-children.open {
            display: block;
            animation: slideDown 0.2s ease-out;
        }

        /* Reply Input Box */
        .reply-input-container {
            margin-left: 40px;
            margin-top: 10px;
            display: none;
        }

        /* --- POST OPTIONS MENU (3 DOTS) --- */
        .post-options-wrapper {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 5;
        }

        .three-dots-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 20px;
            font-weight: bold;
            transition: background 0.2s;
            user-select: none;
        }

        .three-dots-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .options-menu {
            position: absolute;
            right: 0;
            top: 35px;
            width: 140px;
            background: #2a2a2a;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            display: none;
            /* Hidden by default */
            transform-origin: top right;
        }

        .options-menu.active {
            display: block;
            animation: menuPop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes menuPop {
            from {
                opacity: 0;
                transform: scale(0.8);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .menu-item {
            padding: 12px 16px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .menu-item.danger {
            color: #ff453a;
            /* System Red */
        }

        .menu-item.danger:hover {
            background: rgba(255, 69, 58, 0.15);
        }

        /* --- NEW POST AVATAR STYLE --- */
        .post-avatar-small {
            width: 80px;
            height: 80px;
            min-width: 80px;
            /* Prevent squishing */
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid var(--border-color);
        }

        /* --- PRETTY CHECKBOX (TOGGLE SWITCH) --- */
        .anon-toggle-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
            flex-shrink: 0;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #3a3a3c;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #BF5AF2;
            /* Purple for Incognito */
        }

        input:checked+.slider:before {
            transform: translateX(22px);
        }

        /* --- TOAST NOTIFICATION (Custom Alert) --- */
        /* --- TOAST NOTIFICATION (Custom Alert) --- */
        #customToast {
            visibility: hidden;
            min-width: 250px;
            background-color: #1a1a1c;
            color: #fff;
            text-align: center;
            border-radius: 50px;
            padding: 16px;
            position: fixed;
            z-index: 10005;
            left: 50%;
            /* CHANGE: Move to top */
            top: 30px;
            bottom: auto;
            transform: translateX(-50%);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-color);
            font-size: 14px;
            opacity: 0;
            /* CHANGE: Animate 'top' instead of 'bottom' */
            transition: opacity 0.3s, top 0.3s;
        }

        #customToast.show {
            visibility: visible;
            opacity: 1;
            /* CHANGE: Slide down slightly */
            top: 50px;
        }

        /* --- ANONYMOUS SPECIFIC --- */
        .anon-hidden {
            display: none !important;
        }

        .profile-pic-anon {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: #333;
            color: #888;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
            font-weight: bold;
            border: 4px dashed #666;
            margin: 0 auto 25px;
            box-shadow: none;
        }

        /* --- CONSISTENT SORT BUTTON STYLES --- */
        .sort-btn-style {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 56px;
            width: 56px;
            min-width: 56px;
            border-radius: 28px;
            background-color: #BF5AF2;
            /* Purple */
            color: white;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(191, 90, 242, 0.4);
            border: none;
            overflow: hidden;
            white-space: nowrap;
            transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            padding: 0;
            /* FIX: Force font inheritance from body */
            font-family: inherit;
        }

        .sort-btn-style:hover {
            width: 160px;
            /* Adjusted width for "Sort / Filter" text */
            background-color: white;
            color: #BF5AF2;
            padding-left: 5px;
            padding-right: 20px;
            transform: scale(1.05);
        }

        .sort-btn-text {
            max-width: 0;
            opacity: 0;
            font-size: 15px;
            font-weight: 700;
            /* Bold to match Create Post */
            margin-left: 0;
            transition: all 0.5s ease;
            transform: translateX(20px);
            /* FIX: Ensure text is perfectly centered vertically */
            line-height: 1;
            display: inline-block;
        }

        .sort-btn-style:hover .sort-btn-text {
            max-width: 120px;
            opacity: 1;
            margin-left: 10px;
            transform: translateX(0);
        }

        /* --- ADD THIS NEW BLOCK --- */
        .anon-exit-override:hover {
            width: 260px !important;
            /* Wider to fit "Exit Anonymous mode" */
            background-color: #333 !important;
            /* Dark grey background on hover */
            color: white !important;
            /* Force text to be White */
        }

        /* --- FILTER MODAL PILLS --- */
        .filter-section-title {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin: 15px 0 8px 0;
        }

        .filter-pill {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            background: var(--bg-input);
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            margin: 0 8px 8px 0;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        /* Fix alignment for icons inside existing pills */
        .filter-pill {
            display: inline-flex !important;
            /* Force flex to align icon+text */
            align-items: center;
            justify-content: center;
            gap: 8px;
            /* Space between icon and text */
        }

        /* Standardize icon size */
        .filter-pill svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
            /* Matches text color (white or grey) */
            transition: transform 0.2s;
        }

        /* Subtle pop on hover */
        .filter-pill:hover svg {
            transform: scale(1.1);
        }

        .filter-pill:hover {
            background: #333;
        }

        .filter-pill.active {
            border-color: var(--primary-color);
            background: rgba(10, 132, 255, 0.15);
            color: white;
        }

        /* Z-Index for the Tag Modal to sit above the Post Modal */
        #tagSelectionModal {
            z-index: 10001 !important;
            background: rgba(0, 0, 0, 0.8);
            /* Slightly darker backdrop */
        }

        /* --- TAG SELECTION MENU STYLES --- */
        #tagSelectionModal .modal-content {
            background: #1a1a1c;
            color: white;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
        }

        #tagListArea {
            padding: 10px;
            overflow-y: auto;
        }

        /* Individual Tag Row */
        .tag-menu-item {
            padding: 14px;
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #2a2a2a;
            /* Visible Grey Background */
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .tag-menu-item:hover {
            background: #333;
            transform: translateX(5px);
        }

        /* Selected State */
        .tag-menu-item.selected {
            background: rgba(10, 132, 255, 0.15);
            border-color: var(--primary-color);
        }

        /* The Colored Dot */
        .tag-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 12px;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
        }

        /* Sub-Menu (Accordion Style for Council) */
        .sub-tag-container {
            margin-left: 20px;
            margin-bottom: 10px;
            border-left: 2px solid #444;
            padding-left: 12px;
            animation: slideDown 0.2s ease-out;
        }

        .sub-tag-item {
            padding: 10px;
            cursor: pointer;
            color: #bbb;
            font-size: 14px;
            border-radius: 8px;
            display: flex;
            align-items: center;
        }

        .sub-tag-item:hover {
            color: white;
            background: rgba(255, 255, 255, 0.05);
        }

        .sub-tag-item.selected {
            color: #64b5f6;
            /* Light Blue */
            font-weight: bold;
            background: rgba(10, 132, 255, 0.1);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }



        /* Tag Colors (Easy to Edit) */
        .tag-technical {
            background: #0079D3;
        }

        /* Reddit Blue */
        .tag-academic {
            background: #FF4500;
        }

        /* Reddit Orange */
        .tag-council {
            background: #46D160;
        }

        /* Green */
        .tag-faculty {
            background: #D93A00;
        }

        /* Dark Orange */
        .tag-career {
            background: #7193FF;
        }

        /* Periwinkle */
        .tag-placements {
            background: #FFB000;
        }

        /* Gold */
        .tag-campus {
            background: #0DD3BB;
        }

        /* Teal */
        .tag-sports {
            background: #CC3600;
        }

        /* Rust */
        .tag-review {
            background: #FF585B;
        }

        /* Salmon */
        .tag-general {
            background: #878A8C;
        }

        /* Grey */
        .tag-gossip {
            background: #A335EE;
        }

        /* Purple */
        .requests-icon-style:hover svg {
            stroke: #ff3b30;
            /* Systems red color on hover */
            transform: scale(1.1);
            fill: rgba(255, 59, 48, 0.1);
            /* Subtle light red fill */
        }

        /* Sub-Tag Colors (Specific to Councils) */
        .tag-sub-council {
            background: #24A0ED;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Dropdown Styling */
        .custom-select-wrapper {
            position: relative;
            user-select: none;
            margin-bottom: 10px;
        }

        .custom-select {
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .custom-select-trigger {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-main);
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .custom-select-trigger:hover {
            border-color: var(--text-secondary);
        }

        .custom-options {
            position: absolute;
            display: block;
            top: 100%;
            left: 0;
            right: 0;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background: #1a1a1c;
            /* Darker dropdown bg */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transform: translateY(-10px);
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            overflow: hidden;
            max-height: 250px;
            overflow-y: auto;
        }

        .custom-select.open .custom-options {
            opacity: 1;
            visibility: visible;
            pointer-events: all;
            transform: translateY(10px);
        }

        .custom-option {
            position: relative;
            display: block;
            padding: 10px 16px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .custom-option:hover {
            background: var(--bg-hover);
            color: var(--text-main);
            padding-left: 20px;
            /* Slight nudge effect */
        }

        /* Colored Dots in Dropdown */
        .option-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 10px;
        }

        /* IMPORTANT: Fix Modal Overflow so Dropdown is visible */
        #createPostModal .modal-content {
            overflow: visible !important;
        }

        /* --- CUSTOM CONTEXT MENU (Instagram Style) --- */
        #customContextMenu {
            display: none;
            position: fixed;
            z-index: 10000;
            background: #262626;
            /* Dark Grey */
            border: 1px solid #333;
            border-radius: 12px;
            padding: 6px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            min-width: 150px;
            animation: fadeIn 0.1s ease-out;
        }

        #customContextMenu button {
            width: 100%;
            text-align: left;
            background: transparent;
            border: none;
            color: #ff453a;
            /* Red for Unsend */
            font-weight: 600;
            padding: 10px 12px;
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
        }

        #customContextMenu button:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .delete-msg-btn {
            margin-left: 10px;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.5);
            font-weight: bold;
            font-size: 18px;
            line-height: 1;
            display: inline-block;
            vertical-align: middle;
            transition: color 0.2s;
            padding: 0 4px;
        }

        .delete-msg-btn:hover {
            color: #ff453a;
            /* Red on hover */
            transform: scale(1.2);
        }

        /* --- LIGHTBOX STYLES --- */
        .lightbox {
            display: none;
            /* Hidden by default */
            position: fixed;
            z-index: 9999;
            /* On top of everything */
            padding-top: 0;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            /* Prevent scrolling background */
            background-color: rgba(0, 0, 0, 0.95);
            /* Deep black background */
            justify-content: center;
            align-items: center;
        }

        .lightbox-content {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            transition: transform 0.1s ease-out;
            cursor: default;
            /* Changed from 'grab' to 'default' */
        }

        .lightbox-content:active {
            cursor: move;
            /* Shows move icon only when actually dragging */
        }

        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10000;
        }

        .lightbox-close:hover,
        .lightbox-close:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }

        /* --- NOTIFICATION BADGE --- */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ff3b30;
            /* System Red */
            color: white;
            font-size: 10px;
            font-weight: 800;
            height: 18px;
            min-width: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--bg-card);
            /* Cutout effect against background */
            padding: 0 4px;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from {
                transform: scale(0);
            }

            to {
                transform: scale(1);
            }
        }

        /* --- POLL OPTION STYLES --- */
        .poll-option-btn {
            position: relative;
            width: 100%;
            padding: 16px;
            background: #1C1C1E;
            border: 1px solid #333;
            border-radius: 12px;
            text-align: left;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.2s;
        }

        .poll-option-btn:hover {
            border-color: #FF5722;
            transform: scale(1.02);
        }

        /* The Fill Bar (Background) */
        .poll-fill-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: rgba(255, 87, 34, 0.15);
            /* Light orange tint */
            z-index: 0;
            width: 0%;
            transition: width 0.5s ease-out;
        }

        .poll-text-wrapper {
            position: relative;
            z-index: 1;
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            font-size: 15px;
        }

        /* Voted State */
        .poll-option-btn.voted {
            border-color: #FF5722;
            background: rgba(255, 87, 34, 0.05);
        }

        .poll-option-btn.voted .poll-fill-bar {
            background: linear-gradient(90deg, rgba(255, 87, 34, 0.3), rgba(255, 55, 95, 0.3));
        }

        /* --- THREADED COMMENT PREVIEWS --- */
        .preview-comments-container {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .preview-comment-row {
            display: flex;
            gap: 10px;
            position: relative;
        }

        /* The Thread Line */
        .thread-line-visual {
            width: 2px;
            background: var(--border-color);
            margin-left: 20px;
            /* Align with avatar center usually, or just offset */
            margin-right: 5px;
            border-radius: 2px;
        }

        .preview-comment-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 10px 14px;
            flex: 1;
            font-size: 13px;
            transition: background 0.2s;
        }

        .preview-comment-card:hover {
            background: rgba(255, 255, 255, 0.06);
        }

        .preview-meta {
            display: flex;
            justify-content: space-between;
            color: var(--text-secondary);
            font-size: 11px;
            margin-bottom: 4px;
            font-weight: 600;
        }

        /* --- ENABLE DYNAMIC COLORING --- */
        #searchResultsList .card {
            /* Smooth transition when color is applied */
            transition: background 0.5s ease, color 0.3s ease, transform 0.4s var(--bounce);
            /* Ensure the text sits on top of the colored background */
            position: relative;
            z-index: 1;
            overflow: hidden;
        }

        /* --- AUTH TOGGLE & SCROLLABLE FORM --- */
        .auth-scroll-container {
            max-height: 70vh;
            /* Prevent form from being too tall */
            overflow-y: auto;
            padding-right: 10px;
            /* Space for scrollbar */
        }

        .auth-toggle-text {
            margin-top: 20px;
            font-size: 14px;
            color: var(--text-muted);
        }

        .auth-link {
            color: var(--neon-blue);
            cursor: pointer;
            font-weight: 700;
            text-decoration: underline;
        }

        /* Dynamic Work Experience Rows */
        .exp-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        /* Custom Scrollbar for the form */
        .auth-scroll-container::-webkit-scrollbar {
            width: 4px;
        }

        .auth-scroll-container::-webkit-scrollbar-thumb {
            background: var(--glass-border);
            border-radius: 4px;
        }


        /* --- CHAT SCROLL FIX --- */
        #chats .tab-content {
            height: 75vh;
            /* Fixed height for the whole tab */
            display: flex;
            flex-direction: column;
        }

        .chat-container {
            flex: 1;
            display: flex;
            gap: 20px;
            height: 100%;
            /* Fill the tab height */
            min-height: 0;
            /* Critical for nested flex scrolling */
        }

        #messageView {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            overflow: hidden;
            /* Clip content that tries to leak */
            height: 100%;
            /* Ensure it respects parent height */
        }
        
        

        /* --- CHAT SCROLL & BUBBLE FIX --- */
        /* --- CHAT SCROLL FIX --- */
        #messagesContainer {
            flex: 1;
            overflow-y: auto;
            /* ðŸš¨ FIX: Added extra padding on the right (25px) to prevent overlap with scrollbar */
            padding: 20px 25px 20px 20px;
            display: flex;
            flex-direction: column;
        }

        .msg-bubble {
            padding: 12px 18px;
            border-radius: 18px;
            font-size: 15px;
            max-width: 75%;
            line-height: 1.5;
            position: relative;
            word-wrap: break-word;
            /* Prevents long text from overflowing */
            word-break: break-word;
            /* Force break for long words */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        #sendMessageForm {
            flex-shrink: 0;
            /* Prevent input form from squishing */
            background: rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 10;
        }

        /* --- EMOJI PICKER STYLES --- */
        .emoji-picker {
            position: absolute;
            bottom: 80px;
            /* Sits above the input bar */
            left: 20px;
            width: 300px;
            height: 200px;
            background: rgba(30, 30, 35, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            /* 6 emojis per row */
            gap: 8px;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            z-index: 100;
            animation: slideUp 0.2s ease-out;
        }

        .emoji-btn {
            background: transparent;
            border: none;
            font-size: 24px;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s;
            padding: 5px;
        }

        .emoji-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.2);
        }

        /* 1. The Row Container: Handles Left/Right Alignment */
        .chat-message-row {
            display: flex;
            width: 100%;
            margin-bottom: 8px;
            /* Slightly tighter spacing */
            align-items: flex-end;
            /* Aligns avatar to bottom of message */
        }

        .chat-message-row.me {
            justify-content: flex-end;
        }

        .chat-message-row.them {
            justify-content: flex-start;
        }

        /* The Avatar Circle */
        .chat-msg-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 8px;
            flex-shrink: 0;
            border: 1px solid var(--border-color);
            margin-bottom: 2px;
            /* Align with bottom of bubble text */
        }

        /* The Placeholder (Initials) if no image */
        .chat-msg-placeholder {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #333;
            color: #ccc;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            flex-shrink: 0;
            border: 1px solid var(--border-color);
            margin-bottom: 2px;
        }

        /* Bubbles adjustments */
        .msg-them {
            border-bottom-left-radius: 4px;
            /* Sharp corner near avatar */
        }

        .msg-me {
            border-bottom-right-radius: 4px;
            /* Sharp corner on right */
            max-width: 78% !important;
            /* Slightly wider for me */
        }

        /* --- RESTORED CAMERA & BUTTON STYLES --- */
        .btn-circle {
            width: 45px;
            height: 45px;
            min-width: 45px;
            /* Prevents squishing */
            min-height: 45px;
            border-radius: 50%;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            flex-shrink: 0;
        }

        .chat-upload-btn {
            background: transparent;
            /* Fallback to white border if var doesn't exist */
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ccc;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 20px;
            padding-bottom: 3px;
            /* Visual centering for emoji */
        }

        .chat-upload-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-color: white;
        }

        /* 2. The Bubble: Handles Background, Color, Shape */
        .msg-bubble {
            padding: 12px 18px;
            border-radius: 18px;
            font-size: 15px;
            max-width: 75%;
            /* Don't span full width */
            line-height: 1.5;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* Style for MY messages */
        .msg-me {
            background: var(--gradient-primary);
            /* Neon Gradient */
            color: white;
            border-bottom-right-radius: 4px;
            /* Distinct edge */
        }

        /* Style for THEIR messages */
        .msg-them {
            background: rgba(255, 255, 255, 0.1);
            /* Glassy Grey */
            color: #e2e8f0;
            border-bottom-left-radius: 4px;
            /* Distinct edge */
            border: 1px solid var(--glass-border);
        }

        /* 3. Images inside bubbles */
        .chat-image {
            max-width: 350px;
            /* Increased from 200px */
            width: auto;
            /* Maintains aspect ratio */
            height: auto;
            /* Maintains aspect ratio */

            border-radius: 12px;
            margin-top: 5px;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: block;

            /* Larger minimum size for placeholder */
            min-width: 150px;
            min-height: 150px;
            background-color: rgba(0, 0, 0, 0.3);
        }

        .chat-image:hover {
            opacity: 0.9;
        }

        /* 4. Ensure the container handles scrolling correctly */
        #messagesContainer {
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        /* --- PREMIUM DARK THEME VARIABLES --- */
        :root {
            --bg-body: #000000;
            --bg-card: #1C1C1E;
            --bg-input: #2C2C2E;
            --bg-hover: #3A3A3C;
            --primary-color: #0A84FF;
            --primary-hover: #0071e3;
            --text-main: #FFFFFF;
            --text-secondary: #8E8E93;
            --text-tertiary: #48484A;
            --border-color: #38383A;
            --danger-color: #FF453A;
            --success-color: #30D158;
            --warning-color: #FFD60A;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 18px;
            --radius-full: 9999px;
            --transition-speed: 0.3s;
            --transition-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
            --transition-smooth: cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* --- POLL ICON SPECIFIC --- */
        .daily-poll-style svg {
            width: 20px;
            height: 20px;
            stroke: white;
            /* Ensure icon is white */
            stroke-width: 2.5px;
            /* Slightly bolder matches the font */
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .daily-poll-style:hover svg {
            transform: scale(1.2) translateY(-1px);
            /* Pop effect */
        }

        /* --- DAILY POLL PILL --- */
        .daily-poll-style {
            height: 56px;
            padding: 0 24px;
            border-radius: 28px;
            /* Fully rounded pill */
            background: linear-gradient(135deg, #FF9F0A, #FF375F);
            /* Sunset Gradient */
            color: white;
            font-weight: 700;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(255, 159, 10, 0.3);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .daily-poll-style:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 30px rgba(255, 159, 10, 0.5);
        }

        .daily-poll-style:active {
            transform: scale(0.95);
        }

        /* --- CENTER WRAPPER LAYOUT --- */
        .center-icon-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            /* Increased gap to prevent touching */
            margin: 20px 0 30px;
            padding: 0 5px;
        }

        /* --- DAILY POLL PILL (Fixed & polished) --- */
        .daily-poll-style {
            height: 56px;
            padding: 0 30px;
            /* Fixed comfortable padding */
            border-radius: 28px;
            background: linear-gradient(135deg, #FF9F0A, #FF375F);
            color: white;
            font-weight: 700;
            font-size: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(255, 159, 10, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);

            /* DESKTOP BEHAVIOR: Don't fill space, just fit content */
            flex: 0 0 auto;
            min-width: 450px;
            /* Consistent minimum width */

            position: relative;
            overflow: hidden;
            /* For the shine effect */
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 2;
        }

        /* --- HOVER ANIMATION (Lift + Glow + Shine) --- */
        .daily-poll-style:hover {
            transform: translateY(-3px);
            /* Lifts up instead of growing wide */
            box-shadow: 0 15px 35px rgba(255, 55, 95, 0.5);
            /* Intense glow */
        }

        .daily-poll-style:active {
            transform: scale(0.96);
        }

        /* The "Shine" Sweep Effect */
        .daily-poll-style::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transform: skewX(-20deg);
            transition: 0.5s;
        }

        .daily-poll-style:hover::after {
            left: 150%;
            /* Sweeps across on hover */
            transition: 0.7s ease-in-out;
        }

        /* --- MOBILE OPTIMIZATION --- */
        @media (max-width: 600px) {
            .center-icon-wrapper {
                gap: 10px;
                /* Tighter gap on mobile */
            }

            /* 1. Shrink left buttons to icons */
            .sort-btn-text,
            .create-icon-text {
                display: none !important;
            }

            /* 2. Prevent hover layout shifts on touch */
            .sort-btn-style:hover,
            .create-icon-style:hover {
                width: 56px !important;
                padding: 0 !important;
                transform: none !important;
            }

            /* 3. Let Poll button fill space ON MOBILE ONLY */
            .daily-poll-style {
                flex: 1;
                /* Grows to fill screen */
                min-width: 0;
                font-size: 13px;
                padding: 0 15px;
            }
        }

        /* Adjust the wrapper to push items apart */
        .center-icon-wrapper {
            justify-content: space-between !important;
            padding: 0 5px;
            /* Tiny padding from screen edges */
        }

        /* --- SEARCH ICON SIZING FIX --- */
        .input-with-icon {
            position: relative;
            width: 100%;
        }

        .input-icon {
            position: absolute;
            left: 15px;
            /* Distance from left edge */
            top: 50%;
            transform: translateY(-50%);
            /* Centers it vertically */
            width: 18px !important;
            /* Forces small size */
            height: 18px !important;
            color: var(--text-secondary);
            pointer-events: none;
            /* Clicks go through to the input */
            z-index: 5;
        }

        /* Ensure the input has room for the icon */
        #chatSearchInput {
            padding-left: 45px !important;
        }

        /* --- GLOBAL RESET & TYPOGRAPHY --- */
        :root {
            /* ... keep your existing variables ... */
            --bg-body: #000000;
            /* Ensure this stays black */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            outline: none;
            /* CRITICAL: Smooths fonts on Webkit browsers (Safari/Chrome) */
            -webkit-font-smoothing: antialiased;
            /* CRITICAL: Smooths fonts on Firefox on Mac */
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            /* The "Apple Stack" - Prioritizes SF Pro, then falls back gracefully */
            font-family: -apple-system, BlinkMacSystemFont, "Inter", "SF Pro Text", "Segoe UI", sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            line-height: 1.5;
            overflow-x: hidden;
            /* Subtle spacing adjustments typical of Apple's UI */
            letter-spacing: -0.011em;
        }

        /* Ensure form elements inherit the clean font */
        input,
        textarea,
        select,
        button {
            font-family: inherit;
            letter-spacing: inherit;
        }

        /* Make headings slightly tighter, like SF Pro Display */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        .navbar-brand h1 {
            letter-spacing: -0.022em;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-body);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        /* --- PREMIUM GLASS NAVBAR (macOS Style) --- */
        .navbar {
            /* Positioning */
            position: sticky;
            top: 15px;
            /* Slight float */
            z-index: 1000;

            /* Sizing & Layout */
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 24px;
            /* Tighter padding */
            margin-bottom: 30px;

            /* The "Apple Glass" Effect */
            background: rgba(28, 28, 30, 0.65);
            /* More transparent */
            backdrop-filter: saturate(180%) blur(25px);
            /* The "Vibrancy" Trick */
            -webkit-backdrop-filter: saturate(180%) blur(25px);

            /* Borders & Shadows */
            border-radius: 20px;
            /* Smooth curve */
            border: 1px solid rgba(255, 255, 255, 0.08);
            /* Very subtle border */
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
            /* Soft deep shadow */

            /* Animation */
            transition: all 0.3s ease;
        }

        /* Responsive Fix: On mobile, stick to top fully */
        @media (max-width: 600px) {
            .navbar {
                top: 0;
                margin: 0 0 20px 0;
                border-radius: 0 0 20px 20px;
                border-top: none;
                border-left: none;
                border-right: none;
                background: rgba(20, 20, 20, 0.85);
                /* Darker on mobile */
            }
        }

        /* --- BRAND TEXT --- */
        .navbar-brand {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .navbar-brand h1 {
            font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 25px;
            /* Much smaller, cleaner */
            font-weight: 700;
            letter-spacing: -0.01em;
            margin: 0;
            line-height: 1;

            /* Premium Silver Gradient */
            background: linear-gradient(180deg, #FFFFFF 0%, #B0B0B0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 10px rgba(255, 255, 255, 0.1);
        }

        /* The user greeting text */
        .navbar-brand p {
            font-size: 15px;
            color: rgba(235, 235, 245, 0.5);
            /* Apple Label Color */
            font-weight: 500;
            margin-top: 4px;
            letter-spacing: 0.02em;
            text-transform: uppercase;
        }

        /* --- RIGHT SIDE ICONS (Clean up alignment) --- */
        .navbar-right {
            display: flex;
            align-items: center;
            gap: 12px;
            /* Consistent gap */
        }

        /* Clean up the circle buttons in nav */
        .navbar-right .profile-circle,
        .navbar-right .requests-icon-style {
            width: 38px;
            /* Slightly smaller */
            height: 38px;
            background: rgba(255, 255, 255, 0.05);
            /* Subtle fill */
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
        }

        .navbar-right .profile-circle:hover,
        .navbar-right .requests-icon-style:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: scale(1.05);
            border-color: rgba(255, 255, 255, 0.3);
        }

        /* --- ICONS & AVATARS --- */
        .profile-circle,
        .requests-icon-style {
            width: 44px;
            height: 44px;
            background-color: var(--bg-input);
            color: var(--text-main);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid var(--border-color);
            transition: all var(--transition-speed) var(--transition-bounce);
            font-size: 18px;
        }

        .requests-icon-style {
            margin-right: 0;
            color: var(--primary-color);
        }

        .profile-circle:hover,
        .requests-icon-style:hover {
            transform: scale(1.1);
            background-color: var(--bg-hover);
            border-color: var(--text-secondary);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
        }

        /* --- SCROLLBAR STRATEGY --- */

        /* 1. MOBILE (Default to Native "Invisible" Scrollbar) */
        /* We don't write any rules here. The browser defaults are best for touch. */

        /* 2. DESKTOP ONLY (> 600px) - The Cool Blue Look */
        @media (min-width: 601px) {

            ::-webkit-scrollbar {
                width: 10px;
                height: 10px;
                background-color: #121212;
            }

            ::-webkit-scrollbar-track {
                background: #1c1c1e;
                border-left: 1px solid #333;
            }

            ::-webkit-scrollbar-thumb {
                background-color: var(--primary-color);
                border-radius: 6px;
                border: 2px solid #1c1c1e;
            }

            ::-webkit-scrollbar-thumb:hover {
                background-color: #4da6ff;
            }

            /* Firefox Desktop */
            html {
                scrollbar-width: thin;
                scrollbar-color: var(--primary-color) #1c1c1e;
            }
        }

        /* --- TABS --- */
        /* --- NAVIGATION TABS (Desktop) --- */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            padding: 6px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            justify-content: center;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .tab-button {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .tab-button svg {
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .tab-button:hover {
            color: var(--text-main);
            background: rgba(255, 255, 255, 0.05);
        }

        /* --- MOBILE TAB ACTIVE STATE (CLEAN) --- */
        .tab-button.active {
            color: var(--primary-color) !important;
            /* Only change the color */
            background: transparent !important;
            /* Remove the box */
            box-shadow: none !important;
            /* Remove the shadow */
        }

        /* Ensure the icon specifically stays primary color */
        .tab-button.active svg {
            stroke: var(--primary-color) !important;
            transform: scale(1.1);
            /* Keep the subtle grow effect */
        }

        /* Active Icon Animation */
        .tab-button.active svg {
            transform: scale(1.1);
            stroke-width: 2.5px;
            /* Make it bolder when active */
            stroke: var(--primary-color);
        }

        .tab-label {
            font-size: 14px;
            font-weight: 600;
        }

        /* --- MOBILE BOTTOM NAVIGATION (The "Real App" Feel) --- */
        @media (max-width: 600px) {
            .tabs {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                max-width: 100%;

                margin: 0;
                border-radius: 0;
                border: none;
                border-top: 1px solid var(--border-color);

                background: rgba(28, 28, 30, 0.95);
                /* Glassy dark background */
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);

                padding: 10px 0 25px 0;
                /* Extra padding for iPhone Home Indicator */
                z-index: 1000;
                /* Sit above everything */
                gap: 0;
                justify-content: space-around;
            }

            .tab-button {
                flex-direction: column;
                gap: 0;
                /* Reset gap */
                padding: 10px 0;
                background: transparent !important;
                transition: all 0.3s var(--transition-bounce);
            }

            .tab-label {
                font-size: 10px;
                font-weight: 700;
                max-height: 0;
                opacity: 0;
                overflow: hidden;
                transition: all 0.3s var(--transition-bounce);
                transform: translateY(10px);
            }

            .tab-button.active .tab-label {
                max-height: 20px;
                opacity: 1;
                transform: translateY(4px);
                /* Moves text slightly below icon */
                margin-top: 2px;
            }

            /* Icon size adjustment for mobile */
            .tab-button svg {
                width: 24px;
                height: 24px;
                stroke: var(--text-secondary);
                transition: all 0.3s var(--transition-bounce);
            }

            .tab-button.active svg {
                stroke: var(--primary-color) !important;
                transform: translateY(-2px);
                /* Slight lift effect */
            }

            /* Make sure content doesn't get hidden behind the bar */
            .container {
                padding-bottom: 90px;
            }

            /* Hide the navbar on scroll (Optional: makes it feel cleaner) */
            /* .navbar { position: static; } */
        }

        .tab-button:hover {
            color: var(--text-main);
            background: rgba(255, 255, 255, 0.05);
        }

        .tab-button.active {
            color: var(--text-main);
            background: var(--bg-input);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .tab-content {
            display: none;
            position: relative;
            animation: fadeIn 0.4s var(--transition-smooth);
        }

        .tab-content.active {
            display: block;
        }

        /* --- MOBILE TOUCH FIXES --- */
        * {
            -webkit-tap-highlight-color: transparent;
            /* Removes blue box on touch */
        }

        /* Optional: Improve scroll smoothness on iOS */
        body {
            -webkit-overflow-scrolling: touch;
        }

        /* Ensure buttons don't select text on double tap */
        .btn,
        .tab-button,
        .card,
        .profile-pic-wrapper-new {
            user-select: none;
            -webkit-user-select: none;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- CARDS & LISTS --- */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 20px;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            border-color: #555;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .card-header {
            font-size: 17px;
            font-weight: 700;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-main);
        }

        .card-body p {
            color: var(--text-secondary);
            font-size: 15px;
            margin-bottom: 8px;
        }

        .card-body strong {
            color: var(--text-main);
            font-weight: 600;
        }

        .card-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
        }

        /* --- INPUTS & FORMS --- */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-input);
            border: 1px solid transparent;
            border-radius: var(--radius-md);
            font-size: 15px;
            color: var(--text-main);
            transition: all 0.2s ease;
            font-family: inherit;
        }

        input:focus,
        textarea:focus,
        select:focus {
            border-color: var(--primary-color);
            background: #1a1a1c;
            box-shadow: 0 0 0 4px rgba(10, 132, 255, 0.15);
        }

        input::placeholder,
        textarea::placeholder {
            color: #555;
        }

        #chatSearchInput:focus {
            border-color: var(--primary-color) !important;
            box-shadow: 0 0 0 2px rgba(10, 132, 255, 0.2) !important;
        }

        /* --- BUTTONS --- */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius-full);
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            letter-spacing: 0.3px;
            transition: all 0.2s var(--transition-smooth);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn:active {
            transform: scale(0.96);
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            box-shadow: 0 4px 15px rgba(10, 132, 255, 0.3);
        }

        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text-main);
        }

        .btn-secondary:hover {
            background: #4a4a4c;
        }

        .btn-danger {
            background: rgba(255, 69, 58, 0.15);
            color: var(--danger-color);
        }

        .btn-danger:hover {
            background: rgba(255, 69, 58, 0.25);
        }

        .btn-disabled {
            background: var(--bg-input);
            color: var(--text-tertiary);
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* --- BADGES --- */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-pending {
            background: rgba(255, 214, 10, 0.2);
            color: var(--warning-color);
        }

        .badge-accepted {
            background: rgba(48, 209, 88, 0.2);
            color: var(--success-color);
        }

        .badge-rejected {
            background: rgba(255, 69, 58, 0.2);
            color: var(--danger-color);
        }

        .badge-verified {
            background: rgba(10, 132, 255, 0.2);
            color: var(--primary-color);
        }

        /* --- FLOATING ACTION BUTTON --- */
        .center-icon-wrapper {
            display: flex;
            justify-content: center;
            margin: 20px 0 30px;
        }

        /* UPDATED: Expanding Bubble Button Logic */
        .create-icon-style {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 56px;
            width: 56px;
            /* Start as circle */
            min-width: 56px;
            /* Prevent squishing */
            border-radius: 28px;
            /* Circular ends */
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(10, 132, 255, 0.4);
            border: none;
            overflow: hidden;
            /* Hide text initially */
            white-space: nowrap;
            transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            /* Bouncy expand */
            padding: 0;
        }

        /* Hover State: Expands width and changes color */
        .create-icon-style:hover {
            width: 200px;
            /* Expand width */
            background-color: var(--text-main);
            /* White background */
            color: var(--primary-color);
            /* Blue text/icon */
            padding-left: 5px;
            padding-right: 20px;
            transform: scale(1.05);
            /* Slight grow */
        }

        /* The hidden text */
        .create-icon-text {
            max-width: 0;
            opacity: 0;
            font-size: 15px;
            font-weight: 700;
            margin-left: 0;
            transition: all 0.5s ease;
            transform: translateX(20px);
        }

        /* Show text on hover */
        .create-icon-style:hover .create-icon-text {
            max-width: 150px;
            opacity: 1;
            margin-left: 10px;
            transform: translateX(0);
        }


        /* --- AUTH SCREEN --- */
        .auth-container {
            max-width: 400px;
            margin: 100px auto;
            background: var(--bg-card);
            padding: 40px;
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .auth-container h2 {
            font-size: 28px;
            margin-bottom: 10px;
            color: var(--text-main);
        }

        /* --- MODALS --- */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #151515;
            padding: 30px;
            border-radius: 24px;
            border: 1px solid var(--border-color);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: modalPop 0.3s var(--transition-bounce);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* --- SCROLL LOCK (Prevents background scrolling) --- */
        body.no-scroll {
            overflow: hidden !important;
            height: 100vh;
            /* Locks the height to screen size */
            touch-action: none;
            /* Disables touch scrolling on body */
        }

        @keyframes modalPop {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal-header {
            font-size: 20px;
            color: var(--text-main);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .modal-footer {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .hidden {
            display: none !important;
        }

        /* --- CHAT SPECIFIC --- */
        #activeChatsList {
            background: var(--bg-card) !important;
            border: 1px solid var(--border-color) !important;
            border-radius: var(--radius-lg) !important;
        }

        #activeChatsList h4 {
            color: var(--text-secondary);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom-color: var(--border-color) !important;
        }

        .chat-item {
            background: transparent !important;
            border: none !important;
            border-bottom: 1px solid var(--border-color) !important;
            border-radius: 0 !important;
            margin: 0 !important;
            box-shadow: none !important;
            transition: background 0.2s ease;
        }

        .chat-item:hover {
            background: var(--bg-input) !important;
            transform: none !important;
        }

        #messageView {
            background: var(--bg-card) !important;
            border: 1px solid var(--border-color) !important;
            border-radius: var(--radius-lg) !important;
        }

        #chatHeader {
            border-bottom: 1px solid var(--border-color) !important;
            font-size: 16px;
        }

        #sendMessageForm {
            border-top: 1px solid var(--border-color) !important;
            background: rgba(0, 0, 0, 0.2);
        }

        #profileContent h2 {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .card-body {
            color: var(--text-secondary);
        }

        /* --- POST MEDIA STYLES --- */
        .post-image {
            width: 100%;
            height: auto;
            max-height: 400px;
            object-fit: cover;
            border-radius: 12px;
            margin-top: 15px;
            border: 1px solid var(--border-color);
        }

        .post-link {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
            background: rgba(10, 132, 255, 0.1);
            padding: 8px 12px;
            border-radius: 8px;
            transition: background 0.2s ease;
            font-size: 14px;
            word-break: break-all;
        }

        .post-link:hover {
            background: rgba(10, 132, 255, 0.2);
            text-decoration: underline;
        }

        /* CSS Class */
        .profile-placeholder {
            background-color: #000000;
            /* Reverted to default Black */
            color: #ffffff;
            /* White text/icon */
            border-radius: 50%;
            /* Circular */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- PROFILE PICTURE STYLES --- */
        .profile-pic-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-color);
            margin-bottom: 15px;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .profile-pic-large:hover {
            transform: scale(1.05);
        }

        .profile-initial-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--bg-input);
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            font-weight: bold;
            border: 2px solid var(--primary-color);
            margin: 0 auto 15px auto;
        }

        .navbar-pic {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            display: block;
        }

        .navbar-initial {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-input);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 1px solid var(--border-color);
            color: var(--text-main);
        }

        /* --- EXPLORE TAB: BIG CENTERED IMAGE, LEFT TEXT --- */

        /* 1. Stack content vertically */
        #searchResultsList .card-content-wrapper {
            flex-direction: column !important;
            align-items: center !important;
            gap: 20px;
            margin-bottom: 20px;
            text-align: center;
            /* Centers the image */
        }

        /* 2. Big Centered Profile Picture */
        /* 3. Resize Avatar (Fix Squishing) */
        #searchResultsList .card-avatar {
            width: 70px !important;
            height: 70px !important;

            /* CRITICAL FIXES: */
            min-width: 70px !important;
            /* Stop width shrinking */
            min-height: 70px !important;
            /* Stop height shrinking */
            object-fit: cover !important;
            /* Crop image, don't stretch */
            aspect-ratio: 1 / 1 !important;
            /* Force perfect square */

            border-width: 2px !important;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2) !important;
            border-radius: 50% !important;
            margin: 0 auto !important;
            /* Ensure centering */
        }

        /* 3. Text Container: Force Left Alignment */
        #searchResultsList .card-content-wrapper>div {
            width: 100%;
            text-align: left !important;
            /* Align text to the left */
            padding-left: 10px;
            /* Slight offset from edge */
        }

        /* 4. Adjust Header Text Size */
        #searchResultsList .card-header {
            font-size: 18px;
            margin-bottom: 8px;
            justify-content: flex-start;
            /* Align Name & Badge to left */
            gap: 10px;
        }

        /* 5. Make details text smaller */
        #searchResultsList .card-body p {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        /* --- EXPLORE TAB: CIRCULAR & UNIFORM AVATARS --- */
        #searchResultsList .card-avatar {
            /* 1. Fixed Dimensions (Same Size) */
            width: 120px !important;
            height: 120px !important;
            min-width: 120px !important;
            /* Prevents squishing */
            min-height: 120px !important;

            /* 2. Perfect Circle */
            border-radius: 50% !important;

            /* 3. Image Handling */
            object-fit: cover !important;
            /* Prevents stretching/distortion */
            object-position: center !important;

            /* 4. Styling & Layout */
            border: 4px solid var(--glass-border);
            /* clean border */
            margin: 0 auto;
            /* Center horizontally */
            display: block;
            background-color: var(--bg-input);
            /* Background for transparent PNGs */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        /* ===== NEW PROFILE SECTION STYLES ===== */
        .profile-header-new {
            background: linear-gradient(135deg, rgba(10, 132, 255, 0.15), rgba(48, 209, 88, 0.1));
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 40px;
            margin-bottom: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .profile-header-new::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(10, 132, 255, 0.2), transparent);
            border-radius: 50%;
            pointer-events: none;
        }

        .profile-pic-wrapper-new {
            position: relative;
            width: 150px;
            height: 150px;
            margin: 0 auto 25px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .profile-pic-large-new {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 4px solid var(--primary-color);
            object-fit: cover;
            box-shadow: 0 10px 30px rgba(10, 132, 255, 0.3);
            transition: transform 0.3s;
        }

        .profile-pic-large-new:hover {
            transform: scale(1.05);
        }

        .profile-initial-large-new {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), #30D158);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            font-weight: bold;
            color: white;
            border: 4px solid var(--primary-color);
            box-shadow: 0 10px 30px rgba(10, 132, 255, 0.3);
        }

        .profile-info-new h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-main);
        }

        .profile-badge-new {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .profile-email-new {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 12px;
        }

        .stats-grid-new {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card-new {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }

        .stat-card-new:hover {
            border-color: var(--primary-color);
            box-shadow: 0 8px 24px rgba(10, 132, 255, 0.2);
            transform: translateY(-4px);
        }

        .stat-number-new {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .stat-label-new {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .section-title-new {
            font-size: 18px;
            font-weight: 700;
            margin: 30px 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title-new::before {
            content: '';
            width: 4px;
            height: 24px;
            background: var(--primary-color);
            border-radius: 2px;
        }

        .skills-container-new {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 30px;
        }

        .skill-tag-new {
            background: rgba(10, 132, 255, 0.15);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
        }

        .skill-tag-new:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        .empty-state-new {
            background: var(--bg-card);
            border: 1px dashed var(--border-color);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            color: var(--text-secondary);
        }

        .about-section-new {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .info-row-new {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }

        .info-row-new:last-child {
            border-bottom: none;
        }

        .info-label-new {
            color: var(--text-secondary);
            font-weight: 600;
        }

        .info-value-new {
            color: var(--text-main);
            font-weight: 500;
        }

        .action-buttons-new {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 30px;
        }

        .btn-new {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary-new {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary-new:hover {
            background: #0071e3;
            box-shadow: 0 8px 20px rgba(10, 132, 255, 0.3);
        }

        .btn-secondary-new {
            background: var(--bg-input);
            color: var(--text-main);
            border: 1px solid var(--border-color);
        }

        .btn-secondary-new:hover {
            background: var(--border-color);
        }

        .btn-danger-new {
            background: rgba(255, 69, 58, 0.2);
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
        }

        .btn-danger-new:hover {
            background: var(--danger-color);
            color: white;
        }

        .edit-form-new {
            background: var(--bg-card);
            border: 1px solid var(--primary-color);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .form-group-new {
            margin-bottom: 20px;
        }

        .form-group-new label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group-new input,
        .form-group-new textarea {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-main);
            font-family: inherit;
            font-size: 14px;
        }

        .form-group-new textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group-new input:focus,
        .form-group-new textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.1);
        }

        /* --- DISABLE COMMENT HOVER ANIMATION --- */
        .comment-card {
            transition: none !important;
            /* Stop smooth transition */
        }

        .comment-card:hover {
            transform: none !important;
            /* Stop moving up */
            box-shadow: none !important;
            /* Optional: Stop shadow change */
            /* If you want to keep a static border/shadow, set it here, e.g.: */
            /* border: 1px solid var(--border-color) !important; */
        }

        /* --- MOBILE OPTIMIZATIONS (Bottom Sheet Style) --- */
        @media (max-width: 600px) {

            /* 1. Full Width Containers */
            .container {
                padding: 10px;
                padding-bottom: 90px;
                /* Space for bottom nav */
                max-width: 100%;
            }

            /* 2. Sticky Bottom Navigation */
            .tabs {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                margin: 0;
                border-radius: 0;
                border: none;
                border-top: 1px solid var(--border-color);
                background: rgba(28, 28, 30, 0.95);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                padding: 10px 0 25px 0;
                z-index: 999;
                gap: 0;
                justify-content: space-around;
            }

            .tab-button {
                flex-direction: column;
                gap: 4px;
                padding: 5px;
                border-radius: 0;
                background: transparent !important;
            }

            .tab-label {
                font-size: 10px;
                font-weight: 500;
            }

            .tab-button svg {
                width: 26px;
                height: 26px;
            }

            /* 3. Navbar Tweaks */
            .navbar {
                position: sticky;
                top: 0;
                margin-bottom: 15px;
                padding: 12px 15px;
                border-radius: 0 0 16px 16px;
                z-index: 100;
            }

            .navbar-brand h1 {
                font-size: 24px;
            }

            /* 4. MODALS -> BOTTOM SHEET (The Fix) */
            .modal {
                align-items: flex-end;
                /* Align to bottom */
            }

            .modal-content {
                width: 100% !important;
                max-width: 100% !important;
                border-radius: 24px 24px 0 0 !important;
                /* Round top corners */
                border: none;
                border-top: 1px solid var(--border-color);
                margin: 0 !important;

                /* Limit height so you can click the top backdrop to close */
                max-height: 85vh !important;
                height: auto !important;

                /* Slide Up Animation */
                animation: slideUpModal 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            }

            @keyframes slideUpModal {
                from {
                    transform: translateY(100%);
                }

                to {
                    transform: translateY(0);
                }
            }

            /* Add a visual "Handle" to indicate it's a sheet */
            .modal-content::before {
                content: '';
                display: block;
                width: 40px;
                height: 4px;
                background: #444;
                border-radius: 2px;
                margin: 0 auto 15px auto;
                /* Center top */
            }

            .modal-footer {
                padding-bottom: 30px;
                /* Extra padding for iPhone home bar */
            }

            /* Profile adjustments */
            .profile-header-new {
                padding: 30px 20px;
            }

            .profile-info-new h1 {
                font-size: 24px;
            }

            .stats-grid-new {
                grid-template-columns: repeat(3, 1fr);
            }

            .action-buttons-new {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* --- MOBILE EXPLORE TAB (2 Columns) --- */
        @media (max-width: 600px) {

            /* 1. Force 2-Column Grid */
            #searchResultsList.grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr) !important;
                /* Equal split */
                gap: 10px !important;
                /* Tighter gap */
            }

            /* 2. Shrink Card Padding */
            #searchResultsList .card {
                padding: 12px !important;
                margin-bottom: 0 !important;
                /* Let grid gap handle vertical spacing */
            }

            /* 3. Resize Avatar */
            #searchResultsList .card-avatar {
                width: 70px !important;
                height: 70px !important;
                min-width: 70px !important;
                border-width: 2px !important;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2) !important;
            }

            /* 4. Tighter Layout & Center Text */
            #searchResultsList .card-content-wrapper {
                gap: 8px !important;
                margin-bottom: 10px !important;
            }

            /* Reset text alignment to center for narrow cards */
            #searchResultsList .card-content-wrapper>div {
                padding-left: 0 !important;
                text-align: center !important;
                width: 100%;
            }

            /* 5. Font Adjustments */
            #searchResultsList .card-header {
                font-size: 14px !important;
                /* Smaller Name */
                justify-content: center !important;
                /* Center align */
                flex-direction: column;
                /* Stack Name and Badge */
                gap: 4px;
                line-height: 1.2;
            }

            /* Badge Styling */
            #searchResultsList .badge {
                margin-left: 0 !important;
                font-size: 9px !important;
                padding: 2px 6px;
                align-self: center;
                /* Ensure badge stays centered */
            }

            /* Subtext (College/Role) */
            #searchResultsList .card-body p {
                font-size: 11px !important;
                line-height: 1.3;
                margin-bottom: 2px !important;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                /* Prevent long college names from breaking layout */
            }

            /* 6. Compact Buttons */
            #searchResultsList .card-footer {
                margin-top: 5px !important;
                padding-top: 10px !important;
            }

            #searchResultsList .btn {
                font-size: 12px !important;
                padding: 8px 0 !important;
                /* Taller touch target */
                width: 100%;
            }
        }

        /* --- GLOBAL FORM FIXES --- */

        /* 1. Disable the resize handle on all textareas */
        textarea {
            resize: none !important;
        }

        /* 2. Optional: Ensure inputs don't zoom on iPhone */
        input,
        textarea {
            font-size: 16px !important;
            /* Prevents auto-zoom on focus */
        }

        /* --- FIX MOBILE AVATAR (CORRECTED) --- */
        @media (max-width: 600px) {
            #searchResultsList .card-avatar {
                /* 1. Force Exact Size (Prevents Squishing) */
                width: 70px !important;
                height: 70px !important;
                min-width: 70px !important;
                min-height: 70px !important;

                /* 2. Force Circle Shape */
                border-radius: 50% !important;

                /* 3. Crop Image (Prevents Distortion) */
                object-fit: cover !important;
                aspect-ratio: 1 / 1 !important;

                /* 4. Alignment & Border */
                margin: 0 auto 10px auto !important;
                border: 2px solid rgba(255, 255, 255, 0.1) !important;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2) !important;
                display: block !important;
                background-color: var(--bg-input);
                /* Fallback background */
            }
        }

        /* --- VOTED STATE (DULL / COOLED DOWN) --- */
        .daily-poll-style.voted {
            /* Override the fire gradient with dark ash grey */
            background: #2C2C2E !important;

            /* Kill all animations */
            animation: none !important;

            /* Remove the glow and shine */
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5) !important;
            border-color: rgba(255, 255, 255, 0.1) !important;
            color: #888 !important;
            /* Dim the text */

            /* Reset cursor interaction */
            transform: none !important;
            cursor: pointer;
            /* Still clickable to view results */
        }

        /* Remove the shine sweep effect */
        .daily-poll-style.voted::after {
            display: none !important;
        }

        /* Prevent hover effects on voted button */
        .daily-poll-style.voted:hover {
            transform: none !important;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5) !important;
        }

        /* Dim the icon too */
        .daily-poll-style.voted svg {
            stroke: #666 !important;
            filter: none !important;
        }

        /* --- GOAT BADGE (PREMIUM REWARD) --- */
        .goat-badge-container {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #FFD700, #FDB931, #ffd700);
            /* Gold Gradient */
            background-size: 200% auto;
            color: #000;
            font-weight: 800;
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
            animation: goldShine 3s linear infinite;
            margin-bottom: 8px;
            border: 1px solid #fff;
        }

        /* The Shining Animation */
        @keyframes goldShine {
            to {
                background-position: 200% center;
            }
        }

        /* Sparkle/Pulse Effect on the Icon */
        .goat-icon-svg {
            width: 14px;
            height: 14px;
            animation: goatPulse 2s ease-in-out infinite alternate;
        }

        @keyframes goatPulse {
            0% {
                transform: scale(1);
                filter: drop-shadow(0 0 0 rgba(255, 255, 255, 0));
            }

            100% {
                transform: scale(1.15);
                filter: drop-shadow(0 0 2px white);
            }
        }

        /* Highlight the whole comment card */
        .comment-card.is-goated {
            border: 1px solid #FFD700 !important;
            background: linear-gradient(to bottom, rgba(255, 215, 0, 0.05), transparent) !important;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.15) !important;
            order: -1;
            /* FLEX TRICK: Forces it to the top automatically */
        }
    </style>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
        (function () {
            // REPLACE 'YOUR_PUBLIC_KEY' WITH THE KEY FROM STEP 1
            emailjs.init("1RBlJ5dSeKAbJAqed");
        })();
    </script>
</head>

<body>

    <div id="authScreen" class="auth-container"
        style="max-width: 900px; margin: 60px auto; padding: 40px; background: var(--bg-card); border-radius: 24px; border: 1px solid var(--border-color);">
        <h2
            style="margin-bottom: 20px; font-size: 32px; background: var(--primary-color);background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; text-align: center;">
            VidyaGenie Portal</h2>

        <div style="display: flex; gap: 40px; align-items: flex-start; text-align: left;">

            <div style="flex: 1.2;">

                <div id="loginSection">
                    <h3 style="margin-bottom: 15px; color: var(--text-main); font-size: 20px;">Login</h3>
                    <form onsubmit="handleLogin(event)">
                        <div class="form-group">
                            <label>College Email</label>
                            <input type="email" id="loginEmail" placeholder="Enter email..." value="">
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="loginPassword" value="">
                        </div>

                        <div class="anon-toggle-wrapper">
                            <label class="switch">
                                <input type="checkbox" id="loginAnon">
                                <span class="slider"></span>
                            </label>
                            <div>
                                <span style="font-weight: 700; color: white;">Login as an Anonymous user</span>
                                <div style="font-size: 11px; color: var(--text-secondary);">Mask identity, read & post
                                    only.</div>
                            </div>
                        </div>
                        <div style="text-align: right; margin-bottom: 15px;">
                            <span style="color: var(--primary-color); font-size: 15px; cursor: pointer;"
                                onclick="openForgotModal()">Forgot Password?</span>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px;">Login</button>
                    </form>
                    <p class="auth-toggle-text">
                        Don't have an account? <span class="auth-link"
                            onclick="toggleAuthMode('register')">Register</span>
                    </p>
                </div>

                <div id="registerSection" class="hidden">
                    <h3 style="margin-bottom: 15px; color: var(--text-main); font-size: 20px;">Create Account</h3>
                    <div class="auth-scroll-container">
                        <form onsubmit="handleRegister(event)">
                            <div class="anon-toggle-wrapper">
                                <label class="switch">
                                    <input type="checkbox" id="regAnon">
                                    <span class="slider"></span>
                                </label>
                                <div>
                                    <span style="font-weight: 700; color: white;">Register as Anonymous user</span>
                                    <div style="font-size: 11px; color: var(--text-secondary);">We see your data, but
                                        the public won't.</div>
                                </div>
                            </div>

                            <div class="form-group"><label>Full Name</label><input type="text" id="regName" required>
                            </div>
                            <div class="form-group"><label>College Email</label><input type="email" id="regEmail"
                                    required></div>
                            <div class="form-group"><label>Password</label><input type="password" id="regPass" required>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group"><label>Age</label><input type="number" id="regAge" required
                                        min="16" max="99"></div>
                                <div class="form-group"><label>Gender</label><select id="regGender" required
                                        style="width: 100%; padding: 14px; background: var(--bg-input); border: 1px solid var(--border-color); color: white; border-radius: 12px;">
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                    </select></div>
                            </div>
                            <div class="form-group">
                                <label>Current Year</label>
                                <select id="regYear" required
                                    style="width: 100%; padding: 14px; background: var(--bg-input); border: 1px solid var(--border-color); color: white; border-radius: 12px;">
                                    <option value="" disabled selected>Select Year</option>
                                    <option value="FE">First Year (FE)</option>
                                    <option value="SE">Second Year (SE)</option>
                                    <option value="TE">Third Year (TE)</option>
                                    <option value="BE">Fourth Year (BE)</option>
                                </select>
                            </div>
                            <div class="form-group"><label>College / University</label><input type="text"
                                    id="regCollege" required></div>

                            <div class="form-group">
                                <label>Profile Picture (Optional)</label>
                                <input type="file" id="regFile" accept="image/*" style="display:none;"
                                    onchange="document.getElementById('regFileName').innerText = this.files[0].name">
                                <button type="button" class="btn btn-secondary"
                                    onclick="document.getElementById('regFile').click()" style="width:100%">Upload
                                    Photo</button>
                                <small id="regFileName" style="color:var(--text-secondary);">No file chosen</small>
                            </div>

                            <div class="form-group">
                                <label>Work Experience</label>
                                <div id="workExpContainer"></div>
                                <button type="button" class="btn btn-secondary" onclick="addExperienceField()"
                                    style="font-size: 12px; margin-top: 5px;">+ Add Experience</button>
                            </div>
                            <button type="submit" class="btn btn-primary"
                                style="width: 100%; padding: 12px; margin-top: 20px;">Register</button>
                        </form>
                    </div>
                    <p class="auth-toggle-text">Already have an account? <span class="auth-link"
                            onclick="toggleAuthMode('login')">Login</span></p>
                </div>

            </div>
            <div style="width: 1px; background: var(--border-color); align-self: stretch;"></div>
            <div style="flex: 0.8; display: flex; flex-direction: column;">
                <h3 style="margin-bottom: 15px; color: var(--text-main);">Dev Switcher</h3>
                <p style="font-size:12px; color:var(--text-muted); margin-bottom:10px;">Select any registered account to
                    login instantly:</p>
                <div id="devUserList"
                    style="display: flex; flex-direction: column; gap: 10px; max-height: 400px; overflow-y: auto; padding-right: 5px;">
                    <p style="color: #666; font-size: 13px;">Loading accounts...</p>
                </div>
                <button class="btn btn-secondary" onclick="loadDevUsers()"
                    style="margin-top: 15px; font-size: 12px; width: 100%;">â†» Refresh List</button>
                <button class="btn btn-danger" onclick="adminWipeDB()"
                    style="margin-top: 10px; font-size: 12px; width: 100%; border: 1px solid #ff453a; background: rgba(255, 69, 58, 0.1);">
                    Factory Reset (Delete All Data)
                </button>
                <button class="btn btn-secondary" onclick="openAdminPanel()"
                    style="margin-top: 10px; font-size: 12px; width: 100%; border: 1px solid #ff453a; color: #ff453a;">
                    ðŸ‘®â€â™‚ï¸ Open Admin Dashboard
                </button>
            </div>
        </div>
    </div>

    <div id="appScreen" class="hidden">
        <div class="container">
            <div class="navbar">
                <div class="navbar-brand">
                    <h1>VidyaGenie</h1>
                    <p id="userInfo"></p>
                </div>
                <div class="navbar-right">
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <div class="requests-icon-style" onclick="openConnectionsModal()" title="My Connections">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                        </div>
                        <div class="requests-icon-style" onclick="switchTab('requests')" title="Pending Requests"
                            style="position: relative;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path
                                    d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l8.84-8.84 1.06-1.06a5.5 5.5 0 0 0 0-7.78z">
                                </path>
                            </svg>
                            <span id="requestBadge" class="notification-badge hidden">0</span>
                        </div>
                        <div id="navProfileContainer" class="profile-circle" onclick="switchTab('profile')"
                            title="My Profile"></div>
                    </div>
                </div>
            </div>

            <div class="tabs">
                <button class="tab-button" onclick="switchTab(event, 'chats')">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path
                            d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z">
                        </path>
                    </svg>
                    <span class="tab-label">Messages</span>
                </button>

                <button class="tab-button" onclick="switchTab(event, 'community')">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <span class="tab-label">Community</span>
                </button>

                <button class="tab-button" onclick="switchTab(event, 'mentors')">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <span class="tab-label">Explore</span>
                </button>
            </div>

            <div id="mentors" class="tab-content">
                <div class="card" style="margin-bottom: 30px; border: 1px solid var(--border-color);">
                    <div class="card-header" style="color: var(--text-main);">Search Users</div>
                    <div class="card-body">
                        <form id="userSearchForm" onsubmit="handleUserSearch(event)">
                            <div class="form-group" style="display: flex; gap: 10px; margin-bottom: 0;">
                                <input type="text" id="searchInput" placeholder="Search by Name" style="flex-grow: 1;"
                                    oninput="handleUserSearch(event)">
                                <button type="submit" class="btn btn-primary">Search</button>
                            </div>
                        </form>
                    </div>
                </div>
                <div id="searchResultsList" class="grid"></div>
            </div>

            <div id="requests" class="tab-content">
                <div id="requestsList"></div>
            </div>

            <div id="chats" class="tab-content">
                <div id="chatMainWrapper">

                    <div id="activeChatsList">
                        <h4 style="padding: 20px 20px 10px 20px; border-bottom: 1px solid var(--border-color);">
                            Active Conversations
                        </h4>

                        <div class="search-bar-container" style="padding: 10px 15px 15px 15px;">
                            <div class="input-with-icon">
                                <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg>

                                <input type="text" id="chatSearchInput" class="form-control"
                                    placeholder="Start a chat with..." oninput="filterChatConnections(event)"
                                    autocomplete="off" style="padding-left: 45px;">
                            </div>
                        </div>

                        <div id="chatsListContent"></div>
                    </div>

                    <div id="messageView">
                        <input type="file" id="chatFileInput" accept="image/*,video/*" style="display: none;"
                            onchange="handleChatFileSelect(this)">

                        <div id="chatHeader"
                            style="padding: 15px 20px; font-weight: 800; font-size: 18px; border-bottom: 1px solid var(--glass-border); background: rgba(0,0,0,0.2); display: flex; align-items: center;">
                            <span class="chat-back-btn" onclick="closeChatView()">â†</span>

                            <div id="chatHeaderInfo">Select a conversation</div>
                        </div>

                        <div id="messagesContainer"></div>

                        <form id="sendMessageForm" onsubmit="handleSendMessage(event)" class="hidden"
                            style="position: relative; padding: 15px; border-top: 1px solid var(--glass-border); display: flex; gap: 10px; background: rgba(0,0,0,0.2); align-items: center;">

                            <input type="hidden" id="selectedChatId">
                            <div id="emojiPicker" class="emoji-picker hidden"></div>

                            <button type="button" class="chat-upload-btn btn-circle"
                                onclick="document.getElementById('chatFileInput').click()"
                                title="Send Media">ðŸ“·</button>
                            <button type="button" class="chat-upload-btn btn-circle" onclick="toggleEmojiPicker()"
                                title="Emoji">ðŸ˜€</button>

                            <textarea id="messageText" placeholder="Type a message..." required
                                style="flex-grow: 1; height: 45px; border-radius: 22px; padding: 12px 20px; resize: none; background: rgba(255,255,255,0.05); border:none; color: white; font-family: inherit; overflow: hidden; resize: none !important;"
                                autocomplete="off"></textarea>

                            <button type="submit" class="btn btn-primary btn-circle" style="font-size: 18px;">âž¤</button>
                        </form>
                    </div>
                </div>
            </div>

            <div id="community" class="tab-content">

                <div class="center-icon-wrapper">

                    <div style="display: flex; gap: 12px; align-items: center; flex-shrink: 0;">

                        <div class="sort-btn-style" onclick="openSortModal()">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="4" y1="21" x2="4" y2="14"></line>
                                <line x1="4" y1="10" x2="4" y2="3"></line>
                                <line x1="12" y1="21" x2="12" y2="12"></line>
                                <line x1="12" y1="8" x2="12" y2="3"></line>
                                <line x1="20" y1="21" x2="20" y2="16"></line>
                                <line x1="20" y1="12" x2="20" y2="3"></line>
                                <line x1="2" y1="14" x2="6" y2="14"></line>
                                <line x1="10" y1="8" x2="14" y2="8"></line>
                                <line x1="18" y1="16" x2="22" y2="16"></line>
                            </svg>
                            <span class="sort-btn-text">Sort</span>
                        </div>

                        <div id="createPostIcon" class="create-icon-style" onclick="openCreatePostModal()">
                            <span style="font-size: 32px; line-height: 1; margin-bottom: 3px;">+</span>
                            <span class="create-icon-text">Post</span>
                        </div>
                    </div>

                    <div class="daily-poll-style" onclick="openDailyPoll()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round"
                            stroke-linejoin="round">
                            <line x1="18" y1="20" x2="18" y2="10"></line>
                            <line x1="12" y1="20" x2="12" y2="4"></line>
                            <line x1="6" y1="20" x2="6" y2="14"></line>
                        </svg>
                        <span>Daily Poll</span>
                    </div>

                </div>

                <div id="communityPostsList" style="margin-top: 20px; padding: 0 5px;"></div>
            </div>

            <div id="sortFilterModal" class="modal" style="z-index: 10002;">
                <div class="modal-content"
                    style="max-width: 400px; max-height: 85vh; display: flex; flex-direction: column;">
                    <div class="modal-header">Sort & Filter Community</div>

                    <div style="flex: 1; overflow-y: auto; padding-right: 5px;">

                        <div class="filter-section-title">Sort By</div>
                        <div style="display: flex; gap: 10px;">

                            <div class="filter-pill active" id="sortBtn_latest" onclick="toggleSort('latest')">
                                <svg viewBox="0 0 24 24">
                                    <path
                                        d="M12,2A10,10,0,1,0,22,12,10,10,0,0,0,12,2Zm0,18a8,8,0,1,1,8-8A8,8,0,0,1,12,20ZM12.5,7V12.25L17,14.92l-.75,1.23-5-3V7Z" />
                                </svg>
                                <span>Latest</span>
                            </div>

                            <div class="filter-pill" id="sortBtn_upvotes" onclick="toggleSort('upvotes')">
                                <svg viewBox="0 0 24 24">
                                    <path
                                        d="M19.48,13A7.65,7.65,0,0,0,18.9,9.39c-1.39-3-4.22-4.57-4.22-4.57s.3,2.78-1.42,4.5a3.63,3.63,0,0,1-2.61,1.11c-2.66,0-3.37-3.88-3.37-3.88S4.57,8.81,4.57,12.7a7.43,7.43,0,0,0,14.91.3ZM12,22a9.7,9.7,0,0,1-8.32-5.32A9.63,9.63,0,0,1,2.23,12C2.23,6.33,7.31,2,7.31,2S7.23,4.42,9.33,6.53a5.53,5.53,0,0,0,4,1.7,3.12,3.12,0,0,0,.78-.1,12.72,12.72,0,0,0,3.3-2.52s4.42,3.31,4.42,7.55A8.77,8.77,0,0,1,12,22Z" />
                                </svg>
                                <span>Top Voted</span>
                            </div>

                        </div>

                        <div class="filter-section-title">Filter by Year</div>
                        <div style="display: flex; flex-wrap: wrap;">
                            <div class="filter-pill" id="yearBtn_FE" onclick="toggleFilter('year', 'FE')">FE</div>
                            <div class="filter-pill" id="yearBtn_SE" onclick="toggleFilter('year', 'SE')">SE</div>
                            <div class="filter-pill" id="yearBtn_TE" onclick="toggleFilter('year', 'TE')">TE</div>
                            <div class="filter-pill" id="yearBtn_BE" onclick="toggleFilter('year', 'BE')">BE</div>
                        </div>

                        <div class="filter-section-title">Filter by Tags</div>
                        <div id="filterTagsContainer" style="display: flex; flex-wrap: wrap;">
                        </div>
                    </div>

                    <div class="modal-footer" style="margin-top:15px; border-top:1px solid #333; padding-top:15px;">
                        <button class="btn btn-secondary" onclick="clearAllFilters()">Clear All</button>
                        <button class="btn btn-primary" onclick="applyFilters()">Apply Results</button>
                    </div>
                </div>
            </div>
            <div id="profile" class="tab-content">
                <div style="max-width: 1000px; margin: 0 auto; padding: 20px;">

                    <!-- PROFILE HEADER -->
                    <div class="profile-header-new">
                        <div class="profile-pic-wrapper-new">
                            <div id="profilePicContainer"></div>
                        </div>
                        <div class="profile-info-new">
                            <h1 id="profileName">Loading...</h1>
                            <span id="profileBadge" class="profile-badge-new">Student</span>
                            <p class="profile-email-new" id="profileEmail">email@example.com</p>
                        </div>
                    </div>

                    <!-- STATS SECTION -->
                    <div class="stats-grid-new">
                        <div class="stat-card-new">
                            <div class="stat-number-new" id="statConnections">0</div>
                            <div class="stat-label-new">Connections</div>
                        </div>
                        <div class="stat-card-new">
                            <div class="stat-number-new" id="statPosts">0</div>
                            <div class="stat-label-new">Posts</div>
                        </div>
                        <div class="stat-card-new">
                            <div class="stat-number-new" id="statMentors">0</div>
                            <div class="stat-label-new">Mentors</div>
                        </div>
                    </div>

                    <!-- SKILLS SECTION -->
                    <div>
                        <h2 class="section-title-new">ðŸ’¡ Skills & Expertise</h2>
                        <div id="skillsContainer" class="skills-container-new">
                            <div class="empty-state-new">No skills added yet. Click Edit Profile to add your expertise.
                            </div>
                        </div>
                    </div>

                    <!-- ABOUT SECTION -->
                    <div class="about-section-new">
                        <h2 class="section-title-new">ðŸ“‹ Profile Information</h2>
                        <div class="info-row-new">
                            <span class="info-label-new">College</span>
                            <span class="info-value-new" id="infoCollege">Not specified</span>
                        </div>
                        <div class="info-row-new">
                            <span class="info-label-new">Current Year</span>
                            <span class="info-value-new" id="infoYear">Not specified</span>
                        </div>
                        <div class="info-row-new">
                            <span class="info-label-new">Role</span>
                            <span class="info-value-new" id="infoRole">Not specified</span>
                        </div>
                        <div class="info-row-new">
                            <span class="info-label-new">Member Since</span>
                            <span class="info-value-new" id="infoJoined">Recently</span>
                        </div>
                    </div>

                    <!-- ACTION BUTTONS -->
                    <div class="action-buttons-new">
                        <button class="btn-new btn-primary-new" onclick="toggleEditMode()">Edit Profile</button>
                        <button class="btn-new btn-secondary-new" onclick="shareProfile()">Share Profile</button>
                        <button class="btn-new btn-danger-new" onclick="deleteAccount()">Delete Account</button>
                    </div>

                    <!-- EDIT MODE FORM (Hidden by default) -->
                    <div id="editForm" class="edit-form-new" style="display: none;">

                        <h2 style="margin-bottom: 25px; font-size: 20px;">Edit Your Profile</h2>

                        <div
                            style="margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
                            <label style="margin-bottom: 10px;">Profile Picture</label>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()"
                                    style="font-size: 13px;">
                                    Change Photo
                                </button>
                                <button class="btn btn-danger" onclick="removeProfilePic()"
                                    style="font-size: 13px; background: rgba(255,69,58,0.1); border: 1px solid #ff453a;">
                                    Remove
                                </button>
                            </div>
                            <input type="file" id="fileInput" accept="image/*" style="display: none;"
                                onchange="uploadProfilePic()">
                        </div>
                        <div class="form-group-new">
                            <label>Full Name</label>
                            <input type="text" id="editName" placeholder="Your name...">
                        </div>

                        <div class="form-group-new">
                            <label>College / University</label>
                            <input type="text" id="editCollege" placeholder="Your college...">
                        </div>

                        <div class="form-group-new">
                            <label>Current Year</label>
                            <select id="editYear"
                                style="width: 100%; padding: 12px; background: var(--bg-input); border: 1px solid var(--border-color); color: var(--text-main); border-radius: 12px;">
                                <option value="FE">First Year (FE)</option>
                                <option value="SE">Second Year (SE)</option>
                                <option value="TE">Third Year (TE)</option>
                                <option value="BE">Fourth Year (BE)</option>
                            </select>
                        </div>

                        <div class="form-group-new">
                            <label>Skills & Expertise (comma-separated)</label>
                            <textarea id="editSkills"
                                placeholder="e.g., Python, React, UI Design, Data Science"></textarea>
                        </div>

                        <div style="display: flex; gap: 12px; margin-top: 30px;">
                            <button class="btn-new btn-primary-new" onclick="saveProfile()">Save Changes</button>
                            <button class="btn-new btn-secondary-new" onclick="toggleEditMode()">Cancel</button>
                        </div>
                    </div>

                    <!-- LOGOUT SECTION -->
                    <div
                        style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color); display: flex; gap: 12px; justify-content: center;">
                        <button class="btn-new btn-secondary-new" onclick="window.location.reload()">Log Out</button>
                    </div>
                </div>
            </div>

        </div>
    </div>
    </div>

    <div id="connectionsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">My Connections</div>
            <div id="connectionsModalList" style="max-height: 50vh; overflow-y: auto; padding-right: 5px;"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('connectionsModal')">
                </button>
            </div>
        </div>
    </div>
    <div id="dailyPollModal" class="modal" style="z-index: 10050;">
        <div class="modal-content"
            style="max-width: 400px; text-align: center; border: 2px solid #FF5722; box-shadow: 0 0 50px rgba(255, 87, 34, 0.2);">

            <div style="margin-bottom: 20px;">
                <span style="font-size: 40px; display: block; animation: flameFlicker 1s infinite alternate;">ðŸ”¥</span>
                <h2
                    style="font-size: 24px; font-weight: 800; background: linear-gradient(to right, #FF9F0A, #FF375F); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-top: 10px;">
                    DAILY POLL
                </h2>
            </div>

            <div id="pollViewMode">
                <h3 id="pollQuestionDisplay"
                    style="font-size: 20px; font-weight: 700; color: white; margin-bottom: 25px; line-height: 1.4;">
                    Loading today's question...
                </h3>

                <div id="pollOptionsContainer" style="display: flex; flex-direction: column; gap: 12px;">
                </div>

                <p id="pollTotalVotes" style="margin-top: 20px; font-size: 12px; color: #666;">0 Votes</p>

                <button id="btnEditPoll" class="btn" onclick="togglePollEditMode()"
                    style="display: none; margin: 20px auto 0; background: #333; font-size: 12px; padding: 5px 15px;">
                    âœï¸ Edit Poll (Admin)
                </button>
            </div>

            <div id="pollEditMode" class="hidden">
                <h4 style="color: #FF5722; margin-bottom: 15px;">Create New Poll</h4>

                <div class="form-group">
                    <input type="text" id="newPollQuestion" placeholder="Enter Question..."
                        style="text-align: center; font-weight: bold; font-size: 16px;">
                </div>

                <div id="pollOptionsList" class="form-group">
                </div>

                <button class="btn btn-secondary" onclick="addPollOptionField()"
                    style="width: 100%; margin-bottom: 15px; border: 1px dashed #555;">
                    + Add Another Option
                </button>

                <div
                    style="display: flex; gap: 10px; justify-content: center; margin-top: 15px; border-top: 1px solid #333; padding-top: 15px;">
                    <button class="btn btn-secondary" onclick="togglePollEditMode()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveNewPoll()">Publish Poll</button>
                </div>
            </div>

            <div style="margin-top: 25px;">
                <button class="btn btn-secondary" style="border: none; background: transparent; color: #888;"
                    onclick="closeModal('dailyPollModal')">Close</button>
            </div>
        </div>
    </div>

    <div id="createPostModal" class="modal">
        <input type="file" id="postFileInput" accept="image/*,video/*" style="display: none;"
            onchange="handlePostFileSelect()">

        <div class="modal-content" style="max-width: 500px; width: 90%; overflow: visible;">
            <div class="modal-header">Create Discussion Post</div>

            <form onsubmit="handleCreatePostSubmit(event)">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="communityPostTitle" required placeholder="What's on your mind?"
                        autocomplete="off">
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label>Tags (Max 2)</label>
                    <div id="selectedTagsContainer" class="tag-container" style="min-height:30px;"></div>
                    <button type="button" class="btn btn-secondary" onclick="openTagMenu()"
                        style="width: 100%; text-align: left; display:flex; justify-content:space-between; align-items:center;">
                        <span>âž• Add Tags</span>
                        <span style="opacity:0.5;">â€º</span>
                    </button>
                </div>

                <div class="form-group">
                    <label>Details</label>
                    <textarea id="communityPostBody" required placeholder="Share your thoughts..."
                        style="min-height: 100px; resize: none;" autocomplete="off"></textarea>
                </div>

                <div class="form-group" style="margin-bottom:0;">
                    <label>Image (Optional)</label>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <button type="button" class="btn btn-secondary"
                            style="width:auto; font-size:12px; padding: 8px 12px;"
                            onclick="document.getElementById('postFileInput').click()">ðŸ“· Choose</button>
                        <small id="postFileName"
                            style="color:var(--text-secondary); font-size:11px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 80px;">No
                            file</small>
                        <button type="button" id="removePostImgBtn" class="btn btn-danger"
                            style="display:none; padding: 2px 6px; font-size: 10px; border-radius: 4px;"
                            onclick="removePostImage()">âœ•</button>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('createPostModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submitPostBtn">Post</button>
                </div>
            </form>
        </div>
    </div>

    <div id="tagSelectionModal" class="modal" style="z-index: 10001;">
        <div class="modal-content"
            style="max-width: 400px; height: 80vh; display: flex; flex-direction: column; padding: 20px;">
            <div class="modal-header" style="flex-shrink: 0;">Select Tags</div>

            <div style="padding-bottom: 15px; flex-shrink: 0;">
                <input type="text" id="tagSearchInput" placeholder="Search tags..." onkeyup="filterTags()"
                    style="width:100%; padding:12px; border-radius:10px; border:1px solid var(--border-color); background:#2a2a2a; color:white; outline:none;">
            </div>

            <div id="tagListArea" style="flex: 1; overflow-y: auto; padding-right: 5px;">
            </div>

            <div class="modal-footer"
                style="margin-top: 15px; border-top: 1px solid #333; padding-top: 15px; flex-shrink: 0;">
                <button type="button" class="btn btn-primary" style="width: 100%;"
                    onclick="closeTagMenu()">Done</button>
            </div>
        </div>
    </div>
    <div id="postDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="postDetailTitle">Post Title</div>
            <div id="postDetailBody"
                style="margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); color: var(--text-secondary); font-size: 16px; line-height: 1.6;">
            </div>
            <h4
                style="margin-bottom: 15px; color: var(--text-main); font-size: 14px; text-transform: uppercase; letter-spacing: 1px;">
                Discussion</h4>
            <div id="commentsList"
                style="max-height: 350px; overflow-y: auto; margin-bottom: 20px; padding-right: 5px;"></div>
            <form onsubmit="handleNewComment(event)">
                <input type="hidden" id="currentPostId">
                <div class="form-group">
                    <textarea id="commentText" placeholder="Add a comment..." required
                        style="min-height: 60px;"></textarea>
                </div>
                <div class="modal-footer" style="justify-content: space-between;">
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('postDetailModal')">Close</button>
                    <button type="submit" class="btn btn-primary">Comment</button>
                </div>
            </form>
        </div>
    </div>
    <div id="imageLightbox" class="lightbox" onclick="closeLightbox()">
        <span class="lightbox-close">&times;</span>
        <img class="lightbox-content" id="lightboxImg" onclick="event.stopPropagation()" draggable="false"
            ondragstart="return false;">
        <div
            style="position: absolute; bottom: 20px; color: white; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 20px; font-size: 12px; pointer-events: none;">
            Scroll to Zoom â€¢ Drag to Pan
        </div>
    </div>
    <div id="customContextMenu">
        <button id="btnUnsend" onclick="performUnsend()" style="display:none; color:#ff453a;">Unsend Message</button>
        <button id="btnDeleteChat" onclick="performDeleteChat()" style="display:none; color:#ff453a;">Delete
            Conversation</button>
    </div>
    <div id="confirmModal" class="modal" style="z-index: 11000;">
        <div class="modal-content" style="max-width: 320px; text-align: center; padding: 25px;">
            <h3 id="confirmTitle" style="margin-bottom: 10px; font-size: 20px;">Are you sure?</h3>
            <p id="confirmMessage" style="color: var(--text-secondary); margin-bottom: 25px; font-size: 14px;">This
                action cannot be undone.</p>

            <div style="display: flex; gap: 15px; justify-content: center;">
                <button class="btn btn-danger" onclick="closeConfirmModal()" style="flex: 1;">CANCEL</button>
                <button id="btnConfirmAction" class="btn btn-primary" style="flex: 1;">CONFIRM</button>
            </div>
        </div>
    </div>

    <div id="exitAnonModal" class="modal" style="z-index: 11000;">
        <div class="modal-content" style="max-width: 350px; text-align: center;">
            <h3 style="margin-bottom: 15px; color: var(--text-main);">Exit Anonymous mode</h3>
            <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 14px;">
                Enter your password to exit Incognito Mode.
            </p>
            <input type="password" id="exitAnonPassword" placeholder="Enter Password"
                style="margin-bottom: 20px; text-align: center;">
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" style="flex:1"
                    onclick="document.getElementById('exitAnonModal').classList.remove('active')">Cancel</button>
                <button class="btn btn-primary" style="flex:1" onclick="confirmExitAnon()">Exit</button>
            </div>
        </div>
    </div>
    <div id="forgotPasswordModal" class="modal" style="z-index: 12000;">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <h3 style="margin-bottom: 10px;">Account Recovery</h3>

            <div id="fpStep1">
                <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 20px;">Enter your college email
                    to receive a verification code.</p>
                <input type="email" id="fpEmail" placeholder="Enter email..." style="margin-bottom: 15px;">
                <button class="btn btn-primary" style="width: 100%;" onclick="handleFpsSendOTP()">Send OTP</button>
            </div>

            <div id="fpStep2" class="hidden">
                <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 20px;">Enter the 6-digit code
                    sent to your email.</p>
                <input type="number" id="fpOtpInput" placeholder="123456"
                    style="margin-bottom: 15px; letter-spacing: 5px; text-align: center; font-weight: bold;">
                <button class="btn btn-primary" style="width: 100%;" onclick="handleFpsVerifyOTP()">Verify Code</button>
                <div style="margin-top: 10px; font-size: 12px; color: var(--text-secondary); cursor: pointer;"
                    onclick="resetFpsUI()">Wrong email?</div>
            </div>

            <div id="fpStep3" class="hidden">
                <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 20px;">Create a new password.
                </p>
                <input type="password" id="fpNewPass" placeholder="New Password" style="margin-bottom: 10px;">
                <input type="password" id="fpConfirmPass" placeholder="Confirm Password" style="margin-bottom: 15px;">
                <button class="btn btn-primary" style="width: 100%;" onclick="handleFpsSavePassword()">Reset
                    Password</button>
            </div>

            <div style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 10px;">
                <button class="btn btn-secondary" onclick="closeForgotModal()">Cancel</button>
            </div>
        </div>
    </div>
    <div id="adminPanelModal" class="modal" style="z-index: 12000;">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header"
                style="border-bottom: 1px solid #ff453a; color: #ff453a; display:flex; justify-content:space-between; align-items:center;">
                <span>ðŸ‘®â€â™‚ï¸ Admin Dashboard</span>
                <span id="reportCountBadge"
                    style="font-size:14px; background:#333; padding:4px 10px; border-radius:10px; color:white;">0
                    Reports</span>
            </div>

            <div id="adminReportsList"
                style="flex: 1; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 12px; margin-top: 10px;">
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('adminPanelModal')">Close Panel</button>
            </div>
        </div>
    </div>

    <div id="customToast">Action Restricted</div>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBFivNpSRGK87SDxzi3wWJAl3Pia_vrezo",
            authDomain: "college-mentorship--app.firebaseapp.com",
            projectId: "college-mentorship--app",
            storageBucket: "college-mentorship--app.firebasestorage.app",
            messagingSenderId: "842851012332",
            appId: "1:842851012332:web:37ff1cbf9b7b90977c1fc9",
            measurementId: "G-G6MN80S4LM"
        };

        let app, auth, db;

        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            console.log("Firebase initialized");
        } catch (error) { console.error(error); }
        // ... (existing init code)
        db = firebase.firestore();
        const storage = firebase.storage(); // <--- ADD THIS
        console.log("Firebase initialized");
        // --- DAILY POLL LOGIC ---

        // REPLACE THESE WITH REAL UIDs
        const ADMIN_UIDS = [
            'user_1766072628767',  //Sid
            'user_1766080376453' //Selva
        ];

        let currentPollData = null;

        function openDailyPoll() {
            lockScroll();
            const modal = document.getElementById('dailyPollModal');
            modal.classList.add('active');

            // Check Admin Status
            if (currentUser && ADMIN_UIDS.includes(currentUser.uid)) {
                document.getElementById('btnEditPoll').style.display = 'block';
            } else {
                document.getElementById('btnEditPoll').style.display = 'none';
            }

            loadActivePoll();
        }

        function loadActivePoll() {
            const container = document.getElementById('pollOptionsContainer');
            const questionEl = document.getElementById('pollQuestionDisplay');
            const votesEl = document.getElementById('pollTotalVotes');
            // 1. SELECT THE MAIN BUTTON
            const pollBtn = document.querySelector('.daily-poll-style');

            container.innerHTML = '<p style="color:#888;">Loading...</p>';

            db.collection('system').doc('daily_poll').onSnapshot(doc => {
                if (!doc.exists) {
                    questionEl.innerText = "No active poll today.";
                    container.innerHTML = "";
                    return;
                }

                currentPollData = doc.data();
                questionEl.innerText = currentPollData.question;

                const totalVotes = currentPollData.totalVotes || 0;
                votesEl.innerText = `${totalVotes} Votes`;

                // Render Options
                let html = '';
                const myVote = currentPollData.votes ? currentPollData.votes[currentUser.uid] : undefined;

                // --- NEW: TOGGLE DULL STATE ---
                if (myVote !== undefined) {
                    // User has voted: Add class to make it dull
                    pollBtn.classList.add('voted');
                } else {
                    // User hasn't voted: Ensure it's flashy
                    pollBtn.classList.remove('voted');
                }
                // ------------------------------

                currentPollData.options.forEach((opt, index) => {
                    const voteCount = currentPollData.counts ? (currentPollData.counts[index] || 0) : 0;
                    const percent = totalVotes > 0 ? Math.round((voteCount / totalVotes) * 100) : 0;

                    const isVotedClass = myVote === index ? 'voted' : '';
                    const showResults = myVote !== undefined || (currentUser && ADMIN_UIDS.includes(currentUser.uid));

                    html += `
                    <div class="poll-option-btn ${isVotedClass}" onclick="submitVote(${index})">
                        <div class="poll-fill-bar" style="width: ${showResults ? percent : 0}%"></div>
                        <div class="poll-text-wrapper">
                            <span>${opt}</span>
                            ${showResults ? `<span>${percent}%</span>` : ''}
                        </div>
                    </div>`;
                });

                container.innerHTML = html;
            });
        }

        function submitVote(optionIndex) {
            if (!currentUser) return showToast("Please login to vote.");

            // Optimistic check: prevent double clicks visually, DB rules handles logic
            if (currentPollData.votes && currentPollData.votes[currentUser.uid] !== undefined) {
                return showToast("You already voted today!");
            }

            const pollRef = db.collection('system').doc('daily_poll');

            // 1. Register who voted for what
            const voteKey = `votes.${currentUser.uid}`;

            db.runTransaction(async (t) => {
                const doc = await t.get(pollRef);
                const data = doc.data();

                if (data.votes && data.votes[currentUser.uid] !== undefined) {
                    throw "Already voted";
                }

                const newCounts = data.counts || new Array(data.options.length).fill(0);
                newCounts[optionIndex] = (newCounts[optionIndex] || 0) + 1;

                t.update(pollRef, {
                    [`votes.${currentUser.uid}`]: optionIndex,
                    counts: newCounts,
                    totalVotes: firebase.firestore.FieldValue.increment(1)
                });
            }).then(() => {
                showToast("Vote cast!");
            }).catch(e => {
                if (e === "Already voted") showToast("You already voted.");
                else console.error(e);
            });
        }

        // --- ADMIN ONLY FUNCTIONS ---

        // --- ADMIN ONLY FUNCTIONS ---

        function togglePollEditMode() {
            const view = document.getElementById('pollViewMode');
            const edit = document.getElementById('pollEditMode');
            const optionsList = document.getElementById('pollOptionsList');

            if (view.classList.contains('hidden')) {
                // Switching BACK to View Mode
                view.classList.remove('hidden');
                edit.classList.add('hidden');
            } else {
                // Switching TO Edit Mode
                view.classList.add('hidden');
                edit.classList.remove('hidden');

                // Clear and Initialize with 2 empty options if empty
                if (optionsList.innerHTML.trim() === '') {
                    addPollOptionField('', false); // Option 1 (No remove button)
                    addPollOptionField('', false); // Option 2 (No remove button)
                }
            }
        }

        function addPollOptionField(value = '', allowRemove = true) {
            const container = document.getElementById('pollOptionsList');
            const div = document.createElement('div');
            div.className = 'poll-input-row';

            // Generate unique ID for input
            const id = 'pollOpt_' + Date.now() + Math.random().toString(36).substr(2, 5);

            div.innerHTML = `
                <input type="text" id="${id}" value="${value}" placeholder="Enter option..." class="poll-option-input">
                ${allowRemove ? `<div class="btn-remove-opt" onclick="this.parentElement.remove()">âœ•</div>` : ''}
            `;

            container.appendChild(div);
        }

        function saveNewPoll() {
            const q = document.getElementById('newPollQuestion').value.trim();

            // Collect all inputs from the dynamic list
            const inputs = document.querySelectorAll('.poll-option-input');
            const options = [];

            inputs.forEach(input => {
                const val = input.value.trim();
                if (val) options.push(val);
            });

            if (!q) return alert("Please enter a question.");
            if (options.length < 2) return alert("Please provide at least 2 valid options.");

            if (!confirm("This will WIPE the current poll and start fresh. Confirm?")) return;

            // Initialize counts array based on number of options
            const zeroCounts = new Array(options.length).fill(0);

            db.collection('system').doc('daily_poll').set({
                question: q,
                options: options,
                counts: zeroCounts,
                votes: {}, // Reset votes map
                totalVotes: 0,
                createdAt: new Date()
            }).then(() => {
                showToast("New Daily Poll Published!");

                // Reset UI
                document.getElementById('newPollQuestion').value = "";
                document.getElementById('pollOptionsList').innerHTML = ""; // Clear options

                togglePollEditMode(); // Go back to view mode
            }).catch(e => {
                console.error(e);
                alert("Error saving poll: " + e.message);
            });
        }

        // --- GLOBAL STATE ---
        let currentUser = null; // FIXED: Removed "letlet" typo
        let currentUserData = null;

        // --- CONSTANTS (Moved to Top) ---
        const TAG_DATA = [
            { name: "Technical", class: "tag-technical", hex: "#0079D3" },
            { name: "Academic", class: "tag-academic", hex: "#FF4500" },
            { name: "Council / Committee", class: "tag-council", hex: "#46D160", hasSub: true },
            { name: "Faculty Related", class: "tag-faculty", hex: "#D93A00" },
            { name: "Career Advice", class: "tag-career", hex: "#7193FF" },
            { name: "Placements / Internships", class: "tag-placements", hex: "#FFB000" },
            { name: "Campus / Infrastructure", class: "tag-campus", hex: "#0DD3BB" },
            { name: "Sports", class: "tag-sports", hex: "#CC3600" },
            { name: "Honest Review", class: "tag-review", hex: "#FF585B" },
            { name: "General", class: "tag-general", hex: "#878A8C" },
            { name: "Gossip", class: "tag-gossip", hex: "#A335EE" }
        ];

        const COUNCIL_SUBS = [
            "Technical Council", "Cultural Council", "Sports Council",
            "CESA", "CSI", "GDG", "NSS", "IEEE", "V-Club", "Music Club"
        ];

        // --- FILTERS ---
        window.activeFilters = {
            sortBy: 'latest',
            years: [],
            tags: []
        };

        // --- STARTUP ---
        document.getElementById('authScreen').classList.remove('hidden');
        document.getElementById('appScreen').classList.add('hidden');

        loadDevUsers(); // Load users immediately

        // 2. Force Show Login Screen, Hide App
        document.getElementById('authScreen').classList.remove('hidden');
        document.getElementById('appScreen').classList.add('hidden');

        // --- AUTH LOGIC ---
        // --- AUTH: REAL LOGIN HANDLER ---
        // --- AUTH: REAL LOGIN HANDLER (FIXED) ---
        // --- LIGHTBOX LOGIC (Zoom & Pan) ---
        let currentScale = 1;
        let isDragging = false;
        let startX, startY, translateX = 0, translateY = 0;

        function openLightbox(src) {
            const modal = document.getElementById('imageLightbox');
            const img = document.getElementById('lightboxImg');

            // Reset state
            currentScale = 1;
            translateX = 0;
            translateY = 0;
            img.style.transform = `translate(0px, 0px) scale(1)`;

            img.src = src;
            modal.style.display = "flex";

            // Add Scroll Listener
            img.addEventListener('wheel', handleZoom, { passive: false });
            // Add Drag Listeners
            img.addEventListener('mousedown', startDrag);
            window.addEventListener('mousemove', drag);
            window.addEventListener('mouseup', endDrag);
        }
        // --- UPLOAD HELPER ---
        function uploadFileToStorage(file) {
            return new Promise((resolve, reject) => {
                // Create a unique file name: timestamp_filename
                const fileName = Date.now() + "_" + file.name;
                const storageRef = storage.ref().child('uploads/' + fileName);

                const uploadTask = storageRef.put(file);

                uploadTask.on('state_changed',
                    (snapshot) => {
                        // Optional: You can console log progress here
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        console.log('Upload is ' + progress + '% done');
                    },
                    (error) => {
                        console.error("Upload failed:", error);
                        reject(error);
                    },
                    () => {
                        // Success! Get the URL
                        uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                            resolve(downloadURL);
                        });
                    }
                );
            });
        }
        // --- YEAR BADGE HELPER ---
        function getYearBadgeHtml(year) {
            if (!year || year === 'undefined') return '';

            let color = '#888'; // Default Gray
            // Twitter/Apple System Colors
            if (year === 'FE') color = '#30D158'; // Green
            if (year === 'SE') color = '#0A84FF'; // Blue
            if (year === 'TE') color = '#BF5AF2'; // Purple
            if (year === 'BE') color = '#FF9F0A'; // Orange

            return `<span style="
        color: ${color}; 
        border: 1px solid ${color}; 
        background: ${color}15; 
        padding: 1px 5px; 
        border-radius: 4px; 
        font-size: 9px; 
        font-weight: 800; 
        margin-left: 6px; 
        vertical-align: middle;
        display: inline-block;
    ">${year}</span>`;
        }
        function closeLightbox() {
            const modal = document.getElementById('imageLightbox');
            const img = document.getElementById('lightboxImg');
            modal.style.display = "none";

            // Clean up listeners
            img.removeEventListener('wheel', handleZoom);
            img.removeEventListener('mousedown', startDrag);
            window.removeEventListener('mousemove', drag);
            window.removeEventListener('mouseup', endDrag);
        }
        // --- CUSTOM CONFIRMATION LOGIC ---
        function showConfirm(title, message, onConfirmCallback) {
            const modal = document.getElementById('confirmModal');
            document.getElementById('confirmTitle').innerText = title;
            document.getElementById('confirmMessage').innerText = message;

            // Assign the specific action to the Confirm button
            const confirmBtn = document.getElementById('btnConfirmAction');
            confirmBtn.onclick = function () {
                onConfirmCallback(); // Run the passed function
                closeConfirmModal(); // Close modal
            };

            modal.classList.add('active');
        }
        function showToast(message) {
            const x = document.getElementById("customToast");
            x.innerText = message;
            x.className = "show";
            setTimeout(function () { x.className = x.className.replace("show", ""); }, 3000);
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('active');
        }

        function handleZoom(event) {
            event.preventDefault(); // Stop page scrolling
            const img = document.getElementById('lightboxImg');

            // Determine zoom direction
            const delta = event.deltaY * -0.005; // -0.005 sensitivity
            const newScale = Math.min(Math.max(0.5, currentScale + delta), 5); // Min 0.5x, Max 5x

            currentScale = newScale;
            updateTransform();
        }
        function deleteMessage(chatId, messageId) {
            if (!confirm("Unsend this message?")) return;

            db.collection('chats').doc(chatId).collection('messages').doc(messageId).delete()
                .then(() => {
                    console.log("Message unsent");
                    // The onSnapshot listener in openInlineChat will automatically remove it from the UI
                })
                .catch(error => {
                    console.error("Error removing message: ", error);
                    alert("Could not unsend message.");
                });
        }
        // --- DRAG / PAN LOGIC ---
        function startDrag(e) {
            if (currentScale <= 1) return; // Only drag if zoomed in
            isDragging = true;
            startX = e.clientX - translateX;
            startY = e.clientY - translateY;
            document.getElementById('lightboxImg').style.cursor = 'grabbing';
        }

        function drag(e) {
            if (!isDragging) return;
            e.preventDefault();
            translateX = e.clientX - startX;
            translateY = e.clientY - startY;
            updateTransform();
        }

        function endDrag() {
            isDragging = false;
            document.getElementById('lightboxImg').style.cursor = 'grab';
        }

        function updateTransform() {
            const img = document.getElementById('lightboxImg');
            img.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentScale})`;
        }
        function handleLogin(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerText;

            const email = document.getElementById('loginEmail').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value.trim();
            const isAnon = document.getElementById('loginAnon').checked;

            if (!email || !password) return showToast("Please enter credentials.");

            btn.innerText = "Verifying...";
            btn.disabled = true;

            // Check DB
            db.collection('users').where('email', '==', email).get()
                .then(snap => {
                    if (!snap.empty) {
                        const userDoc = snap.docs[0];
                        const userData = userDoc.data();

                        // --- PASSWORD CHECK ---
                        if (userData.password === password) {
                            // Success!
                            simulateLogin(userDoc.id, isAnon);
                        } else {
                            // Fail!
                            showToast("âŒ Incorrect Password");
                            btn.innerText = originalText;
                            btn.disabled = false;
                        }
                    } else {
                        showToast("âŒ Account not found.");
                        btn.innerText = originalText;
                        btn.disabled = false;
                    }
                })
                .catch(err => {
                    console.error(err);
                    showToast("Login Error.");
                    btn.innerText = originalText;
                    btn.disabled = false;
                });
        }
        // --- HELPER: GENERATE BUTTON HTML ---
        function generateUserButtonHtml(u) {
            const uid = u.userId || u.uid; // Handle both structures
            const name = (u.name || "Unknown").charAt(0).toUpperCase() + (u.name || "User").slice(1);

            // Visual Logic
            let icon, statusColor, statusText;
            if (u.role === 'mentor') {
                if (u.isVerified) {
                    icon = 'âœ”'; statusColor = 'var(--success-color)'; statusText = 'VERIFIED MENTOR';
                } else {
                    icon = 'âš ï¸'; statusColor = 'var(--danger-color)'; statusText = 'UNVERIFIED MENTOR';
                }
            } else {
                icon = 'ðŸŽ“'; statusColor = 'var(--text-muted)'; statusText = 'STUDENT';
            }

            const borderColor = u.role === 'mentor' && u.isVerified ? 'var(--success-color)' : 'var(--glass-border)';

            return `
            <button class="btn btn-secondary" onclick="simulateLogin('${uid}')" style="justify-content: flex-start; gap: 12px; border: 1px solid ${borderColor}; padding: 12px; margin-bottom:10px; width:100%; transition: transform 0.2s;">
                <div style="width:30px; height:30px; border-radius:50%; background:${statusColor}; color:black; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:14px; flex-shrink:0;">
                    ${u.profilePic ? `<img src="${u.profilePic}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">` : icon}
                </div>
                <div style="text-align:left; overflow:hidden;">
                    <div style="font-weight: 700; color: white; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${name}</div>
                    <div style="font-size: 10px; color: ${statusColor}; font-weight:600;">${statusText}</div>
                </div>
            </button>`;
        }
        // --- INIT APP ---
        // 1. Reset
        currentUser = null;
        currentUserData = null;

        // 2. Show Login
        document.getElementById('authScreen').classList.remove('hidden');
        document.getElementById('appScreen').classList.add('hidden');



        // --- 2. UPDATE LOGIN TO START TRACKING ---
        function simulateLogin(uid, isAnonSession) {
            db.collection('users').doc(uid).get().then(doc => {
                const realData = doc.data();

                // 1. Create Session Data
                if (isAnonSession) {
                    window.currentUserData = {
                        ...realData,
                        // MASKED DATA FOR FRONTEND LOGIC
                        displayNameOverride: "Anonymous",
                        roleOverride: "Guest",
                        profilePicOverride: "",
                        isAnonymousSession: true,
                        realYear: realData.year // Keep real year accessible for logic but not display
                    };
                } else {
                    window.currentUserData = { ...realData, isAnonymousSession: false };
                }
                window.currentUser = { uid: doc.id };
                currentUser = window.currentUser;
                currentUserData = window.currentUserData;

                // 2. UI Switch
                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('appScreen').classList.remove('hidden');

                // 3. UI Restrictions for Anonymous
                if (isAnonSession) {
                    // HIDE TABS
                    const tabs = document.querySelectorAll('.tab-button');
                    tabs.forEach(t => {
                        if (t.innerText === "Messages" || t.innerText === "Explore") {
                            t.style.display = 'none';
                        }
                    });

                    // HIDE NAVBAR ICONS
                    const navRight = document.querySelector('.navbar-right');
                    // Hide connection/request icons (first 2 children)
                    navRight.children[0].children[0].classList.add('hidden');
                    navRight.children[0].children[1].classList.add('hidden');

                    updateUserInfo();
                    loadCommunity(); // Only load community
                    switchTab('community');
                } else {
                    // RESTORE UI (In case of re-login)
                    document.querySelectorAll('.tab-button').forEach(t => t.style.display = 'block');
                    const navRight = document.querySelector('.navbar-right');
                    navRight.children[0].children[0].classList.remove('hidden');
                    navRight.children[0].children[1].classList.remove('hidden');

                    updateUserInfo();
                    loadDevUsers();
                    initNotificationListener();
                    startPresenceHeartbeat();
                    switchTab('community');
                }
            });
        }
        // --- AUTH: TOGGLE UI ---
        function toggleAuthMode(mode) {
            if (mode === 'register') {
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('registerSection').classList.remove('hidden');
            } else {
                document.getElementById('registerSection').classList.add('hidden');
                document.getElementById('loginSection').classList.remove('hidden');
            }
        }

        function applyCardTheme(img) {
            // 1. Safety check
            if (!img.complete || img.naturalWidth === 0) return;

            try {
                // 2. Get Dominant Color
                const canvas = document.createElement('canvas');
                canvas.width = 1;
                canvas.height = 1;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, 1, 1);
                const [r, g, b] = ctx.getImageData(0, 0, 1, 1).data;
                const rgb = `${r},${g},${b}`;

                // 3. Find the parent Card
                const card = img.closest('.card');
                if (card) {
                    // ðŸš¨ FIX: Apply SOLID color (with slight gradient for depth), NO image texture
                    card.style.background = `linear-gradient(135deg, rgb(${rgb}), rgba(${rgb}, 0.8))`;

                    // Match border and shadow to the theme
                    card.style.borderColor = `rgba(${rgb}, 0.6)`;
                    card.style.boxShadow = `0 15px 40px -10px rgba(${rgb}, 0.4)`;

                    // 4. Calculate Contrast (YIQ Formula)
                    const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
                    const isDarkBg = yiq < 128; // < 128 means the background is dark

                    // 5. Apply Text Colors based on contrast
                    const titleColor = isDarkBg ? '#ffffff' : '#000000';
                    const bodyColor = isDarkBg ? 'rgba(255,255,255,0.9)' : 'rgba(0,0,0,0.8)';

                    // Apply colors to text elements
                    card.querySelectorAll('.card-header, strong').forEach(el => el.style.color = titleColor);
                    card.querySelectorAll('p, small').forEach(el => el.style.color = bodyColor);

                    // Fix badges to match new contrast
                    card.querySelectorAll('.badge').forEach(el => {
                        el.style.color = titleColor;
                        el.style.borderColor = bodyColor;
                        el.style.background = isDarkBg ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.1)';
                    });
                }
            } catch (e) {
                console.log("Could not extract color:", e);
            }
        }

        // --- AUTH: WORK EXPERIENCE LOGIC ---
        function addExperienceField() {
            const container = document.getElementById('workExpContainer');
            const div = document.createElement('div');
            div.className = 'exp-row';
            div.innerHTML = `
                <input type="text" class="exp-input" placeholder="e.g. Intern at Google" style="flex-grow:1;">
                <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()" style="padding: 0 12px;">X</button>
            `;
            container.appendChild(div);
        }

        // --- AUTH: REGISTER HANDLER ---
        // --- AUTH: REGISTER HANDLER (FIXED) ---
        // --- AUTH: REGISTER HANDLER (FIXED) ---
        function handleLogin(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerText;

            const email = document.getElementById('loginEmail').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value.trim();
            // CAPTURE CHECKBOX STATE
            const isAnon = document.getElementById('loginAnon').checked;

            if (!email || !password) return showToast("Please enter credentials.");

            btn.innerText = "Verifying...";
            btn.disabled = true;

            // Check DB
            db.collection('users').where('email', '==', email).get()
                .then(snap => {
                    if (!snap.empty) {
                        const userDoc = snap.docs[0];
                        // In a real app, verify password here. For demo, we trust it.
                        simulateLogin(userDoc.id, isAnon);
                    } else {
                        showToast("Account not found.");
                        btn.innerText = originalText;
                        btn.disabled = false;
                    }
                })
                .catch(err => {
                    console.error(err);
                    btn.innerText = originalText;
                    btn.disabled = false;
                });
        }

        function handleRegister(e) {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerText;

            submitBtn.disabled = true;
            submitBtn.innerText = "Creating Account...";

            // 1. Get Values
            const isAnon = document.getElementById('regAnon').checked;
            const name = document.getElementById('regName').value.trim();
            const email = document.getElementById('regEmail').value.trim().toLowerCase();
            const password = document.getElementById('regPass').value; // Store raw password
            const year = document.getElementById('regYear').value;
            const college = document.getElementById('regCollege').value;
            const role = "student";

            if (!password || password.length < 6) {
                alert("Password must be at least 6 characters.");
                submitBtn.disabled = false;
                submitBtn.innerText = originalText;
                return;
            }

            const performRegistration = (base64Pic) => {
                const newUserId = "user_" + Date.now();

                const newUser = {
                    userId: newUserId,
                    name: name,
                    email: email,
                    year: year,
                    role: role,
                    college: college,
                    profilePic: base64Pic || "",
                    isVerified: false,
                    createdAt: new Date(),
                    password: password // CRITICAL: Saving password to DB for verification
                };

                // 2. Save to Firestore
                db.collection('users').doc(newUserId).set(newUser)
                    .then(() => {
                        if (typeof showToast === 'function') showToast("Account created!");
                        // 3. Log them in immediately
                        simulateLogin(newUserId, isAnon);
                    })
                    .catch(err => {
                        console.error(err);
                        alert("Error: " + err.message);
                        submitBtn.innerText = originalText;
                        submitBtn.disabled = false;
                    });
            };

            // 4. Handle File Upload
            const fileInput = document.getElementById('regFile');
            if (fileInput.files.length > 0) {
                const reader = new FileReader();
                reader.onload = function (e) { performRegistration(e.target.result); };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                performRegistration(null);
            }
        }
        // --- NOTIFICATION LOGIC ---
        let currentPendingRequestIds = [];

        function initNotificationListener() {
            if (!currentUser) return;

            db.collection('connection_requests')
                .where('recipientId', '==', currentUser.uid)
                .where('status', '==', 'pending')
                .onSnapshot(snap => {
                    // 1. Get all current pending IDs from DB
                    currentPendingRequestIds = snap.docs.map(doc => doc.id);

                    // 2. Get list of IDs we have already "seen" (from LocalStorage)
                    const viewedIds = JSON.parse(localStorage.getItem('viewedRequests') || '[]');

                    // 3. Count how many pending IDs are NOT in the viewed list
                    const newCount = currentPendingRequestIds.filter(id => !viewedIds.includes(id)).length;

                    // 4. Update UI
                    const badge = document.getElementById('requestBadge');
                    if (newCount > 0) {
                        badge.innerText = newCount > 9 ? '9+' : newCount;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                });
        }
        // --- DEV: LOAD ALL USERS ---
        // --- DEV: LOAD ALL USERS (Fixed) ---
        function loadDevUsers() {
            const container = document.getElementById('devUserList');
            container.innerHTML = '<p style="color:#666; font-size:13px;">Loading accounts...</p>';

            // Only fetch real users from Firestore
            db.collection('users').orderBy('createdAt', 'desc').get().then(snap => {
                container.innerHTML = ''; // Clear loading text

                if (snap.empty) {
                    container.innerHTML = '<p style="color:var(--text-muted); font-size:13px;">No accounts found.</p>';
                    return;
                }

                snap.forEach(doc => {
                    const u = doc.data();
                    u.userId = doc.id;
                    container.innerHTML += generateUserButtonHtml(u);
                });
            }).catch(e => {
                console.error("Dev list error:", e);
                container.innerHTML = '<p style="color:var(--danger-color);">Error loading users.</p>';
            });
        }


        async function deleteAccount() {
            if (!confirm("âš ï¸ FINAL WARNING: This will delete your account, posts, chats, and connections. This cannot be undone.")) return;

            const user = auth.currentUser;
            const userId = user.uid;

            try {
                // 1. Delete My Posts
                const postsSnap = await db.collection('posts').where('authorId', '==', userId).get();
                const batch1 = db.batch();
                postsSnap.forEach(doc => batch1.delete(doc.ref));
                await batch1.commit();
                console.log("User posts deleted");

                // 2. Delete My Chats (and the messages inside)
                // Note: In a real app we'd delete subcollections recursively, but here we delete the chat doc handle
                const chatsSnap = await db.collection('chats').where('participants', 'array-contains', userId).get();
                const batch2 = db.batch();
                chatsSnap.forEach(doc => batch2.delete(doc.ref));
                await batch2.commit();
                console.log("User chats deleted");

                // 3. Delete Connection Requests (Sent & Received)
                const sentSnap = await db.collection('connection_requests').where('senderId', '==', userId).get();
                const recSnap = await db.collection('connection_requests').where('recipientId', '==', userId).get();
                const batch3 = db.batch();
                sentSnap.forEach(doc => batch3.delete(doc.ref));
                recSnap.forEach(doc => batch3.delete(doc.ref));
                await batch3.commit();
                console.log("Connections deleted");

                // 4. Delete User Profile
                await db.collection('users').doc(userId).delete();

                // 5. Delete Auth Credential
                await user.delete();

                alert("Account and all associated data deleted.");
                sessionStorage.clear();
                window.location.reload();

            } catch (error) {
                console.error("Error deleting account:", error);
                if (error.code === 'auth/requires-recent-login') {
                    alert("Security Check: Please log out and log back in, then try deleting your account again.");
                } else {
                    alert("Failed to delete account: " + error.message);
                }
            }
        }


        // --- NAVIGATION LOGIC (FIXED) ---
        function switchTab(arg1, arg2) {
            let tabName = typeof arg1 === 'string' ? arg1 : arg2;

            // --- NEW LOGIC: Clear Badge when opening Requests ---
            if (tabName === 'requests') {
                // Save all current pending IDs as "viewed"
                localStorage.setItem('viewedRequests', JSON.stringify(currentPendingRequestIds));
                // Hide badge immediately
                document.getElementById('requestBadge').classList.add('hidden');
            }
            if (document.getElementById('chats')) {
                document.getElementById('chats').classList.remove('mobile-chat-open');
            }

            // ... (Keep your existing tab switching logic below) ...
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');

            const btn = document.querySelector(`.tab-button[onclick*="'${tabName}'"]`);
            if (btn) btn.classList.add('active');

            if (tabName === 'mentors') loadMentors();
            if (tabName === 'chats') loadChats();
            if (tabName === 'community') loadPosts();
            if (tabName === 'requests') loadRequests();
            if (tabName === 'profile') loadProfile();
        }
        // --- MARK ANSWER AS GOATED ---
        function toggleGoatStatus(postId, commentId, commentAuthorRole) {
            // 1. Security Check: Only Mentors can receive this
            if (commentAuthorRole === 'Student') {
                showToast("Only Mentors can be GOATed! ðŸ");
                return;
            }

            const postRef = db.collection('posts').doc(postId);

            // 2. Transaction to ensure only 1 exists
            db.runTransaction(async (transaction) => {
                const postDoc = await transaction.get(postRef);
                if (!postDoc.exists) return;

                const currentGoat = postDoc.data().goatedCommentId;

                // If clicking the same one, remove it (toggle off)
                if (currentGoat === commentId) {
                    transaction.update(postRef, { goatedCommentId: firebase.firestore.FieldValue.delete() });
                } else {
                    // Otherwise, set this new one as THE goat (overwrites previous)
                    transaction.update(postRef, { goatedCommentId: commentId });
                }
            }).then(() => {
                showToast("GOAT Status Updated! ðŸ");
                // Reload comments to see the change
                loadComments(postId);
            }).catch(error => {
                console.error("Goat error:", error);
            });
        }
        // --- CONTEXT MENU LOGIC (Right Click / Long Press) ---
        // --- CONTEXT MENU LOGIC (Dynamic) ---
        let contextMenuTarget = { type: null, id1: null, id2: null };
        let longPressTimer;

        function showContextMenu(e, type, id1, id2 = null) {
            e.preventDefault();
            e.stopPropagation(); // Prevent other clicks

            contextMenuTarget = { type, id1, id2 };

            const menu = document.getElementById('customContextMenu');
            const btnUnsend = document.getElementById('btnUnsend');
            const btnDelete = document.getElementById('btnDeleteChat');

            // 1. Toggle Buttons based on Type
            if (type === 'message') {
                btnUnsend.style.display = 'block';
                btnDelete.style.display = 'none';
            } else if (type === 'chat') {
                btnUnsend.style.display = 'none';
                btnDelete.style.display = 'block';
            }

            // 2. Position Menu
            let x = e.pageX || (e.touches ? e.touches[0].pageX : 0);
            let y = e.pageY || (e.touches ? e.touches[0].pageY : 0);

            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;
            menu.style.display = 'block';
        }

        function hideContextMenu() {
            document.getElementById('customContextMenu').style.display = 'none';
        }
        window.addEventListener('click', hideContextMenu);
        window.addEventListener('scroll', hideContextMenu);

        // --- ACTIONS ---
        function performUnsend() {
            // id1 = chatId, id2 = msgId
            if (contextMenuTarget.type === 'message') {
                deleteMessage(contextMenuTarget.id1, contextMenuTarget.id2);
            }
            hideContextMenu();
        }

        function performDeleteChat() {
            if (contextMenuTarget.type === 'chat') {
                showConfirm(
                    "Delete Conversation?",
                    "This will delete the chat history permanently.",
                    () => {
                        db.collection('chats').doc(contextMenuTarget.id1).delete().then(() => {
                            loadChats();
                            // Clear screen if open
                            if (document.getElementById('selectedChatId').value === contextMenuTarget.id1) {
                                document.getElementById('chatHeader').textContent = "Select a chat to begin.";
                                document.getElementById('messagesContainer').innerHTML = "";
                                document.getElementById('sendMessageForm').classList.add('hidden');
                            }
                        });
                    }
                );
            }
            hideContextMenu();
        }

        // --- LONG PRESS HANDLERS ---
        function startLongPress(e, type, id1, id2 = null) {
            longPressTimer = setTimeout(() => {
                showContextMenu(e, type, id1, id2);
            }, 600);
        }

        function cancelLongPress() {
            clearTimeout(longPressTimer);
        }
        // --- POST OPTIONS LOGIC ---
        function togglePostMenu(event, postId) {
            event.stopPropagation(); // Prevent opening post detail

            // Close all other open menus first
            document.querySelectorAll('.options-menu').forEach(el => {
                if (el.id !== `menu-${postId}`) el.classList.remove('active');
            });

            const menu = document.getElementById(`menu-${postId}`);
            if (menu) menu.classList.toggle('active');
        }

        // Close menus when clicking anywhere else
        window.addEventListener('click', () => {
            document.querySelectorAll('.options-menu').forEach(el => el.classList.remove('active'));
        });

        function reportPost(event, postId) {
            event.stopPropagation();

            // Close menu visually
            const menu = document.getElementById(`menu-${postId}`);
            if (menu) menu.classList.remove('active');

            if (!currentUser) {
                if (typeof showToast === 'function') showToast("Please login to report.");
                return;
            }

            // 1. Fetch the post first to check if already reported
            db.collection('posts').doc(postId).get().then(doc => {
                if (!doc.exists) return;

                const data = doc.data();
                const reports = data.reports || [];

                // 2. Check if MY ID is already in the array
                if (reports.includes(currentUser.uid)) {
                    showToast("âš ï¸ You have already reported this post.");
                    return;
                }

                // 3. REPLACED Browser Confirm with Custom Modal
                showConfirm(
                    "Report Post?",
                    "Are you sure you want to flag this content for developer review?",
                    () => {
                        // This code runs only if user clicks "CONFIRM"
                        db.collection('posts').doc(postId).update({
                            reports: firebase.firestore.FieldValue.arrayUnion(currentUser.uid),
                            reportCount: firebase.firestore.FieldValue.increment(1)
                        }).then(() => {
                            showToast("Post Reported. Thank you.");
                        }).catch(e => {
                            console.error(e);
                            showToast("Error reporting post.");
                        });
                    }
                );
            });
        }

        // --- POST FILE HANDLING ---
        function handlePostFileSelect() {
            const fileInput = document.getElementById('postFileInput');
            const nameDisplay = document.getElementById('postFileName');
            const removeBtn = document.getElementById('removePostImgBtn');
            if (fileInput.files.length > 0) {
                nameDisplay.innerText = fileInput.files[0].name;
                removeBtn.style.display = 'inline-block';
            }
        }

        function removePostImage() {
            const fileInput = document.getElementById('postFileInput');
            const nameDisplay = document.getElementById('postFileName');
            const removeBtn = document.getElementById('removePostImgBtn');
            fileInput.value = "";
            nameDisplay.innerText = "No file";
            removeBtn.style.display = 'none';
        }

        function handleChatFileSelect(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];

                // 1. Detect Type
                const type = file.type.startsWith('video/') ? 'video' : 'image';

                // 2. Limit Size (Increased to 15MB for Video Support)
                // Firebase Storage handles large files well, but let's keep it reasonable for a demo
                if (file.size > 15 * 1024 * 1024) {
                    alert("File too large. Max 15MB allowed.");
                    input.value = "";
                    return;
                }

                // 3. Show "Uploading..." Toast (Optional but good UX)
                if (typeof showToast === 'function') showToast("Uploading media...");

                // 4. Upload to Cloud Storage -> Get URL -> Send
                uploadFileToStorage(file).then(url => {
                    sendChatFile(url, type);
                }).catch(err => {
                    alert("Upload failed: " + err.message);
                });

                input.value = "";
            }
        }

        function sendChatFile(base64String, type) {
            const chatId = document.getElementById('selectedChatId').value;
            if (!chatId) return;

            db.collection('chats').doc(chatId).collection('messages').add({
                imageUrl: base64String, // Still using 'imageUrl' field to store data
                mediaType: type,        // NEW: Stores 'image' or 'video'
                text: type === 'video' ? "Sent a video" : "Sent an image",
                senderId: currentUser.uid,
                timestamp: new Date()
            });

            db.collection('chats').doc(chatId).update({
                lastMessage: type === 'video' ? "ðŸŽ¥ Video" : "ðŸ“· Image",
                updatedAt: new Date()
            });
        }

        function sendChatImage(base64String) {
            const chatId = document.getElementById('selectedChatId').value;
            if (!chatId) return;

            // Send message with imageUrl field
            db.collection('chats').doc(chatId).collection('messages').add({
                imageUrl: base64String,
                text: "Sent an image", // Fallback text for list view
                senderId: currentUser.uid,
                timestamp: new Date()
            });

            // Update last message in chat list
            db.collection('chats').doc(chatId).update({
                lastMessage: "ðŸ“· Image",
                updatedAt: new Date()
            });
        }
        // --- EMOJI LOGIC ---
        const commonEmojis = [
            "ðŸ˜€", "ðŸ˜ƒ", "ðŸ˜„", "ðŸ˜", "ðŸ˜†", "ðŸ˜…", "ðŸ˜‚", "ðŸ¤£", "ðŸ¥²", "ðŸ˜Š",
            "ðŸ˜‡", "ðŸ™‚", "ðŸ™ƒ", "ðŸ˜‰", "ðŸ˜Œ", "ðŸ˜", "ðŸ¥°", "ðŸ˜˜", "ðŸ˜—", "ðŸ˜™",
            "ðŸ˜š", "ðŸ˜‹", "ðŸ˜›", "ðŸ˜", "ðŸ˜œ", "ðŸ¤ª", "ðŸ¤¨", "ðŸ§", "ðŸ¤“", "ðŸ˜Ž",
            "ðŸ¥¸", "ðŸ¤©", "ðŸ¥³", "ðŸ˜", "ðŸ˜’", "ðŸ˜ž", "ðŸ˜”", "ðŸ˜•", "ðŸ™",
            "â˜¹ï¸", "ðŸ˜£", "ðŸ˜–", "ðŸ˜«", "ðŸ˜©", "ðŸ¥º", "ðŸ˜¢", "ðŸ˜­", "ðŸ˜¤", "ðŸ˜ ",
            "ðŸ˜¡", "ðŸ¤¬", "ðŸ¤¯", "ðŸ˜³", "ðŸ¥µ", "ðŸ¥¶", "ðŸ˜±", "ðŸ¤—", "ðŸ¤”",
            "ðŸ¤­", "ðŸ¤«", "ðŸ¤¥", "ðŸ˜¶", "ðŸ˜", "ðŸ˜‘", "ðŸ˜¬", "ðŸ™„", "ðŸ˜¯", "ðŸ˜¦",
            "ðŸ‘", "ðŸ‘Ž", "ðŸ‘Š", "âœŠ", "ðŸ¤›", "ðŸ¤œ", "ðŸ¤ž", "âœŒï¸", "ðŸ¤Ÿ", "ðŸ¤˜",
            "ðŸ‘Œ", "ðŸ¤Œ", "ðŸ¤", "ðŸ‘ˆ", "ðŸ‘‰", "ðŸ‘†", "ðŸ‘‡", "â˜ï¸", "âœ‹", "ðŸ¤š",
            "ðŸ‘‹", "ðŸ”¥", "âœ¨", "â¤ï¸", "ðŸ’¯", "ðŸŽ‰", "ðŸ’€", "ðŸ’©", "ðŸ¤¡", "ðŸ‘»"
        ];

        function toggleEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            picker.classList.toggle('hidden');

            // Lazy load emojis only when opened first time
            if (picker.innerHTML === "") {
                commonEmojis.forEach(emoji => {
                    const btn = document.createElement('button');
                    btn.className = "emoji-btn";
                    btn.innerText = emoji;
                    btn.type = "button"; // Prevent form submission
                    btn.onclick = () => insertEmoji(emoji);
                    picker.appendChild(btn);
                });
            }
        }
        // --- ADMIN PANEL LOGIC ---

        async function openAdminPanel() {
            // 1. Security Check
            const pin = prompt("Enter Admin PIN:");
            if (pin !== "1234") return alert("Access Denied");

            const modal = document.getElementById('adminPanelModal');
            const listEl = document.getElementById('adminReportsList');
            const badge = document.getElementById('reportCountBadge');

            modal.classList.add('active');
            listEl.innerHTML = '<p style="text-align:center; padding:20px; color:#aaa;">Loading reports...</p>';

            try {
                // 2. Query posts with > 0 reports AND Sort by Count (Highest first)
                const snap = await db.collection('posts')
                    .where('reportCount', '>', 0)
                    .orderBy('reportCount', 'desc') // Sorts 10 reports before 1 report
                    .get();

                badge.innerText = `${snap.size} Issues`;

                if (snap.empty) {
                    listEl.innerHTML = `
                        <div style="text-align:center; padding:40px; opacity:0.6;">
                            <div style="font-size:40px;">âœ…</div>
                            <p style="color:#fff;">All clear! No reported posts.</p>
                        </div>`;
                    return;
                }

                let html = '';
                snap.forEach(doc => {
                    const p = doc.data();

                    // Visual urgency based on count
                    let urgencyColor = '#ff453a'; // Default Red
                    if (p.reportCount > 5) urgencyColor = '#ff0000'; // Bright Red for mass reports
                    if (p.reportCount > 10) urgencyColor = '#ff00d4'; // Purple/Pink for extreme

                    html += `
                    <div class="card" style="border: 1px solid ${urgencyColor}; background: #1a0505; margin-bottom: 15px;">
                        <div class="card-header" style="color: ${urgencyColor}; font-size:14px; display:flex; align-items:center; gap:8px;">
                            <span><b>${p.reportCount} Reports</b></span>
                            ${p.reportCount > 5 ? '<span class="badge" style="background:red; color:white;">URGENT</span>' : ''}
                        </div>
                        <div class="card-body" style="color: #ddd;">
                            <div style="font-weight:bold; margin-bottom:5px; font-size:16px;">${p.title}</div>
                            <p style="font-size:13px; opacity:0.8; margin-bottom:10px; border-left:2px solid #555; padding-left:10px;">${p.body}</p>
                            
                            ${p.imageUrl ? `<img src="${p.imageUrl}" style="height:120px; border-radius:8px; border:1px solid #333; margin-top:5px;">` : ''}
                            
                            <div style="margin-top:10px; font-size:11px; color:#888; border-top:1px solid #333; padding-top:8px;">
                                Posted by: <b style="color:#fff;">${p.authorName}</b> (${p.authorRole})<br>
                                Posted: ${p.createdAt ? p.createdAt.toDate().toLocaleString() : 'N/A'}
                            </div>
                        </div>
                        <div class="card-footer" style="gap: 10px; border-top:1px solid rgba(255, 69, 58, 0.2);">
                            <button class="btn btn-secondary" style="flex:1; font-size:12px;" onclick="adminIgnoreReport('${doc.id}')">
                                âœ… Ignore (Clear Reports)
                            </button>
                            <button class="btn btn-danger" style="flex:1; font-size:12px;" onclick="adminDeletePost('${doc.id}')">
                                 Ban & Delete
                            </button>
                        </div>
                    </div>`;
                });

                listEl.innerHTML = html;

            } catch (e) {
                console.error(e);
                listEl.innerHTML = `<p style="color:red; text-align:center;">Error: ${e.message}<br><small>Make sure to create an Index in Firebase Console if asked.</small></p>`;
            }
        }
        // --- FORGOT PASSWORD LOGIC ---
        let recoveryState = {
            email: "",
            otp: null,
            userId: null
        };

        function openForgotModal() {
            resetFpsUI();
            document.getElementById('forgotPasswordModal').classList.add('active');
        }

        function closeForgotModal() {
            document.getElementById('forgotPasswordModal').classList.remove('active');
        }

        function resetFpsUI() {
            document.getElementById('fpStep1').classList.remove('hidden');
            document.getElementById('fpStep2').classList.add('hidden');
            document.getElementById('fpStep3').classList.add('hidden');
            document.getElementById('fpEmail').value = "";
            document.getElementById('fpOtpInput').value = "";
            document.getElementById('fpNewPass').value = "";
            document.getElementById('fpConfirmPass').value = "";
            recoveryState = { email: "", otp: null, userId: null };
        }

        function handleFpsSendOTP() {
            const email = document.getElementById('fpEmail').value.trim().toLowerCase();
            if (!email) return alert("Please enter email.");

            const btn = document.querySelector('#fpStep1 button');
            const originalText = btn.innerText;
            btn.innerText = "Sending...";
            btn.disabled = true;

            // 1. Check if user exists in Firestore
            db.collection('users').where('email', '==', email).get()
                .then(snap => {
                    if (snap.empty) {
                        alert("No account found with this email.");
                        btn.innerText = originalText;
                        btn.disabled = false;
                        return;
                    }

                    const doc = snap.docs[0];
                    const userData = doc.data();

                    // Save state for later steps
                    recoveryState.email = email;
                    recoveryState.userId = doc.id;

                    // 2. Generate Real OTP
                    recoveryState.otp = Math.floor(100000 + Math.random() * 900000);

                    // 3. SEND REAL EMAIL VIA EMAILJS
                    const templateParams = {
                        name: userData.name || "Student",
                        email_to: email,      // The user's email
                        otp: recoveryState.otp // The variable {{otp}} in your template
                    };

                    // REPLACE THESE WITH YOUR IDs
                    const SERVICE_ID = "Sidd@1604";
                    const TEMPLATE_ID = "template_f0etwxd"; // e.g., template_9z....

                    return emailjs.send(SERVICE_ID, TEMPLATE_ID, templateParams);
                })
                .then((response) => {
                    if (!response) return; // Handle case where user wasn't found above

                    console.log('SUCCESS!', response.status, response.text);
                    showToast("OTP sent to your email!");

                    // Switch UI to Step 2
                    document.getElementById('fpStep1').classList.add('hidden');
                    document.getElementById('fpStep2').classList.remove('hidden');

                    btn.innerText = originalText;
                    btn.disabled = false;
                })
                .catch((error) => {
                    console.error('FAILED...', error);
                    alert("Failed to send email. Check console for details.");
                    btn.innerText = originalText;
                    btn.disabled = false;
                });
        }

        function handleFpsVerifyOTP() {

            const inputOtp = document.getElementById('fpOtpInput').value;
            if (parseInt(inputOtp) === recoveryState.otp) {
                // Success
                document.getElementById('fpStep2').classList.add('hidden');
                document.getElementById('fpStep3').classList.remove('hidden');
            } else {
                alert("Incorrect OTP. Please try again.");
            }
        }

        function handleFpsSavePassword() {
            const pass1 = document.getElementById('fpNewPass').value;
            const pass2 = document.getElementById('fpConfirmPass').value;

            if (pass1.length < 6) return alert("Password must be at least 6 characters.");
            if (pass1 !== pass2) return alert("Passwords do not match.");

            // Update Database
            db.collection('users').doc(recoveryState.userId).update({
                password: pass1, // Saving directly as per your demo requirement
                updatedAt: new Date()
            }).then(() => {
                showToast("âœ… Password Reset Successfully!");
                closeForgotModal();
                // Optionally autofill the login box
                document.getElementById('loginEmail').value = recoveryState.email;
                document.getElementById('loginPassword').value = "";
            }).catch(e => {
                console.error(e);
                alert("Failed to update password.");
            });
        }

        // Action: Delete the post permanently
        function adminDeletePost(postId) {
            if (!confirm("Permanently delete this post?")) return;

            db.collection('posts').doc(postId).delete().then(() => {
                showToast("Content removed.");
                // Refresh the panel
                openAdminPanel();
            }).catch(e => alert(e.message));
        }

        // Action: Keep the post (Clear reports)
        function adminIgnoreReport(postId) {
            if (!confirm("Clear reports and keep this post?")) return;

            db.collection('posts').doc(postId).update({
                reportCount: 0,
                reports: [] // Clear the array of reporters
            }).then(() => {
                showToast("Reports cleared.");
                openAdminPanel(); // Refresh
            }).catch(e => alert(e.message));
        }
        function insertEmoji(emoji) {
            const input = document.getElementById('messageText');
            input.value += emoji;
            input.focus();
        }
        // --- NAVBAR & USER INFO ---
        function updateUserInfo() {
            if (window.currentUserData) {
                const data = window.currentUserData;

                let displayName, picUrl;

                if (data.isAnonymousSession) {
                    displayName = "Anonymous";
                    // QUESTION MARK AVATAR
                    document.getElementById('navProfileContainer').innerHTML = `<div style="font-size:20px; font-weight:bold;">?</div>`;
                    document.getElementById('navProfileContainer').style.backgroundImage = 'none';
                    document.getElementById('navProfileContainer').style.border = '2px dashed #666';
                } else {
                    displayName = (data.name || "User").charAt(0).toUpperCase() + (data.name || "User").slice(1);
                    picUrl = data.profilePic;

                    const profileIcon = document.getElementById('navProfileContainer');
                    profileIcon.style.border = '1px solid var(--border-color)';
                    if (picUrl) {
                        profileIcon.innerHTML = `<img src="${picUrl}" class="navbar-pic">`;
                    } else {
                        profileIcon.innerHTML = displayName.charAt(0);
                    }
                }

                document.getElementById('userInfo').textContent = `${displayName}`;
            }
        }


        // --- CONNECTIONS MODAL ---
        function openConnectionsModal() {
            document.getElementById('connectionsModal').classList.add('active');
            loadConnections();
        }

        function loadConnections() {
            const listEl = document.getElementById('connectionsModalList');
            listEl.innerHTML = '<p style="text-align:center; color:var(--text-secondary); margin-top:20px;">Loading...</p>';

            const sentPromise = db.collection('connection_requests').where('senderId', '==', currentUser.uid).where('status', '==', 'accepted').get();
            const receivedPromise = db.collection('connection_requests').where('recipientId', '==', currentUser.uid).where('status', '==', 'accepted').get();

            Promise.all([sentPromise, receivedPromise]).then(async ([sentSnap, receivedSnap]) => {
                const allDocs = [...sentSnap.docs, ...receivedSnap.docs];

                if (allDocs.length === 0) {
                    listEl.innerHTML = '<p style="text-align:center; color:var(--text-secondary); margin-top:20px;">No connections yet.</p>';
                    return;
                }

                // Map docs to a list of Promises to fetch user details
                const renderPromises = allDocs.map(async (doc) => {
                    const data = doc.data();
                    let otherId;

                    // Determine who the "other" person is
                    if (data.senderId === currentUser.uid) {
                        otherId = data.recipientId;
                    } else {
                        otherId = data.senderId;
                    }

                    // Fetch their latest profile data
                    let otherUser = {};
                    try {
                        const userSnap = await db.collection('users').doc(otherId).get();
                        if (userSnap.exists) otherUser = userSnap.data();
                    } catch (e) { console.error(e); }

                    // Fallback Name
                    const displayName = (otherUser.name || data.senderName || "Unknown").charAt(0).toUpperCase() + (otherUser.name || data.senderName || "User").slice(1);
                    const safeNameEncoded = encodeURIComponent(displayName);

                    // Badges
                    const role = (otherUser.role || "Student").charAt(0).toUpperCase() + (otherUser.role || "Student").slice(1);
                    const yearBadge = getYearBadgeHtml(otherUser.year);

                    // Avatar Logic
                    let avatarHtml;
                    if (otherUser.profilePic) {
                        avatarHtml = `<img src="${otherUser.profilePic}" style="width:40px; height:40px; border-radius:50%; object-fit:cover; border:1px solid var(--border-color);">`;
                    } else {
                        const initial = displayName.charAt(0);
                        avatarHtml = `<div style="width:40px; height:40px; border-radius:50%; background:#333; display:flex; align-items:center; justify-content:center; color:#ccc; font-weight:bold; font-size:16px; border:1px solid var(--border-color);">${initial}</div>`;
                    }

                    return `
                    <div class="card" style="margin-bottom: 10px; padding: 15px;">
                        
                        <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
                            ${avatarHtml}
                            <div>
                                <div style="color:var(--text-main); font-weight:700; font-size:15px; line-height:1.2;">
                                    ${displayName}
                                </div>
                                <div style="display:flex; align-items:center; gap:5px; margin-top:2px;">
                                    <span class="badge badge-verified" style="font-size:9px; padding:1px 6px;">${role}</span>
                                    ${yearBadge}
                                </div>
                            </div>
                        </div>

                        <div style="display:flex; gap:10px;">
                            <button class="btn btn-primary" style="flex:1; padding:8px; font-size:13px;" onclick="goToChatFromModal('${otherId}', '${safeNameEncoded}')">Message</button>
                            <button class="btn btn-danger" style="padding:8px; font-size:13px;" onclick="unfriend('${otherId}', '${doc.id}')">Unfriend</button>
                        </div>
                    </div>`;
                });

                // Wait for all user profiles to load
                const renderedItems = await Promise.all(renderPromises);
                listEl.innerHTML = renderedItems.join('');

            }).catch(e => {
                console.error("Error loading connections:", e);
                listEl.innerHTML = '<p style="color:var(--danger-color); text-align:center;">Failed to load.</p>';
            });
        }

        function goToChatFromModal(userId, encodedName) {
            // Close the connections popup
            document.getElementById('connectionsModal').classList.remove('active');

            // Decode the name back to normal
            const userName = decodeURIComponent(encodedName);

            // Open the chat
            goToChat(userId, userName);
        }

        function goToChat(userId, userName) {
            switchTab('chats');
            const chatId = [currentUser.uid, userId].sort().join('_');
            const chatRef = db.collection('chats').doc(chatId);

            chatRef.get().then(doc => {
                if (!doc.exists) {
                    console.log("Creating new blank chat...");
                    // Create blank document without system message
                    return chatRef.set({
                        participants: [currentUser.uid, userId],
                        updatedAt: new Date(),
                        lastMessage: ""
                    }, { merge: true });
                }
            }).then(() => {
                loadChats();
                openInlineChat(chatId, userName);
            }).catch(e => {
                console.error("Error entering chat:", e);
                alert("Could not open chat.");
            });
        }

        // --- EXPLORE & SEARCH ---
        function loadMentors() {
            const listEl = document.getElementById('searchResultsList');
            listEl.innerHTML = '<p style="text-align: center; grid-column: 1 / -1; color: var(--text-secondary);">Loading available connections...</p>';
            const usersPromise = db.collection('users').get();
            const requestsPromise = db.collection('connection_requests').where('recipientId', '==', currentUser.uid).get();
            const sentRequestsPromise = db.collection('connection_requests').where('senderId', '==', currentUser.uid).get();

            Promise.all([usersPromise, requestsPromise, sentRequestsPromise]).then(([userSnap, receivedReqSnap, sentReqSnap]) => {
                const allRequests = [...receivedReqSnap.docs, ...sentReqSnap.docs];
                renderUserResults(userSnap, allRequests);
            }).catch(e => {
                listEl.innerHTML = '<p style="color:var(--danger-color); text-align:center;">Failed to load connections. Check console (Index required).</p>';
                console.error("Error in loadMentors:", e);
            });
        }

        function handleUserSearch(event) {
            // 1. Prevent page refresh if "Enter" is pressed
            if (event) event.preventDefault();

            // 2. Get the search term and make it lowercase (Case Insensitive)
            const searchInput = document.getElementById('searchInput');
            const term = searchInput.value.toLowerCase().trim();

            // 3. Get the list of cards currently on screen
            const listEl = document.getElementById('searchResultsList');
            const cards = listEl.getElementsByClassName('card');

            // 4. Loop through every card and toggle visibility (Real-Time)
            for (let i = 0; i < cards.length; i++) {
                const card = cards[i];

                // Get all text inside the card (Name, College, Role)
                const text = card.textContent || card.innerText;

                // Check if the text matches the search term
                if (text.toLowerCase().indexOf(term) > -1) {
                    card.style.display = ""; // Show
                } else {
                    card.style.display = "none"; // Hide
                }
            }
        }

        function unfriend(otherId, reqId) {
            showConfirm(
                "Disconnect User?",
                "Are you sure you want to disconnect? Chat history will be deleted.",
                () => {
                    const batch = db.batch();
                    const chatId = [currentUser.uid, otherId].sort().join('_');

                    batch.delete(db.collection('connection_requests').doc(reqId));
                    batch.delete(db.collection('chats').doc(chatId));

                    batch.commit().then(() => {
                        document.getElementById('connectionsModal').classList.remove('active');

                        // UI Cleanup
                        const currentOpenChat = document.getElementById('selectedChatId').value;
                        if (currentOpenChat === chatId) {
                            document.getElementById('chatHeader').textContent = "Select a chat to begin.";
                            document.getElementById('messagesContainer').innerHTML = "";
                            document.getElementById('sendMessageForm').classList.add('hidden');
                            if (msgUnsub) msgUnsub();
                        }
                        loadMentors();
                        loadChats();
                    }).catch(e => alert("Error disconnecting: " + e.message));
                }
            );
        }

        function renderUserResults(snapshot, allRequests = []) {

            const listEl = document.getElementById('searchResultsList');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            let html = '';

            const DEFAULT_PIC = "https://upload.wikimedia.org/wikipedia/commons/7/7c/Profile_avatar_placeholder_large.png";

            // --- STEP 1: PRE-PROCESS REQUESTS ---
            const connectedIds = new Set();
            const requestMap = new Map();

            allRequests.forEach(reqDoc => {
                const d = reqDoc.data();
                const isSender = d.senderId === currentUser.uid;
                const otherId = isSender ? d.recipientId : d.senderId;

                if (d.status === 'accepted') {
                    connectedIds.add(otherId);
                } else if (d.status === 'pending') {
                    requestMap.set(otherId, { ...d, docId: reqDoc.id });
                }
            });

            // --- STEP 2: RENDER USERS ---
            snapshot.forEach(doc => {
                const user = doc.data();
                const targetUserId = doc.id;

                if (!user || targetUserId === currentUser.uid) return;
                if (connectedIds.has(targetUserId)) return;

                // Search Filter
                let rawName = user.name;
                if (!rawName || rawName === 'undefined') rawName = 'Unknown User';
                if (searchTerm && !rawName.toLowerCase().includes(searchTerm)) return;

                const displayName = rawName.charAt(0).toUpperCase() + rawName.slice(1).replace(/'/g, "\\'");
                const profileSrc = user.profilePic || DEFAULT_PIC;
                const role = (user.role || 'N/A').toUpperCase();

                // 1. Verification Badge Logic
                let badgeHtml = '';
                if (user.role === 'mentor' && user.isVerified) {
                    badgeHtml = `<span class="badge badge-verified" style="margin-left:5px;">MENTOR âœ”</span>`;
                } else {
                    badgeHtml = `<span class="badge" style="margin-left:5px; background:rgba(255,255,255,0.1); color:#999; border:1px solid var(--border-color);">${role}</span>`;
                }

                // 2. Experience / Headline Logic (LinkedIn Style)
                let subtextHtml = '';
                if (user.expertise && Array.isArray(user.expertise) && user.expertise.length > 0) {
                    // Join array with Pipe separator
                    const expString = user.expertise.join(' | ');
                    subtextHtml = `<p style="font-size:13px; color:var(--text-secondary); margin-top:2px; line-height:1.4;">${expString}</p>`;
                } else {
                    // Fallback for students or empty profiles
                    const fallbackText = user.role === 'student' ? `Student â€¢ ${user.year || 'N/A'}` : 'No experience listed';
                    subtextHtml = `<p style="font-size:13px; color:var(--text-secondary); margin-top:2px;">${fallbackText}</p>`;
                }

                // 3. Button State
                let buttonHtml;
                const existingRequest = requestMap.get(targetUserId);

                if (existingRequest) {
                    if (existingRequest.senderId === currentUser.uid) {
                        buttonHtml = `
                        <button class="btn btn-disabled" style="width:100%" disabled>Requested</button>
                        <button class="btn btn-danger" style="width:100%; margin-top:10px;" onclick="cancelRequest('${existingRequest.docId}')">Cancel</button>`;
                    } else {
                        buttonHtml = `
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <button class="btn btn-primary" style="flex:1" onclick="updateRequest('${existingRequest.docId}','accepted','${targetUserId}')">Accept</button>
                            <button class="btn btn-danger" style="flex:1" onclick="updateRequest('${existingRequest.docId}','rejected')">Decline</button>
                        </div>`;
                    }
                } else {
                    buttonHtml = `<button class="btn btn-primary" style="width:100%; margin-top:15px;" onclick="sendInstantConnectionRequest('${targetUserId}', this)">Connect</button>`;
                }

                html += `
                <div class="card">
                    <div class="card-content-wrapper">
                        <img src="${profileSrc}" 
                             loading="lazy" 
                             class="card-avatar" 
                             alt="Profile" 
                             crossorigin="anonymous" 
                             onload="applyCardTheme(this)">
                        <div style="width:100%; text-align:left; padding-left:10px;">
                            
                            <div class="card-header" style="font-size:18px; margin-bottom:4px; justify-content:flex-start; gap:8px; align-items:center;">
                                ${displayName} 
                                ${badgeHtml}
                            </div>
                            
                            <p style="font-size:14px; color:var(--text-main); margin-bottom:2px; font-weight:500;">
                                ${user.college || 'N/A'}
                            </p>
                            
                            ${subtextHtml}

                        </div>
                    </div>
                    <div class="card-footer" style="gap: 10px; margin-top: 0;">
                        ${buttonHtml}
                    </div>
                </div>`;
            });

            listEl.innerHTML = html || '<p style="text-align:center; grid-column: 1/-1; color: var(--text-secondary);">No new users found.</p>';
        }

        function sendInstantConnectionRequest(recipientId, btnElement) {
            // 1. IMMEDIATE VISUAL FEEDBACK (Optimistic UI)
            if (btnElement) {
                btnElement.textContent = "Requested";
                btnElement.disabled = true;
                btnElement.classList.add("btn-disabled");
                btnElement.onclick = null; // Prevent double-clicking
            }

            // 2. Fetch data and save
            const myId = currentUser.uid;

            // We fetch the target's name from DB to ensure no "undefined" or syntax errors
            db.collection('users').doc(recipientId).get().then(snap => {
                const targetData = snap.exists ? snap.data() : {};
                const targetName = targetData.name || "Unknown User";

                // Safe check for my name
                const myName = currentUserData.name || "Unknown User";

                return db.collection('connection_requests').add({
                    senderId: myId,
                    senderName: myName,
                    recipientId: recipientId,
                    recipientName: targetName,
                    status: 'pending',
                    subject: 'General Connection',
                    message: "I'd like to connect with you on VidyaGenie!",
                    createdAt: new Date()
                });
            }).then(() => {
                console.log("Request successfully stored.");
                // ðŸš¨ CRITICAL FIX: Do NOT reload loadMentors() here. 
                // Reloading immediately might fetch stale data and reset the button.
                // The visual update in step 1 is sufficient.
            }).catch(error => {
                console.error("Error sending request:", error);
                alert("Failed to send request.");
                // Revert button if error
                if (btnElement) {
                    btnElement.textContent = "Connect";
                    btnElement.disabled = false;
                    btnElement.classList.remove("btn-disabled");
                }
            });
        }

        // --- REQUESTS TAB ---
        // --- REQUESTS TAB LOGIC ---
        function loadRequests() {
            const list = document.getElementById('requestsList');
            if (!list) return;

            list.innerHTML = '<p style="text-align:center; color:var(--text-secondary);">Loading requests...</p>';

            db.collection('connection_requests')
                .where('recipientId', '==', currentUser.uid)
                .get()
                .then(async (snap) => {
                    const pendingDocs = snap.docs.filter(d => d.data().status === 'pending');

                    if (pendingDocs.length === 0) {
                        list.innerHTML = '<p style="text-align:center; color:var(--text-secondary);">No pending requests.</p>';
                        return;
                    }

                    const renderPromises = pendingDocs.map(async (doc) => {
                        const req = doc.data();

                        // Fetch Sender Profile
                        let senderUser = {};
                        try {
                            const userSnap = await db.collection('users').doc(req.senderId).get();
                            if (userSnap.exists) senderUser = userSnap.data();
                        } catch (e) { }

                        const senderName = (senderUser.name || req.senderName || "Unknown").charAt(0).toUpperCase() + (senderUser.name || req.senderName || "User").slice(1);
                        const dateStr = req.createdAt ? req.createdAt.toDate().toLocaleDateString() : 'Recently';

                        // Badges
                        const role = (senderUser.role || "Student").charAt(0).toUpperCase() + (senderUser.role || "Student").slice(1);
                        const yearBadge = getYearBadgeHtml(senderUser.year);

                        // Avatar
                        let avatarHtml;
                        if (senderUser.profilePic) {
                            // FIXED: Removed extra semicolons and fixed quote placement
                            avatarHtml = `<img src="${senderUser.profilePic}" loading="lazy" style="width:120px; height:120px; border-radius:50%; object-fit:cover; border:1px solid var(--border-color);">`;
                        } else {
                            const initial = senderName.charAt(0);
                            avatarHtml = `<div style="width:100px; height:100px; border-radius:50%; background:#333; display:flex; align-items:center; justify-content:center; color:#ccc; font-weight:bold; font-size:18px; border:1px solid var(--border-color);">${initial}</div>`;
                        }

                        return `
                        <div class="card">
                            <div class="card-header" style="justify-content:flex-start; gap:12px; border-bottom:none; padding-bottom:0;">
                                ${avatarHtml}
                                <div>
                                    <div style="font-size:16px; font-weight:700;">${senderName}</div>
                                    <div style="display:flex; align-items:center; gap:5px; margin-top:3px;">
                                        
                                        <span class="badge" style="font-size:9px; background:rgba(255,255,255,0.1); color:#ccc;">${role}</span>
                                        ${yearBadge}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card-body" style="padding-top:10px; padding-left: 60px;"> <p style="font-style:italic; margin-bottom:5px;">"${req.message}"</p>
                                <small style="color:var(--text-secondary); font-size:11px;">Received: ${dateStr}</small>
                            </div>
                            
                            <div class="card-footer" style="gap: 10px; padding-left: 60px;"> <button class="btn btn-secondary" onclick="updateRequest('${doc.id}', 'accepted', '${req.senderId}')">Accept</button>
                                <button class="btn btn-danger" onclick="updateRequest('${doc.id}', 'rejected')">Decline</button>
                            </div>
                        </div>`;
                    });

                    const html = await Promise.all(renderPromises);
                    list.innerHTML = html.join('');
                })
                .catch(e => {
                    console.error("Error loading requests:", e);
                    list.innerHTML = '<p style="text-align:center; color:var(--danger-color);">Error loading requests.</p>';
                });
        }
        function lockScroll() {
            document.body.classList.add('no-scroll');
        }

        function unlockScroll() {
            document.body.classList.remove('no-scroll');
        }
        function cancelRequest(requestId) {
            if (!confirm("Cancel this connection request?")) return;
            db.collection('connection_requests').doc(requestId).delete()
                .then(() => {
                    loadMentors(); // Refresh UI
                })
                .catch(e => console.error("Error cancelling:", e));
        }

        function updateRequest(id, status, otherId) {
            const updatePromise = db.collection('connection_requests').doc(id).update({ status: status });
            if (status === 'accepted') {
                updatePromise.then(() => createChat(otherId)).then(() => {
                    loadRequests(); loadChats();
                }).catch(error => { console.error(error); alert("Failed to finalize connection."); });
            } else {
                updatePromise.then(() => loadRequests());
            }
        }

        // --- CHATS ---
        function createChat(otherId) {
            const chatId = [currentUser.uid, otherId].sort().join('_');

            // Just create the document logic, NO system message added
            return db.collection('chats').doc(chatId).set({
                participants: [currentUser.uid, otherId],
                lastMessage: "", // Empty start
                updatedAt: new Date()
            }, { merge: true });
        }

        // --- LOAD CHATS (Connections + Active Conversations) ---
        // --- LOAD CHATS (Clean UI - Search Connections + Active Conversations) ---
        // --- 3. LOAD CHATS (With Green Dot & Search) ---
        function loadChats() {
            const listEl = document.getElementById('chatsListContent');
            const searchTerm = document.getElementById('chatSearchInput').value.toLowerCase().trim();

            if (!searchTerm) listEl.innerHTML = '<p style="color:var(--text-secondary); padding:15px;">Loading...</p>';

            const sentPromise = db.collection('connection_requests').where('senderId', '==', currentUser.uid).where('status', '==', 'accepted').get();
            const receivedPromise = db.collection('connection_requests').where('recipientId', '==', currentUser.uid).where('status', '==', 'accepted').get();
            const chatsPromise = db.collection('chats').where('participants', 'array-contains', currentUser.uid).get();

            Promise.all([sentPromise, receivedPromise, chatsPromise]).then(async ([sentSnap, recSnap, chatsSnap]) => {
                const chatMap = {};
                chatsSnap.forEach(doc => {
                    const data = doc.data();
                    const otherId = data.participants.find(id => id !== currentUser.uid);
                    chatMap[otherId] = { ...data, id: doc.id };
                });

                const connectedUserIds = new Set();
                sentSnap.forEach(doc => connectedUserIds.add(doc.data().recipientId));
                recSnap.forEach(doc => connectedUserIds.add(doc.data().senderId));

                const renderPromises = Array.from(connectedUserIds).map(async (otherId) => {
                    let otherUser = null;
                    try {
                        const uDoc = await db.collection('users').doc(otherId).get();
                        if (uDoc.exists) otherUser = uDoc.data();
                    } catch (e) { }

                    // FIX: If user not found, just return empty string (don't look for MOCK_USERS)
                    if (!otherUser) return '';

                    const name = (otherUser.name || 'User').toLowerCase();
                    if (searchTerm && !name.includes(searchTerm)) return '';

                    const displayName = otherUser.name.charAt(0).toUpperCase() + otherUser.name.slice(1);
                    const role = (otherUser.role || '').toUpperCase();

                    // STATUS DOT
                    let statusColor = '#636366';
                    if (otherUser.lastSeen) {
                        const diffMins = (new Date() - otherUser.lastSeen.toDate()) / 60000;
                        if (diffMins < 5) statusColor = '#30D158';
                    }

                    // Inside loadChats function...
                    let avatarContent = otherUser.profilePic
                        // FIXED: Removed extra semicolons and fixed quote placement
                        ? `<img src="${otherUser.profilePic}" loading="lazy" style="width:45px; height:45px; border-radius:50%; object-fit:cover; border:1px solid var(--border-color);">`
                        : `<div style="width:45px; height:45px; border-radius:50%; background:black; color:white; display:flex; align-items:center; justify-content:center; border:1px solid var(--border-color); font-weight:bold; font-size:18px;">${displayName.charAt(0)}</div>`;

                    const avatarHtml = `
                    <div style="position: relative; flex-shrink: 0;">
                        ${avatarContent}
                        <div style="position: absolute; bottom: 2px; right: 2px; width: 12px; height: 12px; background: ${statusColor}; border: 2px solid var(--bg-card); border-radius: 50%;"></div>
                    </div>`;

                    const existingChat = chatMap[otherId];
                    const lastMsg = existingChat ? (existingChat.lastMessage || 'Sent media') : 'Start a conversation';
                    const msgColor = existingChat ? 'var(--text-secondary)' : 'var(--primary-color)';
                    const chatId = existingChat ? existingChat.id : [currentUser.uid, otherId].sort().join('_');

                    return `
                    <div class="card chat-item" onclick="openInlineChat('${chatId}', '${otherId}', '${displayName}')" 
                         style="cursor:pointer; padding: 15px; margin-bottom: 5px; display: flex; align-items: center; gap: 12px; user-select: none;"
                         oncontextmenu="showContextMenu(event, 'chat', '${chatId}')"
                         ontouchstart="startLongPress(event, 'chat', '${chatId}')"
                         ontouchend="cancelLongPress()"
                         ontouchmove="cancelLongPress()">
                        ${avatarHtml}
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; font-size: 15px; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                ${displayName} <span style="font-size: 11px; color: var(--text-secondary);">(${role})</span>
                            </div>
                            <small style="color: ${msgColor}; display: block; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                ${lastMsg}
                            </small>
                        </div>
                    </div>`;
                });

                const renderedItems = await Promise.all(renderPromises);
                listEl.innerHTML = renderedItems.join('') || '<p style="color:var(--text-secondary); padding:15px;">No connections found.</p>';

            }).catch(e => {
                console.error(e);
                listEl.innerHTML = '<p style="color:var(--danger-color)">Error loading chats.</p>';
            });
        }
        // Helper: Extract dominant color from an image file object
        function getDominantColor(file) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = URL.createObjectURL(file);

                img.onload = function () {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 1;
                    canvas.height = 1;

                    // Draw image resized to 1x1 pixel to get average color
                    ctx.drawImage(img, 0, 0, 1, 1);
                    const [r, g, b] = ctx.getImageData(0, 0, 1, 1).data;

                    // Convert to Hex
                    const hex = "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
                    resolve(hex);
                };

                img.onerror = () => resolve("#FF5722"); // Fallback color
            });
        }
        // --- ADMIN: WIPE EVERYTHING ---
        async function adminWipeDB() {
            const code = prompt("Type 'CONFIRM' to delete ALL posts, chats, and users from the database.");
            if (code !== 'CONFIRM') return;

            const btn = document.querySelector('button[onclick="adminWipeDB()"]');
            const originalText = btn.innerText;
            btn.innerText = "Wiping Database...";
            btn.disabled = true;

            try {
                // 1. Delete All Users Config
                const users = await db.collection('users').get();
                const userBatch = db.batch();
                users.forEach(doc => userBatch.delete(doc.ref));
                await userBatch.commit();
                console.log("Users wiped.");

                // 2. Delete All Posts
                const posts = await db.collection('posts').get();
                const postBatch = db.batch();
                posts.forEach(doc => postBatch.delete(doc.ref));
                await postBatch.commit();
                console.log("Posts wiped.");

                // 3. Delete All Chats
                const chats = await db.collection('chats').get();
                const chatBatch = db.batch();
                chats.forEach(doc => chatBatch.delete(doc.ref));
                await chatBatch.commit();
                console.log("Chats wiped.");

                // 4. Delete Requests
                const reqs = await db.collection('connection_requests').get();
                const reqBatch = db.batch();
                reqs.forEach(doc => reqBatch.delete(doc.ref));
                await reqBatch.commit();
                console.log("Requests wiped.");

                alert("Database Wiped Clean. You can now register fresh accounts.");
                window.location.reload();

            } catch (e) {
                console.error(e);
                alert("Error wiping DB: " + e.message);
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        function deleteChat(chatId, event) {
            event.stopPropagation();
            if (confirm("Are you sure you want to delete this conversation?")) {
                db.collection('chats').doc(chatId).delete().then(() => {
                    loadChats();
                    if (document.getElementById('selectedChatId').value === chatId) {
                        document.getElementById('chatHeader').textContent = "Select a chat to begin.";
                        document.getElementById('messagesContainer').innerHTML = "";
                        document.getElementById('sendMessageForm').classList.add('hidden');
                    }
                });
            }
        }



        function handleSendMessage(e) {
            e.preventDefault();
            const text = document.getElementById('messageText').value.trim();
            const chatId = document.getElementById('selectedChatId').value;
            if (!text) return;
            db.collection('chats').doc(chatId).collection('messages').add({ text, senderId: currentUser.uid, timestamp: new Date() });
            db.collection('chats').doc(chatId).update({ lastMessage: text, updatedAt: new Date() });
            document.getElementById('messageText').value = '';
        }

        // --- GLOBAL FILTER STATE ---
        window.activeFilters = {
            sortBy: 'latest', // 'latest' or 'upvotes'
            years: [],        // ['FE', 'TE'] etc
            tags: []          // ['Sports', 'Technical'] etc
        };

        // --- 1. LOAD COMMUNITY (Now respects filters) ---
        async function loadCommunity() {
            const listEl = document.getElementById('communityPostsList');
            if (!listEl) return;
            if (!currentUser) return;

            if (listEl.innerHTML.trim() === '' || listEl.textContent.includes('No posts')) {
                listEl.innerHTML = '<p style="text-align:center; color:var(--text-secondary); margin-top:20px;">Loading posts...</p>';
            }

            try {
                // 1. Get Posts
                const snap = await db.collection('posts').orderBy('createdAt', 'desc').limit(50).get();
                let posts = snap.docs.map(doc => ({ ...doc.data(), id: doc.id }));

                // --- FILTERS & SORTING (Keep your existing logic) ---
                if (window.activeFilters.years.length > 0) {
                    posts = posts.filter(p => window.activeFilters.years.includes(p.authorYear));
                }
                if (window.activeFilters.tags.length > 0) {
                    posts = posts.filter(p => {
                        if (!p.tags) return false;
                        return p.tags.some(t => window.activeFilters.tags.includes(t.name));
                    });
                }
                if (window.activeFilters.sortBy === 'upvotes') {
                    posts.sort((a, b) => (b.upvotes || 0) - (a.upvotes || 0));
                } else {
                    posts.sort((a, b) => b.createdAt - a.createdAt);
                }

                // 2. Render Posts
                if (posts.length === 0) {
                    listEl.innerHTML = `<p style="text-align:center; color:var(--text-secondary); margin-top:30px;">No posts found.</p>`;
                    return;
                }

                // We map to Promises to handle the async "Top Comment" fetch
                const htmlPromises = posts.map(async p => {
                    const isAuthor = currentUser && p.authorId === currentUser.uid;

                    // --- VISUAL OVERRIDE: If I am the author, use my FRESH session data ---
                    const displayPic = isAuthor && !window.currentUserData.isAnonymousSession ? (window.currentUserData.profilePic || "") : (p.authorPic || "");
                    const displayName = isAuthor && !window.currentUserData.isAnonymousSession ? window.currentUserData.name : p.authorName;
                    const displayRole = isAuthor && !window.currentUserData.isAnonymousSession ? (window.currentUserData.role || "Student") : (p.authorRole || "Student");
                    const displayYear = isAuthor && !window.currentUserData.isAnonymousSession ? (window.currentUserData.year || "") : (p.authorYear || "");
                    // ----------------------------------------------------------------------

                    const yearBadge = getYearBadgeHtml(displayYear);
                    const timeString = timeAgo(p.createdAt);

                    // ... (Tags logic stays same) ...
                    let tagsHtml = '';
                    if (p.tags) p.tags.forEach(tag => {
                        tagsHtml += `<span style="background:${tag.hex || '#555'}; color:white; padding:2px 8px; border-radius:10px; font-size:10px; font-weight:700; margin-right:5px;">${tag.name}</span>`;
                    });

                    // ... (Media Logic stays same) ...
                    let mediaHtml = '';
                    if (p.imageUrl) {
                        if (p.mediaType === 'video') mediaHtml = `<video src="${p.imageUrl}" controls class="post-image" onclick="event.stopPropagation()"></video>`;
                        else mediaHtml = `<img src="${p.imageUrl}" ; loading="lazy"; class="post-image" onclick="event.stopPropagation(); openLightbox(this.src)">`;
                    }
                    const processedBody = p.body.replace(/(https?:\/\/[^\s]+)/g, (url) => `<a href="${url}" target="_blank" style="color:var(--primary-color); text-decoration:underline;">${url}</a>`);

                    // Avatar Logic using overridden 'displayPic'
                    let avatarHtml = displayPic && displayName !== "Anonymous"
                        ? `<img src="${displayPic}"; loading="lazy"; class="post-avatar-small">`
                        : `<div class="post-avatar-small" style="background:#333; display:flex; align-items:center; justify-content:center; color:#ccc; font-weight:bold;">${displayName.charAt(0)}</div>`;

                    // ... (Top Comment Preview logic stays same) ...
                    let topCommentHtml = '';
                    try {
                        const cSnap = await db.collection('posts').doc(p.id).collection('comments').orderBy('upvotes', 'desc').limit(1).get();
                        if (!cSnap.empty) {
                            const c = cSnap.docs[0].data();
                            topCommentHtml = `
                            <div class="top-comment-preview" onclick="viewPost('${p.id}')">
                                <div style="font-weight:bold; color:var(--text-main); font-size:12px; margin-bottom:2px;">
                                    ${c.authorName} <span style="font-weight:normal; color:var(--text-secondary);">commented:</span>
                                </div>
                                <div style="color:#ccc; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">"${c.text}"</div>
                            </div>`;
                        }
                    } catch (e) { }

                    return `
                    <div class="card" style="position: relative;">
                        <div class="post-options-wrapper">
                            <div class="three-dots-btn" onclick="togglePostMenu(event, '${p.id}')">â‹®</div>
                            <div id="menu-${p.id}" class="options-menu">
                                <div class="menu-item danger" onclick="reportPost(event, '${p.id}')">Report</div>
                                ${isAuthor ? `<div class="menu-item danger" onclick="deletePost('${p.id}')">Delete</div>` : ''}
                            </div>
                        </div>

                        <div style="cursor:pointer;" onclick="viewPost('${p.id}')">
                            <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px; padding-bottom:12px; border-bottom:1px solid rgba(255,255,255,0.05); padding-right: 30px;">
                                ${avatarHtml}
                                <div>
                                    <div style="color:var(--text-main); font-weight:700; font-size:15px; line-height:1.2;">
                                        ${displayName} <span class="badge badge-verified" style="font-size:9px;">${displayRole}</span>
                                    </div>
                                    <div style="color:var(--text-secondary); font-size:12px;">${yearBadge} â€¢ ${timeString}</div>
                                </div>
                            </div>
                            <div style="margin-bottom:8px;">
                                <div style="font-size:17px; font-weight:700; margin-bottom:6px;">${p.title}</div>
                                <div>${tagsHtml}</div>
                            </div>
                            <div class="card-body" style="white-space: pre-wrap; margin-top:0;">${processedBody}${mediaHtml}</div>
                            
                            ${topCommentHtml}
                        </div>

                        <div class="card-footer" style="justify-content: flex-end; margin-top:15px;">
                            <div style="display:flex; gap:10px;">
                                <button class="btn btn-secondary" onclick="viewPost('${p.id}')">Comment</button>
                                <button class="btn ${currentUser && (p.upvoters || []).includes(currentUser.uid) ? 'btn-primary' : 'btn-secondary'}" onclick="handleUpvote(event, '${p.id}')">â†‘ ${p.upvotes || 0}</button>
                            </div>
                        </div>
                    </div>`;
                });

                const finalHtml = await Promise.all(htmlPromises);
                listEl.innerHTML = finalHtml.join('');

            } catch (e) {
                console.error(e);
                listEl.innerHTML = '<p style="text-align:center; color:var(--danger-color);">Error loading posts.</p>';
            }
        }

        // --- 2. FILTER & SORT UI LOGIC ---
        // --- FIXED UPVOTE HANDLER ---
        window.handleUpvote = function (event, postId) {
            event.stopPropagation(); // Prevent opening the post details

            // 1. Anon Check
            if (window.currentUserData && window.currentUserData.isAnonymousSession) {
                if (typeof showToast === 'function') showToast("Restricted: Cannot upvote as Anonymous.");
                else alert("Restricted.");
                return;
            }

            const btn = event.currentTarget;
            const isUpvoted = btn.classList.contains('btn-primary');
            const ref = db.collection('posts').doc(postId);

            // 2. UI Update (Immediate Visual Feedback)
            // Extract the current number from text "â†‘ 5" -> 5
            let count = parseInt(btn.innerText.replace(/\D/g, '')) || 0;

            if (isUpvoted) {
                // Remove Upvote
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
                btn.innerText = `â†‘ ${Math.max(0, count - 1)}`;

                // DB Update (Background)
                ref.update({
                    upvotes: firebase.firestore.FieldValue.increment(-1),
                    upvoters: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
                });
            } else {
                // Add Upvote
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-primary');
                btn.innerText = `â†‘ ${count + 1}`;

                // DB Update (Background)
                ref.update({
                    upvotes: firebase.firestore.FieldValue.increment(1),
                    upvoters: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                });
            }
        };

        function openSortModal() {
            lockScroll();
            const modal = document.getElementById('sortFilterModal');

            // --- ADD CLOSE BUTTON ---
            const header = modal.querySelector('.modal-header');
            if (header && !header.querySelector('.close-modal-btn')) {
                header.style.display = "flex";
                header.style.justifyContent = "space-between";
                header.style.alignItems = "center";
                header.innerHTML = `
                    <span>Sort & Filter</span>
                    <span class="close-modal-btn" onclick="closeModal('sortFilterModal')"style="font-size:24px; cursor:pointer; padding:0 10px;">&times;</span>
                `;
            }
            // ------------------------

            modal.classList.add('active');
            renderFilterTags();
            updateFilterUI();
        }
        // --- GLOBAL MODAL CLOSER (FIXES SCROLL LOCK) ---
        window.closeModal = function (modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
            }
            unlockScroll(); // <--- CRITICAL: Unlocks the body
        };
        // --- SYNC PROFILE CHANGES TO OLD POSTS ---
        // --- SYNC PROFILE CHANGES TO OLD POSTS ---
        async function syncUserProfileToContent() {
            if (!currentUser) return;

            const uData = window.currentUserData;

            // Prepare the up-to-date data object
            const updates = {
                authorName: uData.name,
                authorPic: uData.profilePic || "",
                authorRole: uData.role || "Student",
                authorYear: uData.year || "",
                // NEW: Sync the theme color too
                authorColor: uData.themeColor || "#FF5722"
            };

            console.log("Syncing profile to old posts...");

            try {
                // 1. Find all my posts
                const postsSnap = await db.collection('posts').where('authorId', '==', currentUser.uid).get();

                // 2. Batch update them (batches allow 500 ops at once)
                const batch = db.batch();
                postsSnap.forEach(doc => {
                    batch.update(doc.ref, updates);
                });

                await batch.commit();
                console.log("Old posts updated.");

            } catch (e) {
                console.error("Sync error:", e);
            }
        }

        // Update uploadProfilePic to close modal on success
        const originalUpload = window.uploadProfilePic; // Save ref if exists logic is complex

        // Overwrite slightly to close modal
        window.uploadProfilePic = function () {
            const fileInput = document.getElementById('fileInput');
            if (fileInput.files.length === 0) return;
            const file = fileInput.files[0];
            if (file.size > 2 * 1024 * 1024) return alert("File too large.");

            const reader = new FileReader();
            reader.onload = function (e) {
                const newPic = e.target.result;
                db.collection('users').doc(currentUser.uid).update({ profilePic: newPic, updatedAt: new Date() })
                    .then(() => {
                        if (window.currentUserData) window.currentUserData.profilePic = newPic;
                        document.getElementById('profilePicModal').classList.remove('active');

                        loadProfile();
                        updateUserInfo();

                        // TRIGGER SYNC
                        syncUserProfileToContent();

                        showToast("Profile Picture Updated");
                    });
            };
            reader.readAsDataURL(file);
        };

        // Update removeProfilePic to close modal
        window.removeProfilePic = function () {
            if (!confirm("Remove current photo?")) return;

            db.collection('users').doc(currentUser.uid).update({ profilePic: "" })
                .then(() => {
                    if (window.currentUserData) window.currentUserData.profilePic = "";
                    document.getElementById('profilePicModal').classList.remove('active');

                    loadProfile();
                    updateUserInfo();

                    // TRIGGER SYNC
                    syncUserProfileToContent();

                    showToast("Photo Removed");
                });
        };

        function applyFilters() {
            document.getElementById('sortFilterModal').classList.remove('active');
            loadCommunity(); // Reloads posts with new filters applied
        }
        function applyTheme(color) {
            document.documentElement.style.setProperty('--primary-color', color);
            // Add other variables if needed
        }

        function clearAllFilters() {
            // 1. Reset the global filter state
            window.activeFilters = { sortBy: 'latest', years: [], tags: [] };

            // 2. Reset the visual "pills" inside the Sort Modal
            // (This ensures next time you open the menu, nothing is highlighted)
            if (typeof updateFilterUI === "function") updateFilterUI();
            if (typeof renderFilterTags === "function") renderFilterTags();

            // 3. IMPORTANT: Actually reload the feed to show posts again
            loadCommunity();
        }

        function toggleSort(type) {
            window.activeFilters.sortBy = type;
            updateFilterUI();
        }

        function toggleFilter(type, value) {
            const list = type === 'year' ? window.activeFilters.years : window.activeFilters.tags;
            const index = list.indexOf(value);

            if (index > -1) list.splice(index, 1); // Remove
            else list.push(value); // Add

            updateFilterUI();
            if (type === 'tag') renderFilterTags(); // Re-render tag visuals
        }

        function updateFilterUI() {
            // 1. Update Sort Buttons
            document.getElementById('sortBtn_latest').className = `filter-pill ${window.activeFilters.sortBy === 'latest' ? 'active' : ''}`;
            document.getElementById('sortBtn_upvotes').className = `filter-pill ${window.activeFilters.sortBy === 'upvotes' ? 'active' : ''}`;

            // 2. Update Year Buttons
            ['FE', 'SE', 'TE', 'BE'].forEach(y => {
                const btn = document.getElementById(`yearBtn_${y}`);
                if (btn) btn.className = `filter-pill ${window.activeFilters.years.includes(y) ? 'active' : ''}`;
            });
        }

        function renderFilterTags() {
            const container = document.getElementById('filterTagsContainer');
            if (!container) return;

            // Use global TAG_DATA to generate the list
            let html = '';
            TAG_DATA.forEach(tag => {
                const isActive = window.activeFilters.tags.includes(tag.name);
                const style = isActive
                    ? `background: ${tag.hex}; color: white; border-color: ${tag.hex};`
                    : `border-left: 3px solid ${tag.hex};`; // Visual hint of color when inactive

                html += `
            <div class="filter-pill ${isActive ? 'active' : ''}" 
                 onclick="toggleFilter('tag', '${tag.name}')"
                 style="${style}">
                ${tag.name}
            </div>
        `;
            });
            container.innerHTML = html;
        }

        function loadPosts() { loadCommunity(); } // Alias for cleaner calls

        // --- MISSING FUNCTION: OPEN POST MODAL ---

        /* =========================================
   FIXED POST SUBMIT HANDLER (Prevents Freezing)
   ========================================= */
        /* =========================================
   FIXED POST SUBMIT HANDLER (With Anonymous Logic)
   ========================================= */
        /* =========================================
           FIXED POST SUBMIT HANDLER
           ========================================= */
        window.handleCreatePostSubmit = async function (e) {
            e.preventDefault();
            const submitBtn = document.getElementById('submitPostBtn');
            const originalText = submitBtn.innerText;

            submitBtn.disabled = true;
            submitBtn.innerText = "Publishing...";

            try {
                if (!window.currentUser || !window.currentUserData) {
                    throw new Error("You must be logged in to post.");
                }

                const titleEl = document.getElementById('communityPostTitle');
                const bodyEl = document.getElementById('communityPostBody');
                const fileEl = document.getElementById('postFileInput');

                const title = titleEl ? titleEl.value : "Untitled";
                const body = bodyEl ? bodyEl.value : "";

                // Prepare Tags
                const safeTags = window.selectedTags || [];
                const finalTags = safeTags.map(t => ({
                    name: t.text,
                    color: t.colorClass,
                    hex: t.hex
                }));

                let fileUrl = "";
                let mediaType = "image";

                // --- NEW UPLOAD LOGIC ---
                if (fileEl && fileEl.files.length > 0) {
                    const file = fileEl.files[0];
                    mediaType = file.type.startsWith('video/') ? 'video' : 'image';

                    submitBtn.innerText = "Uploading Media...";
                    // Upload to Firebase Storage
                    fileUrl = await uploadFileToStorage(file);
                }
                // ------------------------

                const isAnon = window.currentUserData.isAnonymousSession;
                const currentYear = isAnon ? window.currentUserData.realYear : window.currentUserData.year;

                await db.collection('posts').add({
                    title: title,
                    body: body,
                    tags: finalTags,
                    imageUrl: fileUrl, // Now stores a short URL (e.g. https://firebasestorage...)
                    mediaType: mediaType,

                    authorId: window.currentUser.uid,
                    authorName: isAnon ? "Anonymous" : (window.currentUserData.name || "Anonymous"),
                    authorRole: isAnon ? "Guest" : (window.currentUserData.role || "Student"),
                    authorYear: currentYear || "",
                    authorPic: isAnon ? "" : (window.currentUserData.profilePic || ""),

                    upvotes: 0,
                    upvoters: [],
                    createdAt: new Date(),
                    // Initialize empty fields to prevent errors later
                    linkUrl: "",
                    reportCount: 0,
                    reports: []
                });

                console.log("Post saved successfully!");

                // Cleanup
                const modal = document.getElementById('createPostModal');
                if (modal) modal.classList.remove('active');
                closeModal('createPostModal');
                if (titleEl) titleEl.value = "";
                if (bodyEl) bodyEl.value = "";
                if (window.removePostImage) window.removePostImage();
                window.selectedTags = [];
                if (window.renderTagsOnMainForm) window.renderTagsOnMainForm();
                if (window.loadCommunity) window.loadCommunity();

                submitBtn.disabled = false;
                submitBtn.innerText = "Post";

            } catch (error) {
                console.error("POST ERROR:", error);
                alert("Failed to post: " + error.message);
                submitBtn.disabled = false;
                submitBtn.innerText = originalText;
            }
        };

        function deletePost(postId) {
            showConfirm(
                "Delete Post?",
                "This post will be permanently removed from the community.",
                () => {
                    db.collection('posts').doc(postId).delete().then(() => loadCommunity());
                }
            );
        }

        function viewPost(id) {
            document.getElementById('currentPostId').value = id;
            db.collection('posts').doc(id).get().then(doc => {
                const p = doc.data();

                // --- NEW: Auto-Linkify for Modal View ---
                const processedBody = p.body.replace(/(https?:\/\/[^\s]+)/g, (url) => {
                    return `<a href="${url}" target="_blank" style="color:var(--primary-color); text-decoration:underline;">${url}</a>`;
                });

                document.getElementById('postDetailTitle').textContent = p.title;
                // Use processedBody here
                document.getElementById('postDetailBody').innerHTML = `
            <p style="white-space: pre-wrap;">${processedBody}</p>
            ${p.linkUrl ? `<a href="${p.linkUrl}" target="_blank" class="post-link" style="margin-top:10px; display:inline-block;">ðŸ”— ${p.linkUrl}</a>` : ''}
            <small style="color: #666; display:block; margin-top:10px;">By ${p.authorName}</small>
        `;

                loadComments(id);
                document.getElementById('postDetailModal').classList.add('active');
            });
        }

        function loadComments(postId) {
            const list = document.getElementById('commentsList');
            list.innerHTML = '<p style="color:var(--text-secondary);">Loading...</p>';

            // 1. Fetch Post (to get goatedCommentId + authorId) AND Comments
            const postPromise = db.collection('posts').doc(postId).get();
            const commentsPromise = db.collection('posts').doc(postId).collection('comments')
                .orderBy('timestamp', 'asc')
                .get();

            Promise.all([postPromise, commentsPromise]).then(([postSnap, commentsSnap]) => {
                if (!postSnap.exists) {
                    list.innerHTML = "<p>Post not found.</p>";
                    return;
                }

                const postData = postSnap.data();
                postData.id = postSnap.id; // Ensure ID is attached

                // Map comments
                let comments = commentsSnap.docs.map(d => ({ ...d.data(), id: d.id }));

                // 2. Render with knowledge of the Post (for permissions & pinning)
                renderThreadedComments(comments, list, postData);

            }).catch(err => console.error("Error loading comments:", err));
        }

        // --- RECURSIVE THREAD RENDERER ---
        function renderThreadedComments(comments, container, postData) {
            container.innerHTML = '';

            // 1. Organize into Parent/Child Map
            const commentMap = {};
            const roots = [];

            comments.forEach(c => {
                commentMap[c.id] = c;
                c.children = []; // Init children array
            });

            comments.forEach(c => {
                if (c.parentId && commentMap[c.parentId]) {
                    commentMap[c.parentId].children.push(c);
                } else {
                    roots.push(c);
                }
            });

            // 2. SORT: Move GOATed comment to the very top (Pinning)
            roots.sort((a, b) => {
                if (a.id === postData.goatedCommentId) return -1; // Move GOAT up
                if (b.id === postData.goatedCommentId) return 1;
                return 0; // Keep timestamp order for others
            });

            // 3. Recursive Render Function
            function createCommentNode(comment, level = 0) {
                const isGoated = (comment.id === postData.goatedCommentId);
                const isPostAuthor = (currentUser && currentUser.uid === postData.authorId);
                const isMentor = (comment.authorRole && comment.authorRole !== 'Student');

                const wrapper = document.createElement('div');
                // Add left margin for nesting
                wrapper.style.marginLeft = level > 0 ? (level * 20) + 'px' : '0';
                if (level > 0) wrapper.style.borderLeft = "2px solid var(--border-color)";

                // --- BADGE HTML ---
                let badgeHTML = '';
                if (isGoated) {
                    badgeHTML = `
            <div class="goat-badge-container">
                <svg viewBox="0 0 24 24" fill="currentColor" class="goat-icon-svg">
                    <path d="M12,2L14.5,8H19.5L15.5,11L17,16.5L12,13.5L7,16.5L8.5,11L4.5,8H9.5L12,2Z"/> 
                </svg>
                <span>GOATed Answer</span>
            </div>`;
                }

                // --- GOAT BUTTON (Only for Post Author on Mentor comments) ---
                let goatBtn = '';
                if (isPostAuthor && isMentor && level === 0) { // Usually only top-level answers get GOATed
                    goatBtn = `
            <button onclick="toggleGoatStatus('${postData.id}', '${comment.id}')" 
                class="btn btn-sm" 
                style="margin-left:auto; font-size:10px; border:1px solid #FFD700; color:#FFD700; background:transparent;">
                ${isGoated ? 'Remove GOAT' : 'ðŸ† Mark GOAT'}
            </button>`;
                }

                wrapper.innerHTML = `
            <div class="card comment-card ${isGoated ? 'is-goated' : ''}" style="margin-bottom:10px; padding:12px; position:relative;">
                ${badgeHTML}
                <div style="display:flex; gap:10px; align-items:start;">
                    <img src="${comment.authorPic || 'default_avatar.png'}" style="width:32px; height:32px; border-radius:50%; object-fit:cover;">
                    <div style="width:100%;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <strong style="font-size:13px;">${comment.authorName}</strong>
                                <span style="font-size:11px; opacity:0.7;">â€¢ ${comment.authorRole || 'Student'}</span>
                            </div>
                            ${goatBtn}
                        </div>
                        <p style="margin:4px 0; font-size:14px; line-height:1.4;">${comment.text}</p>
                        
                        <div style="display:flex; gap:10px; margin-top:5px;">
                            <button onclick="openReplyBox('${postData.id}', '${comment.id}')" style="background:none; border:none; color:var(--text-secondary); font-size:11px; cursor:pointer;">Reply</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="reply-box-${comment.id}"></div>
        `;

                container.appendChild(wrapper);

                // Render Children recursively
                if (comment.children.length > 0) {
                    comment.children.forEach(child => createCommentNode(child, level + 1));
                }
            }

            // Run the renderer
            roots.forEach(root => createCommentNode(root));
        }
        /* --- REPLY LOGIC --- */

        // 1. Open/Close the Reply Input Box
        function openReplyBox(postId, commentId) {
            const container = document.getElementById(`reply-box-${commentId}`);
            if (!container) return;

            // Toggle: If open, close it
            if (container.innerHTML !== '') {
                container.innerHTML = '';
                return;
            }

            // Render the Input Field
            container.innerHTML = `
        <div style="margin-top: 10px; margin-left: 20px; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 8px; border: 1px solid var(--border-color);">
            <textarea id="reply-input-${commentId}" 
                      placeholder="Write a reply..." 
                      rows="2" 
                      class="form-control" 
                      style="width:100%; resize:none; margin-bottom:10px; font-size:14px; background: transparent; color: var(--text-main); border: none; outline: none;"></textarea>
            
            <div style="display:flex; justify-content:flex-end; gap:10px;">
                <button onclick="document.getElementById('reply-box-${commentId}').innerHTML=''" 
                        class="btn btn-secondary btn-sm" 
                        style="font-size: 11px; padding: 4px 10px;">Cancel</button>
                <button onclick="submitReply('${postId}', '${commentId}')" 
                        class="btn btn-primary btn-sm"
                        style="font-size: 11px; padding: 4px 10px;">Reply</button>
            </div>
        </div>
    `;

            // Auto-focus the input
            setTimeout(() => document.getElementById(`reply-input-${commentId}`).focus(), 100);
        }

        // 2. Submit the Reply to Firestore
        function submitReply(postId, parentId) {
            const input = document.getElementById(`reply-input-${parentId}`);
            const text = input.value.trim();

            if (!text) return;
            if (!currentUser) {
                showToast("Please log in to reply.");
                return;
            }

            const replyData = {
                text: text,
                authorId: currentUser.uid,
                authorName: window.currentUserData.name || "User",
                authorRole: window.currentUserData.role || "Student",
                authorPic: window.currentUserData.profilePic || "",
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                parentId: parentId // <--- CRITICAL: Links this comment to its parent
            };

            // Save to Firestore
            db.collection('posts').doc(postId).collection('comments').add(replyData)
                .then(() => {
                    showToast("Reply sent!");
                    // Refresh comments to show the new reply
                    loadComments(postId);
                })
                .catch(err => {
                    console.error("Reply error:", err);
                    showToast("Failed to send reply.");
                });
        }

        function buildCommentNode(c, postId) {
            const isAuthor = currentUser && c.authorId === currentUser.uid;

            // --- VISUAL OVERRIDE FOR COMMENTS ---
            const displayPic = isAuthor && !window.currentUserData.isAnonymousSession ? (window.currentUserData.profilePic || "") : (c.authorPic || "");
            const displayName = isAuthor && !window.currentUserData.isAnonymousSession ? window.currentUserData.name : c.authorName;
            const displayRole = isAuthor && !window.currentUserData.isAnonymousSession ? (window.currentUserData.role || "Student") : (c.authorRole || "Student");
            const displayYear = isAuthor && !window.currentUserData.isAnonymousSession ? (window.currentUserData.year || "") : (c.authorYear || "");
            // ------------------------------------

            const yearBadge = getYearBadgeHtml(displayYear);
            const timeString = timeAgo(c.timestamp);

            let avatarHtml = displayPic
                ? `<img src="${displayPic}"; loading="lazy"; class="post-avatar-small" style="width:30px; height:30px; min-width:30px;">`
                : `<div class="post-avatar-small" style="width:30px; height:30px; min-width:30px; background:#333; display:flex; align-items:center; justify-content:center; font-weight:bold; color:#ccc;">${(displayName || "U").charAt(0)}</div>`;

            const hasChildren = c.children && c.children.length > 0;
            const childHtml = hasChildren
                ? `<div id="children-${c.id}" class="comment-children">${c.children.map(child => buildCommentNode(child, postId)).join('')}</div>`
                : `<div id="children-${c.id}" class="comment-children"></div>`;

            const toggleBtn = hasChildren
                ? `<span style="font-size:11px; color:var(--primary-color); cursor:pointer; margin-left:10px;" onclick="toggleChildren('${c.id}')">â–¼ View Replies (${c.children.length})</span>`
                : '';

            return `
            <div class="comment-thread-container" id="comment-${c.id}">
                ${hasChildren ? '<div class="comment-thread-line"></div>' : ''}

                <div style="display:flex; gap:10px; padding:10px 0;">
                    ${avatarHtml}
                    <div style="flex:1;">
                        <div style="display:flex; align-items:center; gap:6px; flex-wrap:wrap;">
                            <span style="color:var(--text-main); font-weight:700; font-size:13px;">${displayName}</span>
                            <span class="badge badge-verified" style="font-size:9px; padding:1px 4px;">${displayRole}</span>
                            ${yearBadge}
                            <span style="color:var(--text-secondary); font-size:11px;">â€¢ ${timeString}</span>
                        </div>

                        <div style="color:#ddd; font-size:14px; margin:4px 0 6px 0;">${c.text}</div>

                        <div style="display:flex; gap:12px; align-items:center;">
                            <button class="btn btn-secondary" style="padding:2px 8px; font-size:11px; height:auto; min-height:0;" 
                                onclick="handleCommentUpvote(event, '${postId}', '${c.id}')">â†‘ ${c.upvotes || 0}</button>
                            
                            <span style="font-size:11px; color:#aaa; cursor:pointer; font-weight:600;" 
                                onclick="showReplyBox('${c.id}')">Reply</span>

                            ${isAuthor ? `<span style="font-size:11px; color:#ff453a; cursor:pointer;" onclick="deleteComment('${postId}', '${c.id}')">Delete</span>` : ''}
                            
                            ${toggleBtn}
                        </div>

                        <div id="reply-box-${c.id}" class="reply-input-container">
                            <form onsubmit="handleNewComment(event, '${c.id}')" style="display:flex; gap:8px;">
                                <input id="reply-input-${c.id}" type="text" placeholder="Reply to ${displayName}..." 
                                    style="padding:8px; font-size:13px; border-radius:15px; border:1px solid #444; background:var(--bg-input); color:white; flex:1;">
                                <button type="submit" class="btn btn-primary" style="padding:5px 12px; font-size:12px;">Post</button>
                            </form>
                        </div>
                    </div>
                </div>
                ${childHtml}
            </div>`;
        }

        // --- HELPER FUNCTIONS FOR COMMENTS ---
        function toggleChildren(commentId) {
            const childContainer = document.getElementById(`children-${commentId}`);
            if (childContainer) {
                childContainer.classList.toggle('open');
            }
        }

        function showReplyBox(commentId) {
            // Close all other reply boxes first (optional UX choice)
            document.querySelectorAll('.reply-input-container').forEach(el => el.style.display = 'none');

            const box = document.getElementById(`reply-box-${commentId}`);
            if (box) {
                box.style.display = 'block';
                // Focus the input
                setTimeout(() => {
                    const input = document.getElementById(`reply-input-${commentId}`);
                    if (input) input.focus();
                }, 100);
            }
        }

        function handleCommentUpvote(event, postId, commentId) {
            event.preventDefault();
            const btn = event.currentTarget;
            const isUpvoted = btn.classList.contains('btn-primary');

            // 1. UI Update
            let rawText = btn.innerText; // e.g. "â†‘ (5)"
            let count = parseInt(rawText.replace(/\D/g, '')) || 0;

            if (isUpvoted) {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
                btn.innerText = `â†‘ (${Math.max(0, count - 1)})`;
            } else {
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-primary');
                btn.innerText = `â†‘ (${count + 1})`;
            }

            // 2. DB Update
            const ref = db.collection('posts').doc(postId).collection('comments').doc(commentId);
            if (isUpvoted) {
                ref.update({
                    upvotes: firebase.firestore.FieldValue.increment(-1),
                    upvoters: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
                });
            } else {
                ref.update({
                    upvotes: firebase.firestore.FieldValue.increment(1),
                    upvoters: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                });
            }
        }

        function deleteComment(postId, commentId) {
            showConfirm(
                "Delete Comment?",
                "Are you sure you want to remove this comment?",
                () => {
                    db.collection('posts').doc(postId).collection('comments').doc(commentId).delete()
                        .then(() => loadComments(postId));
                }
            );
        }
        function upvote(id) { const ref = db.collection('posts').doc(id); ref.get().then(doc => { if (doc.data().authorId === currentUser.uid) return alert("Cannot upvote self"); const upvoters = doc.data().upvoters || []; const hasUpvoted = upvoters.includes(currentUser.uid); ref.update({ upvotes: firebase.firestore.FieldValue.increment(hasUpvoted ? -1 : 1), upvoters: hasUpvoted ? upvoters.filter(x => x !== currentUser.uid) : [...upvoters, currentUser.uid] }).then(loadCommunity); }); }
        function upvoteComment(pid, cid) { const ref = db.collection('posts').doc(pid).collection('comments').doc(cid); ref.get().then(doc => { const data = doc.data(); if (data.authorId === currentUser.uid) return; const upvoters = data.upvoters || []; const hasUpvoted = upvoters.includes(currentUser.uid); ref.update({ upvotes: firebase.firestore.FieldValue.increment(hasUpvoted ? -1 : 1), upvoters: hasUpvoted ? upvoters.filter(id => id !== currentUser.uid) : [...upvoters, currentUser.uid] }).then(() => loadComments(pid)); }); }

        // --- PROFILE ---
        // --- PROFILE ---
        function loadProfile() {
            // 1. SAFETY CHECK
            if (!currentUser) return;

            // 2. ANONYMOUS CHECK
            if (window.currentUserData && window.currentUserData.isAnonymousSession) {
                const profileTab = document.getElementById('profile');
                const yearHtml = (typeof getYearBadgeHtml === 'function') ? getYearBadgeHtml(window.currentUserData.realYear) : "";

                profileTab.innerHTML = `
                    <div style="max-width: 500px; margin: 60px auto; text-align: center; padding: 40px; background: var(--bg-card); border-radius: 24px; border: 1px dashed var(--border-color);">
                        <div style="width: 120px; height: 120px; border-radius: 50%; background: #333; color: #666; display: flex; align-items: center; justify-content: center; font-size: 60px; font-weight: bold; border: 4px dashed #555; margin: 0 auto 25px;">?</div>
                        <h1 style="color: var(--text-main); margin-bottom: 10px;">Anonymous</h1>
                        <div style="margin-bottom: 20px;">${yearHtml}</div>
                        <p style="color: var(--text-secondary); margin-bottom: 30px; font-size: 14px; line-height: 1.6;">
                            You are in Anonymous mode.<br>Social features and profile editing are disabled.
                        </p>
                        <div style="display: flex; flex-direction: column; gap: 15px; align-items: center;">
                            <div class="sort-btn-style anon-exit-override" onclick="document.getElementById('exitAnonModal').classList.add('active')" style="background-color: var(--primary-color); box-shadow: 0 8px 50px rgba(10, 132, 255, 0.4);"> 
                                <span class="sort-btn-text" style="margin:0; padding:0 20px;">Exit Anonymous mode</span>
                            </div>
                            <div style="display:flex; gap:10px; margin-top:20px;">
                                <button class="btn btn-secondary" onclick="window.performLogout()">Logout</button>
                                <button class="btn btn-danger" onclick="deleteAccount()">Delete Account</button>
                            </div>
                        </div>
                    </div>`;
                return;
            }

            // 3. STANDARD USER LOGIC
            db.collection('users').doc(currentUser.uid).get().then(doc => {
                const dbData = doc.exists ? doc.data() : {};
                const data = { ...currentUserData, ...dbData };

                const rawName = data.name || "User";
                const displayName = rawName.charAt(0).toUpperCase() + rawName.slice(1);

                // Update Name
                const nameEl = document.getElementById('profileName');
                if (data.role === 'mentor' && data.isVerified) {
                    nameEl.innerHTML = `${displayName} <span style="color:#30D158; font-size:0.8em; vertical-align: middle;">âœ”</span>`;
                } else {
                    nameEl.textContent = displayName;
                }

                // Update Badge
                const badgeEl = document.getElementById('profileBadge');
                let badgeText = (data.role || 'student').toUpperCase();
                let badgeColor = 'var(--primary-color)';
                if (data.role === 'mentor') {
                    if (data.isVerified) { badgeText = "VERIFIED MENTOR"; badgeColor = "#30D158"; }
                    else { badgeText = "MENTOR"; badgeColor = "#636366"; }
                }
                badgeEl.textContent = badgeText;
                badgeEl.style.background = badgeColor;

                // --- FIXED: SIMPLE PROFILE PICTURE ---
                const wrapper = document.querySelector('.profile-pic-wrapper-new');
                if (wrapper) {
                    // Remove click events, make it static
                    wrapper.onclick = null;

                    const picUrl = data.profilePic;
                    if (picUrl) {
                        wrapper.innerHTML = `<img src="${picUrl}";loading="lazy"; class="profile-pic-large-new">`;
                    } else {
                        const initial = displayName.charAt(0).toUpperCase();
                        wrapper.innerHTML = `<div class="profile-initial-large-new">${initial}</div>`;
                    }
                }
                // -------------------------------------

                // Skills
                const skillsContainer = document.getElementById('skillsContainer');
                if (data.skills && data.skills.length > 0) {
                    skillsContainer.innerHTML = data.skills.map(skill => `<div class="skill-tag-new">${skill}</div>`).join('');
                } else {
                    skillsContainer.innerHTML = '<div class="empty-state-new">No skills added yet. Click Edit Profile to add your expertise.</div>';
                }

                // Info Section
                document.getElementById('profileEmail').textContent = data.email || 'email@example.com';
                document.getElementById('infoCollege').textContent = data.college || 'Not specified';

                const yearContainer = document.getElementById('infoYear');
                yearContainer.innerHTML = '';
                if (data.year && ['FE', 'SE', 'TE', 'BE'].includes(data.year)) {
                    if (typeof getYearBadgeHtml === 'function') yearContainer.innerHTML = getYearBadgeHtml(data.year);
                    else yearContainer.textContent = data.year;
                } else {
                    yearContainer.textContent = data.year || 'Not specified';
                }

                document.getElementById('infoRole').textContent = data.role ? data.role.charAt(0).toUpperCase() + data.role.slice(1) : 'Not specified';

                if (data.joinedDate) {
                    const dateObj = data.joinedDate.toDate ? data.joinedDate.toDate() : new Date(data.joinedDate);
                    document.getElementById('infoJoined').textContent = dateObj.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                }

                // Populate Edit Form
                document.getElementById('editName').value = data.name || '';
                document.getElementById('editCollege').value = data.college || '';
                document.getElementById('editYear').value = data.year || 'FE';
                document.getElementById('editSkills').value = (data.skills || []).join(', ');

            }).catch(e => {
                console.error("Profile load error:", e);
                document.getElementById('profileName').textContent = 'Error loading profile';
            });

            // Refresh Stats
            if (typeof updateProfileStats === 'function') updateProfileStats();
        }
        // --- MISSING FUNCTION FIX ---
        function updateProfileStats() {
            if (!currentUser) return;
            const uid = currentUser.uid;

            // 1. Count My Posts
            db.collection('posts').where('authorId', '==', uid).get()
                .then(snap => {
                    const el = document.getElementById('statPosts');
                    if (el) el.innerText = snap.size;
                })
                .catch(e => console.log("Error counting posts", e));

            // 2. Count Connections (Sent + Received)
            const sentPromise = db.collection('connection_requests').where('senderId', '==', uid).where('status', '==', 'accepted').get();
            const recPromise = db.collection('connection_requests').where('recipientId', '==', uid).where('status', '==', 'accepted').get();

            Promise.all([sentPromise, recPromise])
                .then(([sentSnap, recSnap]) => {
                    const total = sentSnap.size + recSnap.size;

                    const elConn = document.getElementById('statConnections');
                    if (elConn) elConn.innerText = total;

                    // For now, we'll set Mentors to 0 or you can implement specific mentor logic here
                    const elMentors = document.getElementById('statMentors');
                    if (elMentors) elMentors.innerText = 0;
                })
                .catch(e => console.log("Error counting connections", e));
        }

        // Function to handle the Exit password check
        function confirmExitAnon() {
            const inputPass = document.getElementById('exitAnonPassword').value;

            // We retrieve the real password stored in memory during login
            const realPass = window.currentUserData ? window.currentUserData.password : null;

            if (inputPass === realPass) {
                document.getElementById('exitAnonModal').classList.remove('active');
                showToast("ðŸ”“ Exiting Anonymous Mode");

                // Reload session as normal user (Pass 'false' for isAnon)
                simulateLogin(window.currentUser.uid, false);
            } else {
                alert("Incorrect Password. Cannot exit Anonymous mode.");
            }
        }

        function toggleEditMode() {
            const form = document.getElementById('editForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        function saveProfile() {
            const name = document.getElementById('editName').value.trim();
            const college = document.getElementById('editCollege').value.trim();
            const year = document.getElementById('editYear').value;
            const skillsInput = document.getElementById('editSkills').value.trim();
            const skills = skillsInput ? skillsInput.split(',').map(s => s.trim()).filter(s => s) : [];

            if (!name) return alert('Please enter your name');

            db.collection('users').doc(currentUser.uid).update({
                name: name,
                college: college,
                year: year,
                skills: skills,
                updatedAt: new Date()
            }).then(() => {
                // --- FIX: Update Global Memory ---
                if (window.currentUserData) {
                    window.currentUserData.name = name;
                    window.currentUserData.college = college;
                    window.currentUserData.year = year;
                    window.currentUserData.skills = skills;
                }
                // ---------------------------------

                alert('Profile updated successfully!');
                toggleEditMode();
                loadProfile();
                updateUserInfo();
                syncUserProfileToContent();
            }).catch(error => {
                console.error('Error saving profile:', error);
                alert('Error saving profile: ' + error.message);
            });
        }

        function shareProfile() {
            const url = window.location.href;
            if (navigator.share) {
                navigator.share({
                    title: document.getElementById('profileName').textContent,
                    text: `Check out my profile on VidyaGenie`,
                    url: url
                });
            } else {
                alert('Profile link: ' + url);
            }
        }

        function downloadResume() {
            alert('Resume download feature coming soon!');
        }

        function removeProfilePic() {
            showConfirm(
                "Remove Photo?",
                "Are you sure you want to remove your profile picture?",
                () => {
                    db.collection('users').doc(currentUser.uid).update({ profilePic: "" })
                        .then(() => {
                            // --- FIX: Clear Global Memory Immediately ---
                            if (window.currentUserData) {
                                window.currentUserData.profilePic = "";
                            }
                            // --------------------------------------------
                            loadProfile();
                            updateUserInfo();
                        });
                }
            );
        }
        function handleFileSelect() { const fileInput = document.getElementById('fileInput'); if (fileInput.files.length > 0) document.getElementById('fileNameDisplay').textContent = fileInput.files[0].name; }
        function uploadProfilePic() {
            const fileInput = document.getElementById('fileInput');
            if (fileInput.files.length === 0) return alert("Choose photo first.");

            const file = fileInput.files[0];
            if (file.size > 2 * 1024 * 1024) return alert("File too large (Max 2MB)."); // Increased limit slightly

            const reader = new FileReader();
            reader.onload = function (e) {
                const newPic = e.target.result;

                db.collection('users').doc(currentUser.uid).set({ profilePic: newPic }, { merge: true })
                    .then(() => {
                        // --- FIX: Update Global Memory Immediately ---
                        if (window.currentUserData) {
                            window.currentUserData.profilePic = newPic;
                        }
                        // ---------------------------------------------

                        alert("Updated!");
                        loadProfile();
                        updateUserInfo();
                    })
                    .catch(err => console.error(err));
            };
            reader.readAsDataURL(file);
        }
        // --- UNSEND & CHAT FUNCTIONS ---

        // 1. Global listener variable (Only declare this ONCE in your code)
        let msgUnsub;

        // 2. The Delete Function
        function deleteMessage(chatId, messageId) {
            showConfirm(
                "Unsend Message?",
                "This message will be removed for everyone in the chat.",
                () => {
                    db.collection('chats').doc(chatId).collection('messages').doc(messageId).delete()
                        .then(() => console.log("Message unsent"))
                        .catch(error => console.error("Error removing message: ", error));
                }
            );
        }

        // 3. The Chat Function
        // --- 4. OPEN CHAT (With "Last Active" Header) ---
        function openInlineChat(chatId, otherUserId, name) {
            if (window.innerWidth <= 600) {
                lockScroll();
            }
            if (msgUnsub) msgUnsub();

            document.getElementById('selectedChatId').value = chatId;

            // Trigger Mobile View
            document.getElementById('chats').classList.add('mobile-chat-open');
            if (window.innerWidth <= 600) {
                document.querySelector('.tabs').style.display = 'none';
            }

            // --- HEADER UPDATE START ---
            const headerInfo = document.getElementById('chatHeaderInfo');

            // 1. Set Initial Header with Placeholder (Initials)
            // This ensures something shows up immediately while the real image loads
            headerInfo.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div id="headerAvatarStub" style="width: 38px; height: 38px; min-width: 38px; border-radius: 50%; background: #333; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; border: 1px solid var(--glass-border);">
                        ${name.charAt(0).toUpperCase()}
                    </div>
                    <div style="line-height: 1.3;">
                        <div style="font-size: 16px; font-weight: 700; color: var(--text-main);">${name}</div>
                        <div id="headerStatus" style="font-size: 12px; color: var(--text-secondary);">Connecting...</div>
                    </div>
                </div>`;
            // --- HEADER UPDATE END ---

            document.getElementById('sendMessageForm').classList.remove('hidden');
            const cont = document.getElementById('messagesContainer');
            cont.innerHTML = '<p style="text-align:center; color:var(--text-secondary); margin-top:20px;">Loading...</p>';

            // 1. Fetch User Data (Pic & Status)
            let otherUserPic = "";
            let otherUserInitial = name.charAt(0).toUpperCase();

            db.collection('users').doc(otherUserId).get().then(doc => {
                if (doc.exists) {
                    const u = doc.data();
                    otherUserPic = u.profilePic || "";

                    // --- NEW: Update Header Avatar if image exists ---
                    if (otherUserPic) {
                        const stub = document.getElementById('headerAvatarStub');
                        if (stub) {
                            // Replace the placeholder div with an IMG tag
                            stub.outerHTML = `<img src="${otherUserPic}" style="width: 38px; height: 38px; min-width: 38px; border-radius: 50%; object-fit: cover; border: 1px solid var(--glass-border);" loading="lazy">`;
                        }
                    }

                    // Update Status Text
                    const statusText = formatLastActive(u.lastSeen);
                    const statusColor = statusText === 'Active now' ? '#30D158' : 'var(--text-secondary)';
                    const statusEl = document.getElementById('headerStatus');
                    if (statusEl) {
                        statusEl.innerText = statusText;
                        statusEl.style.color = statusColor;
                    }
                }

                // 2. Start Message Listener
                msgUnsub = db.collection('chats').doc(chatId).collection('messages')
                    .orderBy('timestamp', 'asc')
                    .onSnapshot(snap => {
                        if (snap.empty) {
                            cont.innerHTML = '<p style="text-align:center; color:var(--text-secondary); margin-top:20px;">Say hello! ðŸ‘‹</p>';
                            return;
                        }

                        let html = '';
                        snap.forEach(doc => {
                            const m = doc.data();
                            if (!currentUser) return;
                            const me = m.senderId === currentUser.uid;

                            // Content Logic
                            let content = '';
                            if (m.imageUrl) {
                                if (m.mediaType === 'video') content = `<video src="${m.imageUrl}" controls class="chat-image" onclick="event.stopPropagation()"></video>`;
                                else content = `<img src="${m.imageUrl}" class="chat-image" onclick="event.stopPropagation(); openLightbox(this.src)">`;
                            } else {
                                content = `<span>${m.text}</span>`;
                            }

                            // Avatar Logic (For Bubble Rows)
                            let avatarHtml = '';
                            if (!me) {
                                if (otherUserPic) {
                                    avatarHtml = `<img src="${otherUserPic}" class="chat-msg-avatar" loading="lazy">`;
                                } else {
                                    avatarHtml = `<div class="chat-msg-placeholder">${otherUserInitial}</div>`;
                                }
                            }

                            let events = me ? `
                                oncontextmenu="showContextMenu(event, 'message', '${chatId}', '${doc.id}')"
                                ontouchstart="startLongPress(event, 'message', '${chatId}', '${doc.id}')"
                                ontouchend="cancelLongPress()"
                                ontouchmove="cancelLongPress()"
                            ` : '';

                            html += `
                            <div class="chat-message-row ${me ? 'me' : 'them'}">
                                ${avatarHtml}
                                <div class="msg-bubble ${me ? 'msg-me' : 'msg-them'}" ${events} style="user-select: none;">
                                    ${content}
                                </div>
                            </div>`;
                        });

                        cont.innerHTML = html;
                        cont.scrollTop = cont.scrollHeight;
                    });
            });
        }
        function closeChatView() {
            unlockScroll();
            document.getElementById('chats').classList.remove('mobile-chat-open');

            // SHOW BOTTOM TABS AGAIN
            if (window.innerWidth <= 600) {
                document.querySelector('.tabs').style.display = 'flex';
            }
        }
        // --- ENABLE ENTER TO SEND (Shift+Enter for New Line) ---
        function setupEnterKeySubmits() {

            // Helper to handle the logic
            const addEnterListener = (elementId, actionFunction) => {
                const el = document.getElementById(elementId);
                if (el) {
                    el.addEventListener('keydown', function (e) {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault(); // Stop default (New Line)
                            actionFunction(e);  // Trigger Send
                        }
                    });
                }
            };

            // 1. CHAT MESSAGES
            addEnterListener('messageText', handleSendMessage);

            // 2. COMMENTS
            addEnterListener('commentText', handleNewComment);

            // 3. CREATE POST BODY
            // For the post, we trigger the button click to run validation
            const postBody = document.getElementById('communityPostBody');
            if (postBody) {
                postBody.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        document.getElementById('submitPostBtn').click();
                    }
                });
            }
        }

        // --- 1. PRESENCE & TIME UTILS ---

        function startPresenceHeartbeat() {
            if (!currentUser) return;
            // Update immediately, then every 2 minutes
            const update = () => db.collection('users').doc(currentUser.uid).update({
                lastSeen: firebase.firestore.FieldValue.serverTimestamp()
            });
            update();
            setInterval(update, 120000);
        }

        function formatLastActive(timestamp) {
            if (!timestamp) return 'Offline';
            const date = timestamp.toDate();
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);

            if (diffMins < 5) return 'Active now';
            if (diffMins < 60) return `Active ${diffMins}m ago`;
            if (diffHours < 24) return `Active ${diffHours}h ago`;
            return `Last seen ${date.toLocaleDateString()}`;
        }


        /* =========================================
                   FIXED COMMENT HANDLER (Saves Profile Data)
                   ========================================= */
        window.handleNewComment = function (e, parentId = null) {
            e.preventDefault();

            // Determine logic based on if it's a Reply or a Root comment
            let text, inputId;
            if (parentId) {
                // It's a reply
                inputId = `reply-input-${parentId}`;
                text = document.getElementById(inputId).value.trim();
            } else {
                // It's a main comment
                inputId = 'commentText';
                text = document.getElementById(inputId).value.trim();
            }

            if (!text) return;

            // Anon Check
            if (window.currentUserData && window.currentUserData.isAnonymousSession) {
                if (typeof showToast === "function") showToast("Restricted: Cannot comment as Anonymous.");
                else alert("Restricted: Cannot comment as Anonymous.");
                return;
            }

            const postId = document.getElementById('currentPostId').value;
            const uData = window.currentUserData;

            // Save to Firestore with parentId field
            db.collection('posts').doc(postId).collection('comments').add({
                text: text,
                authorId: window.currentUser.uid,
                authorName: uData.name,
                authorPic: uData.profilePic || "",
                authorRole: uData.role || "Student",
                authorYear: uData.year || "",
                timestamp: new Date(),
                upvotes: 0,
                upvoters: [],
                parentId: parentId // Null for root, ID for child
            }).then(() => {
                document.getElementById(inputId).value = "";
                if (window.loadComments) window.loadComments(postId);
            }).catch(err => console.error(err));
        };

        // --- 2. FIX CRASH IN POST MODAL (Safety Checks) ---
        // --- 2. FIX CRASH IN POST MODAL (Safety Checks) ---
        window.openCreatePostModal = function () {
            lockScroll();
            const modal = document.getElementById('createPostModal');
            if (!modal) return;

            // --- ADD CLOSE BUTTON TO HEADER ---
            const header = modal.querySelector('.modal-header');
            if (header && !header.querySelector('.close-modal-btn')) {
                header.style.display = "flex";
                header.style.justifyContent = "space-between";
                header.style.alignItems = "center";
                header.innerHTML = `
                    <span>Create Post</span>
                    <span class="close-modal-btn" onclick="closeModal('createPostModal')" style="font-size:24px; cursor:pointer; padding:0 10px;">&times;</span>
                `;
            }
            // ----------------------------------

            modal.classList.add('active');

            // ... (Rest of your existing reset logic: clearing title, body, file, etc.) ...
            const titleEl = document.getElementById('communityPostTitle');
            if (titleEl) titleEl.value = "";
            const bodyEl = document.getElementById('communityPostBody');
            if (bodyEl) bodyEl.value = "";
            const fileEl = document.getElementById('postFileInput');
            if (fileEl) fileEl.value = "";
            const fileNameEl = document.getElementById('postFileName');
            if (fileNameEl) fileNameEl.innerText = "No file";
            const removeBtn = document.getElementById('removePostImgBtn');
            if (removeBtn) removeBtn.style.display = "none";
            const submitBtn = document.getElementById('submitPostBtn');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerText = "Post";
            }
        };

        // --- 3. FIX TAG MENU (Global Scope) ---
        window.openTagMenu = function () {
            console.log("Opening Tag Menu...");
            const modal = document.getElementById('tagSelectionModal');
            if (modal) {
                modal.classList.add('active');
                const searchInput = document.getElementById('tagSearchInput');
                if (searchInput) searchInput.value = "";

                // Ensure the render function exists before calling
                if (window.renderTagMenu) window.renderTagMenu();
            } else {
                console.error("Tag Modal missing");
            }
        };

        // --- 4. RE-INIT ENTER KEY LISTENERS (Safe Version) ---
        // --- ENABLE ENTER TO SEND (Shift+Enter for New Line) ---
        function setupEnterKeySubmits() {

            // 1. CHAT MESSAGES
            const chatInput = document.getElementById('messageText');
            if (chatInput) {
                const newChatInput = chatInput.cloneNode(true);
                chatInput.parentNode.replaceChild(newChatInput, chatInput);

                newChatInput.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        window.handleSendMessage(e);
                    }
                });
            }

            // 2. COMMENTS (The fix you requested)
            const commentInput = document.getElementById('commentText');
            if (commentInput) {
                // Clone to remove old listeners
                const newCommentInput = commentInput.cloneNode(true);
                commentInput.parentNode.replaceChild(newCommentInput, commentInput);

                newCommentInput.addEventListener('keydown', function (e) {
                    // IF Enter is pressed AND Shift is NOT held down
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault(); // Stop New Line
                        window.handleNewComment(e); // Trigger Submit
                    }
                    // Else: It does the default (adds a new line)
                });
            }

            // 3. CREATE POST BODY (Trigger Button Click)
            const postBody = document.getElementById('communityPostBody');
            if (postBody) {
                const newPostBody = postBody.cloneNode(true);
                postBody.parentNode.replaceChild(newPostBody, postBody);

                newPostBody.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        document.getElementById('submitPostBtn').click();
                    }
                });
            }
        }

        // Run setup immediately
        setupEnterKeySubmits();
        /* =========================================
    ROBUST TAG SYSTEM (Global Scope Fix)
    ========================================= */

        // 1. Initialize Global Variables
        window.selectedTags = window.selectedTags || [];



        // 3. Global Open/Close Functions
        window.openTagMenu = function () {
            console.log("Opening Tag Menu...");
            const modal = document.getElementById('tagSelectionModal');
            if (modal) {
                modal.classList.add('active');
                // Clear search
                const searchInput = document.getElementById('tagSearchInput');
                if (searchInput) searchInput.value = "";

                // Render
                window.renderTagMenu();
            } else {
                alert("Error: ID 'tagSelectionModal' not found in HTML.");
            }
        };

        window.closeTagMenu = function () {
            document.getElementById('tagSelectionModal').classList.remove('active');
            window.renderTagsOnMainForm();
        };

        window.filterTags = function () {
            window.renderTagMenu();
        };

        // 4. Main Render Function (With Error Catching)
        window.renderTagMenu = function () {
            const list = document.getElementById('tagListArea');
            const searchInput = document.getElementById('tagSearchInput');

            if (!list) return;

            const search = searchInput ? searchInput.value.toLowerCase().trim() : "";
            let html = '';

            TAG_DATA.forEach(tag => {
                if (search && !tag.name.toLowerCase().includes(search)) return;

                const isSelected = window.selectedTags.some(t => t.text === tag.name);
                const activeClass = isSelected ? 'selected' : '';
                const checkIcon = isSelected ? '<span style="color:#30D158; font-weight:bold; font-size:16px;">âœ”</span>' : '';
                const hasSub = tag.hasSub ? 'true' : 'false';

                // Render Main Tag Row
                html += `
            <div>
                <div class="tag-menu-item ${activeClass}" 
                     onclick="window.toggleMainTag('${tag.name}', '${tag.class}', '${tag.hex}', ${hasSub})">
                    <div style="display:flex; align-items:center;">
                        <div class="tag-dot" style="background:${tag.hex};"></div>
                        <span style="font-weight:600; font-size:15px; color:white;">${tag.name}</span>
                    </div>
                    ${checkIcon}
                </div>`;

                // --- CHANGED LOGIC HERE ---
                // Check if ANY sub-tag is currently selected
                const isChildSelected = tag.hasSub && window.selectedTags.some(t => COUNCIL_SUBS.includes(t.text));

                // Show sub-menu if Parent is selected OR a Child is selected
                if (tag.hasSub && (isSelected || isChildSelected)) {
                    html += `<div class="sub-tag-container">`;
                    COUNCIL_SUBS.forEach(sub => {
                        const isSubSelected = window.selectedTags.some(t => t.text === sub);
                        const subActive = isSubSelected ? 'selected' : '';
                        const subIcon = isSubSelected ? 'â—' : 'â—‹';

                        html += `
                    <div class="sub-tag-item ${subActive}" onclick="window.toggleSubTag('${sub}')">
                        <span style="margin-right:10px; font-size:12px;">${subIcon}</span> ${sub}
                    </div>`;
                    });
                    html += `</div>`;
                }

                html += `</div>`;
            });

            if (html === '') html = `<div style="text-align:center; padding:20px; color:#888;">No tags found.</div>`;
            list.innerHTML = html;
        };

        // 5. Toggle Logic (Global)
        window.toggleMainTag = function (name, className, hex, hasSub) {
            if (!window.selectedTags) window.selectedTags = [];

            const index = window.selectedTags.findIndex(t => t.text === name);

            if (index > -1) {
                // Remove tag
                window.selectedTags.splice(index, 1);
                // If parent removed, remove its children
                if (hasSub) {
                    window.selectedTags = window.selectedTags.filter(t => !COUNCIL_SUBS.includes(t.text));
                }
            } else {
                // Add tag
                if (window.selectedTags.length >= 2) return alert("Maximum 2 tags allowed.");
                window.selectedTags.push({ text: name, colorClass: className, hex: hex });
            }
            window.renderTagMenu();
        };

        window.toggleSubTag = function (subName) {
            const index = window.selectedTags.findIndex(t => t.text === subName);

            if (index > -1) {
                // If clicking an existing sub-tag, remove it
                window.selectedTags.splice(index, 1);
            } else {
                // If adding a sub-tag...
                // 1. Check limit. We allow if "Council" is currently selected (because we will swap it)
                const councilIndex = window.selectedTags.findIndex(t => t.text === "Council / Committee");
                const currentCount = window.selectedTags.length;

                // If at limit (2) and Council isn't one of them, stop.
                if (currentCount >= 2 && councilIndex === -1) {
                    return alert("Maximum 2 tags allowed.");
                }

                // 2. Remove the generic "Council" tag if it exists (Swap Parent for Child)
                if (councilIndex > -1) {
                    window.selectedTags.splice(councilIndex, 1);
                }

                // 3. Add the specific sub-tag
                window.selectedTags.push({ text: subName, colorClass: 'tag-sub-council', hex: '#24A0ED' });
            }
            window.renderTagMenu();
            window.renderTagsOnMainForm();
        };

        // 6. Main Form Pill Renderer
        window.renderTagsOnMainForm = function () {
            const container = document.getElementById('selectedTagsContainer');
            if (!container) return;

            if (!window.selectedTags || window.selectedTags.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = window.selectedTags.map((tag, i) => `
        <div style="background:${tag.hex || '#555'}; display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 12px; margin-right: 5px; font-size: 12px; font-weight: 600; color: white;">
            ${tag.text}
            <span style="margin-left: 8px; cursor: pointer; opacity: 0.7;" onclick="window.removeTag(${i})">âœ•</span>
        </div>
    `).join('');
        };

        window.removeTag = function (index) {
            window.selectedTags.splice(index, 1);
            window.renderTagsOnMainForm();
        };
        // --- TIME AGO HELPER (Instagram Style) ---
        function timeAgo(dateInput) {
            if (!dateInput) return 'Just now';

            // Handle Firestore Timestamp or standard Date object
            const date = dateInput.toDate ? dateInput.toDate() : new Date(dateInput);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);

            let interval = Math.floor(seconds / 31536000);
            if (interval >= 1) return interval + "y ago";

            interval = Math.floor(seconds / 2592000);
            if (interval >= 1) return interval + "mo ago";

            interval = Math.floor(seconds / 86400);
            if (interval >= 1) return interval + "d ago";

            interval = Math.floor(seconds / 3600);
            if (interval >= 1) return interval + "h ago";

            interval = Math.floor(seconds / 60);
            if (interval >= 1) return interval + "m ago";

            return "Just now";
        }
        function getYearBadgeHtml(yearCode) {
            if (!yearCode) return '';

            let color = '#888'; // Default Grey
            let label = yearCode;

            switch (yearCode) {
                case 'FE': color = '#30D158'; label = 'FE'; break; // Green
                case 'SE': color = '#0A84FF'; label = 'SE'; break; // Blue
                case 'TE': color = '#BF5AF2'; label = 'TE'; break; // Purple
                case 'BE': color = '#FF9F0A'; label = 'BE'; break; // Orange
            }

            return `<span style="
        background-color: ${color}20; 
        color: ${color}; 
        border: 1px solid ${color}40;
        padding: 2px 6px; 
        border-radius: 4px; 
        font-size: 10px; 
        font-weight: 800; 
        margin-left: 6px;
        vertical-align: middle;
    ">${label}</span>`;
        }
        // --- CLOSE MODALS ON OUTSIDE CLICK ---
        // --- CLOSE MODALS ON OUTSIDE CLICK ---
        window.addEventListener('mousedown', function (e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
                unlockScroll(); // <--- Ensure this line exists!
            }
        });
    </script>

</body>

</html>
